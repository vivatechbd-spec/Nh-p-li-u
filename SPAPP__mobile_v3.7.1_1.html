<!DOCTYPE html>

<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Bi√™n b·∫£n thanh l√Ω h·ª£p ƒë·ªìng - C√¥ng ty Vi M√¥</title>
<style>
:root{
  --brand-blue:#2E75B6;        /* NextPay blue */
  --brand-green:#64B243;       /* NextPay green */
  --brand-blue-dark:#245a8a;
  --brand-green-dark:#4f912f;
}

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Times New Roman', serif;
            line-height: 1.4;
            background: linear-gradient(135deg, var(--brand-blue) 0%, var(--brand-green) 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--brand-blue-dark), #1f2e3d);
            color: white;
            padding: calc(12px + 0.6 * var(--title-size) + 8px) 72px 30px 30px; /* reserve space for logo above title */
            text-align: center;
        }

        .header h1 {
  /* Base size of title, responsive via clamp */
  --title-base: clamp(28px, 3.5vw + 18px, 56px);
  /* Apply 70% scale as requested */
  --title-size: calc(0.7 * var(--title-base));
  font-size: var(--title-size);
  line-height: 1.15;
}

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .form-container {
            display: flex;
            flex-wrap: wrap;
        }

        .form-section {
            flex: 1;
            min-width: 500px;
            padding: calc(12px + 0.6 * var(--title-size) + 8px) 72px 30px 30px; /* reserve space for logo above title */
            border-right: 1px solid #eee;
        }

        .preview-section {
            flex: 1;
            min-width: 500px;
            padding: calc(12px + 0.6 * var(--title-size) + 8px) 72px 30px 30px; /* reserve space for logo above title */
            background: #f8f9fa;
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.2);
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .checkbox-group {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .checkbox-group input[type="radio"] {
            width: auto;
            margin-right: 8px;
        }

        .checkbox-group label {
            display: flex;
            align-items: flex-start;
            margin-bottom: 10px;
            font-weight: normal;
            cursor: pointer;
        }

        .device-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .device-table th, .device-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .device-table th {
            background: #f5f5f5;
            font-weight: bold;
        }

        .device-table input, .device-table select {
            width: 100%;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .add-device-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 14px;
            transition: background 0.3s ease;
        }

        .add-device-btn:hover {
            background: #219a52;
        }

        .remove-device-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .remove-device-btn:hover {
            background: #c0392b;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            padding: calc(12px + 0.6 * var(--title-size) + 8px) 72px 30px 30px; /* reserve space for logo above title */
            background: #ecf0f1;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            min-width: 200px;
        }

        .btn-primary { background: linear-gradient(135deg, var(--brand-blue), var(--brand-blue-dark)); color:#fff; }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
        }

        .btn-success { background: linear-gradient(135deg, var(--brand-green), var(--brand-green-dark)); color:#fff; }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(39, 174, 96, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(243, 156, 18, 0.3);
        }

        .document-preview {
            background: white;
            padding: calc(12px + 0.6 * var(--title-size) + 8px) 72px 30px 30px; /* reserve space for logo above title */
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            font-size: 13px;
            line-height: 1.6;
            max-height: 600px;
            overflow-y: auto;
        }

        .document-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .document-title {
            font-size: 16px;
            font-weight: bold;
            margin: 10px 0;
        }

        .party-info {
            margin: 20px 0;
        }

        .signature-section {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
        }

        .signature-box {
            text-align: center;
            width: 45%;
        }

        /* Mobile print notification */
        .mobile-print-notice {
            display: none;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: #856404;
        }

        .mobile-print-notice h4 {
            margin-bottom: 10px;
            color: #b8860b;
        }

        .mobile-print-notice ol {
            margin: 10px 0;
            padding-left: 20px;
        }

        .mobile-print-notice li {
            margin: 5px 0;
        }

        /* Print-friendly modal for mobile */
        .print-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            overflow-y: auto;
        }

        .print-modal-content {
            background: white;
            margin: 20px;
            padding: 20px;
            border-radius: 10px;
            max-width: 800px;
            margin: 20px auto;
        }

        .print-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .close-modal {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .print-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .print-content {
            font-family: 'Times New Roman', serif;
            font-size: 12px;
            line-height: 1.5;
        }

        /* CRITICAL PRINT STYLES - FIXED */
        @media print {
            * {
                margin: 0;
                padding: 0;
            }
            
            body {
                background: white !important;
                padding: 0 !important;
                font-size: 12px !important;
                margin: 0 !important;
            }
            
            /* Hide all non-printable elements */
            .header, 
            .form-section, 
            .action-buttons, 
            .mobile-print-notice, 
            .print-modal-header, 
            .print-actions,
            .tab-menu,
            .close-modal,
            .btn,
            nav,
            header,
            footer {
                display: none !important;
            }
            
            /* Show only print content */
            .container {
                box-shadow: none !important;
                border-radius: 0 !important;
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
                overflow: visible !important;
            }
            
            .preview-section, 
            .print-modal-content {
                padding: 0 !important;
                background: white !important;
                margin: 0 !important;
                max-width: none !important;
                border: none !important;
                box-shadow: none !important;
            }
            
            .document-preview, 
            .print-content {
                box-shadow: none !important;
                max-height: none !important;
                overflow: visible !important;
                padding: 10mm !important;
                margin: 0 !important;
                background: white !important;
                border: none !important;
                font-size: 12px !important;
                line-height: 1.4 !important;
            }
            
            .print-modal {
                position: static !important;
                background: white !important;
                overflow: visible !important;
                display: block !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            /* Ensure tables don't break across pages */
            table {
                page-break-inside: avoid;
                border-collapse: collapse !important;
            }
            
            table th, table td {
                border: 1px solid #000 !important;
                padding: 4px !important;
                font-size: 11px !important;
            }
            
            /* Prevent page breaks in important sections */
            h1, h2, h3, .document-title {
                page-break-after: avoid;
            }
            
            .party-info, .signature-section {
                page-break-inside: avoid;
            }
            
            /* Set page margins */
            @page {
                size: A4;
                margin: 15mm;
            }
            
            /* Force single page for transfer document */
            .transfer-document {
                font-size: 11px !important;
                line-height: 1.3 !important;
            }
            
            .transfer-document .party-info {
                margin: 4px 0 !important;
            }
            
            .transfer-document table {
                margin: 8px 0 !important;
                font-size: 10px !important;
            }
            
            .transfer-document .signature-section {
                margin-top: 15px !important;
            }
        }

        @media (max-width: 1024px) {
            .form-container {
                flex-direction: column;
            }
            .form-section, .preview-section {
                min-width: auto;
                border-right: none;
            }
            .form-section {
                border-bottom: 1px solid #eee;
            }
            .action-buttons {
                flex-wrap: wrap;
            }
            .btn {
                min-width: 150px;
                margin: 5px;
            }
            .mobile-print-notice {
                display: block;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .header {
                padding: 20px;
            }
            .header h1 {
                font-size: 20px;
            }
            .form-section, .preview-section {
                padding: 20px;
            }
            .form-row {
                flex-direction: column;
                gap: 10px;
            }
            .btn {
                padding: 12px 20px;
                font-size: 14px;
                min-width: 120px;
            }
            .document-preview {
                padding: 15px;
                font-size: 11px;
                max-height: 400px;
            }
            .device-table {
                font-size: 11px;
            }
            .device-table th, .device-table td {
                padding: 5px;
            }
            .print-modal-content {
                margin: 10px;
                padding: 15px;
            }
        }

        @media (max-width: 480px) {
            .action-buttons {
                padding: 20px 10px;
            }
            .btn {
                width: 100%;
                margin: 5px 0;
                min-width: auto;
            }
            .device-table {
                font-size: 10px;
            }
            .device-table input, .device-table select {
                padding: 3px;
                font-size: 10px;
            }
        }

        /* Date input styling */
        .date-input-group {
            position: relative;
        }

        .date-input-group input[type="text"] {
            background: white;
        }

        .date-help {
            font-size: 11px;
            color: #666;
            margin-top: 3px;
            font-style: italic;
        }

        /* Tab menu styling */
        .tab-menu {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .tablink {
            background-color: #ddd;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 20px;
            font-size: 16px;
            border-radius: 6px;
            transition: 0.3s;
        }

        .tablink:hover {
            background-color: #bbb;
        }

        .tablink.active { background-color: var(--brand-green); color:#fff; }


/* === Progress Tabs (3-step) === */
.tab-menu { position: relative; gap: 0; }
.tab-menu.progress { counter-reset: step; display:flex; align-items:center; }
.tab-menu.progress .tablink{
  flex:1; background:transparent; border:none; padding:12px 8px; font-weight:700;
  color:#374151; position:relative; display:flex; align-items:center; justify-content:center;
}
.tab-menu.progress .tablink::before{
  content: counter(step); counter-increment: step;
  width:28px; height:28px; border-radius:999px; display:inline-flex; align-items:center; justify-content:center;
  background:#fff; border:2px solid #d1d5db; margin-right:8px; z-index:1;
}
.tab-menu.progress .tablink.active{ color:#065f46; }
.tab-menu.progress .tablink.active::before{ background:var(--brand-green); border-color:var(--brand-green); color:#fff; }

/* Connector line under the steps */
.progress-line{ position:relative; height:4px; background:#e5e7eb; border-radius:999px; margin:8px 16px 0; overflow:hidden; }
.progress-line .progress-fill{ height:100%; width:0%; background:linear-gradient(90deg, var(--brand-green), var(--brand-blue)); border-radius:999px; transition:width .25s ease; }


        /* Loading spinner styles */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

@media print {
    /* ·∫®n to√†n b·ªô ph·∫ßn xem tr∆∞·ªõc t√†i li·ªáu khi in */
    .preview-section,
    #documentPreview,
    #transferDocumentPreview,
    #authorizationDocumentPreview {
        display: none !important;
    }
}

@media print {
    .transfer-document.onepage {
        font-size: 10.5px !important;
        line-height: 1.3 !important;
        margin: 0 !important;
        padding: 0 !important;
    }
    .transfer-document.onepage table th,
    .transfer-document.onepage table td {
        padding: 3px !important;
        font-size: 9.5px !important;
    }
    .transfer-document.onepage [style*="margin: 30px"],
    .transfer-document.onepage [style*="margin: 20px"],
    .transfer-document.onepage [style*="margin: 15px"],
    .transfer-document.onepage [style*="margin-top: 50px"],
    .transfer-document.onepage [style*="margin-top: 40px"],
    .transfer-document.onepage [style*="margin-top: 20px"] {
        margin: 8px 0 !important;
    }
    .transfer-document.onepage div[style*="height: 80px"] {
        height: 50px !important;
    }
    @page {
        size: A4;
        margin: 12mm;
    }
}

@media print {
  .transfer-document.onepage * { 
    page-break-inside: avoid !important;
    orphans: 3; widows: 3;
  }
  .transfer-document.onepage h1,
  .transfer-document.onepage h2,
  .transfer-document.onepage h3 { margin: 6px 0 !important; }
  .transfer-document.onepage .signature-block { margin-top: 8px !important; }
  .transfer-document.onepage table { border-collapse: collapse !important; width: 100% !important; }
  .transfer-document.onepage table th, 
  .transfer-document.onepage table td { padding: 3px 4px !important; }
}

@media print {
  @page { size: A4; margin: 12mm; }
  .transfer-document { font-size: 12px !important; line-height: 1.35 !important; }
  .transfer-document table th, .transfer-document table td { padding: 4px 5px !important; }
}

/* === Layout Optimization: Split input & preview into two fixed columns with independent scroll === */
@media (min-width: 1024px) {
  .form-container {
    display: grid !important;
    grid-template-columns: 1fr 1fr !important;
    gap: 20px !important;
  }
  .form-section, .preview-section {
    min-width: 0 !important;           /* override earlier min-width */
    max-height: calc(100vh - 200px) !important; /* fit viewport minus header */
    overflow: auto !important;          /* independent scroll */
    border-right: none !important;
  }
  .preview-section {
    position: sticky !important;
    top: 20px !important;
    align-self: start !important;
    background: #f8f9fa;
  }
  .document-preview {
    max-height: none !important;
    overflow: visible !important;
  }
}

/* Mobile switch for input/preview */
.mobile-switch { display:flex; gap:8px; margin:10px 20px; }
.mobile-switch .switch-btn {
  border:none; border-radius:12px; padding:10px 14px; font-weight:600;
  background:#eee; box-shadow:0 1px 3px rgba(0,0,0,.1);
}
.mobile-switch .switch-btn.active { background:#4CAF50; color:#fff; }

@media (max-width: 1023px) {
  .mobile-switch { display:flex; }
  .form-container { display:block !important; }
  .tool-content .form-section, .tool-content .preview-section { display:none; }
  .tool-content[data-view="form"] .form-section { display:block; }
  .tool-content[data-view="preview"] .preview-section { display:block; }
}

/* Independent scroll for form-section */
@media (min-width: 1024px) {
  .form-section {
    max-height: calc(100vh - 200px) !important;
    overflow-y: auto !important;
    padding-right: 8px !important;
  }
}

/* Independent scrolling for input pane */
@media (min-width: 1024px) {
  .form-section { max-height: calc(100vh - 200px) !important; overflow: auto !important; }
}
@media (max-width: 1023px) {
  /* When showing only one pane, still keep the pane height bound to viewport for independent scroll */
  .tool-content[data-view="form"] .form-section,
  .tool-content[data-view="preview"] .preview-section {
    max-height: calc(100vh - 220px) !important;
    overflow: auto !important;
  }
  /* Keep header within view */
  .preview-section .section-title, .form-section .section-title { position: sticky; top: 0; background: #fff; z-index: 2; padding-top: 10px; }
}
/* Quick print button styling */
.quick-actions { display:flex; gap:10px; justify-content:flex-end; margin: 8px 0 12px 0; }
.quick-print-btn {
  border:none; padding:8px 12px; border-radius:8px; font-weight:600; cursor:pointer;
  background: linear-gradient(135deg, #27ae60, #229954); color:#fff; box-shadow: 0 2px 6px rgba(0,0,0,.12);
}
.quick-print-btn:hover { filter: brightness(1.05); }

/* Ensure print-action container remains visible in preview; layout horizontally */
.preview-section .print-actions {
  display: flex !important;
  gap: 10px;
  justify-content: center;
}
/* Hide duplicate print buttons under preview; only show the full-screen preview button */

    /* Hide duplicate print buttons in preview sections. Each tool already exposes a
       single "In Ngay" print trigger in the header, so the extra print
       buttons inside the preview (the quick-print button and the "In t√†i li·ªáu"
       button) are redundant. We leave the full-screen preview button intact. */
    .preview-section .quick-actions,
    .preview-section .quick-actions .quick-print-btn {
      display: none !important;
    }
    .preview-section .print-actions .btn-success {
      display: none !important;
    }

    /* Hide right‚Äëaligned print buttons inside preview sections. Each preview
       section begins with a right aligned div containing a redundant "In Ngay"
       button; this rule removes that container. */
    .preview-section > div[style*="text-align:right"] {
      display: none !important;
    }

/* Brand logo in header (top-right) */
.header{ position:relative; }

@media (max-width:768px){
  
}
/* Ensure mobile-switch row never prints */
@media print{ .mobile-switch{ display:none !important; } }

/* Title sizing variable to scale logo */
.header h1 { 
  --title-size: clamp(28px, 3.5vw + 18px, 56px);
  font-size: var(--title-size);
  line-height: 1.15;
}

@media (max-width:768px){
  
}
@media (max-width:420px){
  
}


/* === Mobile switch bar === */
.mobile-switch{
  position: fixed;
  left: 0; right: 0; bottom: 0;
  display: flex; gap: 8px;
  padding: 10px;
  background: rgba(255,255,255,0.92);
  -webkit-
  
  border-top: 1px solid #e5e7eb;
  z-index: 9999;
}
.mobile-switch .btn{ flex:1; }
@media (min-width: 768px){
  .mobile-switch{ display:none; }
}
/* Avoid content being hidden behind the bar on mobile */
@media (max-width: 767.98px){
  body{ padding-bottom: 78px; }
}


/* Header actions (right aligned) */
.header-actions .btn{ padding:6px 10px; }
@media (max-width: 480px){
  .header-actions{ justify-content: flex-start; flex-wrap: wrap; }
}

/* Settings trigger & FAB */
.settings-trigger{ margin-left:8px; }
.floating-settings{
  position: fixed; right: 16px; bottom: 86px;
  width: 44px; height: 44px; border-radius: 50%;
  background: #f3f4f6; border: 1px solid #e5e7eb;
  display:flex; align-items:center; justify-content:center;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  z-index: 9999;
}
@media (min-width:768px){ .floating-settings{ display:none; } }

/* Settings modal */
#settingsModal{
  display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:10000;
}
#settingsModal .modal-card{
  position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
  width:min(520px, 92vw); background:#fff; border-radius:12px; overflow:hidden;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}
#settingsModal .modal-head{
  padding:12px 16px; display:flex; align-items:center; justify-content:space-between;
  background:#f8fafc; border-bottom:1px solid #e5e7eb;
}
#settingsModal .modal-body{ padding:16px; }
#settingsModal .modal-actions{ padding:12px 16px; display:flex; gap:8px; justify-content:flex-end; border-top:1px solid #e5e7eb; }
#settingsModal .danger{ background:#fee2e2; border-color:#fecaca; color:#991b1b; }
#settingsModal .muted{ background:#f3f4f6; }

/* Quick-actions layout improvement */
.preview-section .quick-actions{
  display:flex; gap:8px; justify-content:flex-end; margin-bottom:10px;
}
.preview-section .quick-actions .btn{ padding:8px 12px; }

/* Settings gear (top-left) */
.settings-top-left{
  position: fixed; top: 10px; left: 10px; z-index: 10001;
  width: 36px; height: 36px; line-height: 36px;
  text-align: center; border-radius: 999px;
  background: rgba(255,255,255,0.85); border: 1px solid rgba(0,0,0,0.05);
  font-size: 18px; padding: 0;
}
@media (min-width: 768px){
  .settings-top-left{ top: 14px; left: 14px; }
}

/* Preview title with action button on right */
.section-title.with-action{
  display: flex; align-items: center; justify-content: space-between;
  gap: 10px;
  padding-right: 6px;
}
.section-title.with-action .title-text{ flex: 1; }
.section-title.with-action .share-in-title.btn{
  padding: 6px 10px;
  font-weight: 600;
}

/* Quick-actions under preview: keep only Download PDF if needed */
.preview-section .quick-actions{
  display:flex; gap:8px; justify-content:flex-end; margin-bottom:10px;
}

/* Normalize action buttons sizing */
.btn{ min-height: 36px; }
.section-title.with-action .share-in-title.btn{ padding:8px 12px; }


/* === Preview title & actions (compact) === */
.section-title.with-action{display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:nowrap}
.section-title.with-action .title-text{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:12px;line-height:1.2}
.section-title.with-action .action-buttons-in-title{display:inline-flex;gap:6px;align-items:center}

/* Share small (~30% of old big btn) */
.section-title.with-action .share-in-title{
  background:#fff;border:1px solid #d1d5db;border-radius:8px;
  padding:2px 6px;font-size:10px;font-weight:600;
  min-width:auto!important;min-height:30px;line-height:1.2;
}

/* Settings icon (charcoal-brown, no bg) */
.section-title.with-action .settings-icon-in-title{
  background:transparent;border:none;color:#4a3f35;
  min-width:30px;min-height:30px;padding:0;line-height:1;
  font-size:18px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center
}

/* === Device table usability upgrades === */
.device-table input,
.device-table select {
  font-size: 14px !important;
  padding: 8px 10px !important;
  min-height: 40px !important;
}
@media (max-width: 480px){
  .device-table input,
  .device-table select {
    font-size: 14px !important;
    padding: 8px 10px !important;
  }
}
/* Table tools */
.table-tools{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; margin-bottom:6px; }
.table-tools .btn{ min-width:auto; padding:8px 12px; font-size:12px; }
/* Mobile row-card visualization to avoid horizontal scroll */
@media (max-width: 600px){
  .device-table thead{ display:none; }
  .device-table, .device-table tbody, .device-table tr, .device-table td{ display:block; width:100%; }
  .device-table tr{ background:#fff; border:1px solid #eee; border-radius:10px; padding:8px; margin-bottom:8px; box-shadow:0 1px 4px rgba(0,0,0,.04); }
  .device-table td{ border:none; padding:6px 0; }
  .device-table td::before{
    content: attr(data-label);
    display:block; font-size:12px; color:#6b7280; margin-bottom:4px;
  }
}
/* Buttons inside table cells */
.remove-device-btn{ min-height:36px; }

</style>
    <!-- Load html2pdf library from CDN for generating PDF documents on-the-fly. Without this library
         the `generateAndSharePDF()` function falls back to printing or sharing the HTML file. By
         importing html2pdf.js here we ensure the PDF generation feature works consistently on
         mobile and desktop browsers. -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>
/* === Progress updater for 3 tabs === */
function updateProgress(){
  try{
    var order = ['tool1','tool2','tool3'];
    var idx = order.indexOf(currentTool);
    if(idx < 0) idx = 0;
    // Map step 0..2 to 0%, 50%, 100%
    var percent = (idx/(order.length-1))*100;
    var el = document.getElementById('progressFill');
    if(el){ el.style.width = percent + '%'; }
  }catch(e){ /* no-op */ }
}
// Patch showTool to also update active state & progress
(function(){
  var _origShowTool = typeof showTool === 'function' ? showTool : null;
  window.showTool = function(id, btn){
    // Hide all tools
    document.querySelectorAll('.tool-content').forEach(function(el){ el.style.display = 'none'; });
    var el = document.getElementById(id);
    if(el){ el.style.display = 'block'; }
    currentTool = id;
    // Active state on tabs
    document.querySelectorAll('.tablink').forEach(function(b){ b.classList.remove('active'); });
    if(btn){ btn.classList.add('active'); }
    if(typeof _origShowTool === 'function'){ try{ _origShowTool(id, btn); }catch(e){} }
    updateProgress();
  };
  // On load
  document.addEventListener('DOMContentLoaded', function(){ updateProgress(); });
})();
</script>

<!-- MOBILE OPTIMIZATION PATCH v2025-08-11 -->
<style id="mobile-optimizations">
  /* 1) Tap target & spacing on touch devices */
  @media (pointer: coarse) {
    button, .btn, [role="button"], .button,
    input[type="checkbox"], input[type="radio"],
    .switch, .toggle, .chip, .tab {
      min-width: 44px;
      min-height: 44px;
    }
    button, .btn, .button, .tab {
      padding: 12px 16px;
    }
  }

  /* 3) Fix 100vh & iOS safe-area */
  :root {
    --safe-top: env(safe-area-inset-top);
    --safe-bottom: env(safe-area-inset-bottom);
  }
  body { padding-bottom: max(var(--safe-bottom), 12px); }
  .app-viewport, .app-container, main, .page, .sheet, .modal, .viewport, .vh-100 {
    min-height: 100dvh;               /* modern browsers */
    min-height: -webkit-fill-available; /* iOS Safari fallback */
  }
  .modal, .sheet {
    padding-bottom: max(16px, var(--safe-bottom));
  }

  /* 5) Horizontal scroll table + sticky header (mobile-first) */
  .table-scroll {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scroll-behavior: smooth;
  }
  .table-scroll table {
    width: 100%;
    border-collapse: collapse;
  }
  .table-scroll thead th {
    position: sticky;
    top: 0;
    z-index: 2;
    background: var(--surface, #fff);
    box-shadow: 0 1px 0 rgba(0,0,0,0.08);
  }
  .table-scroll::-webkit-scrollbar {
    height: 10px;
  }
  .table-scroll::-webkit-scrollbar-thumb {
    border-radius: 999px;
  }
</style>
<style>

/* === Patch for Tool 2 scroll entire form === */
#tool2 .form-section {
  max-height: calc(100vh - 180px) !important;
  overflow-y: auto !important;
  padding-right: 8px;
}

</style>

<style>
/* Fix: disable sticky behavior for section titles in Tool 2 input pane */
#tool2 .form-section .section-title {
  position: static !important;
  top: auto !important;
  background: transparent !important;
  z-index: auto !important;
  padding-top: 0 !important;
  margin-top: 16px;
}
/* Add a subtle divider so sections remain clear even without sticky */
#tool2 .form-section .section-title {
  border-bottom: 2px solid #3498db;
  padding-bottom: 8px;
}
</style>


<style id="preview-missing-highlight">
/* Highlight for missing fields shown only on preview (screen) */
.hl-missing {
  background: #fff3cd; /* soft yellow */
  outline: 2px dashed #f1c40f;
  outline-offset: 2px;
}
/* Don't show highlight in print/PDF */
@media print {
  .hl-missing { 
    background: transparent !important; 
    outline: none !important; 
  }
}
</style>


<style id="form-missing-highlight">
/* Highlight empty inputs in the form */
.hl-field-missing {
  background: #fff9e6 !important;          /* soft yellow */
  outline: 2px dashed #f1c40f !important;
  outline-offset: 2px !important;
  transition: background .2s ease, outline .2s ease;
}
/* Don't highlight in print */
@media print {
  .hl-field-missing { 
    background: transparent !important;
    outline: none !important;
  }
}
</style>


<style id="header-progress-contrast-tweaks">
/* === Header: reduce title size to ~70% and improve readability === */
.header{
  padding-top: 18px; /* slightly tighter */
  padding-bottom: 18px;
}
.header h1{
  /* ~70% of the previous big clamp */
  font-size: clamp(20px, 2.5vw + 13px, 40px) !important;
  line-height: 1.15 !important;
  letter-spacing: 0.3px;
}
.header p{
  font-size: 13px !important;
  opacity: .9;
}

/* === Progress tabs: stronger contrast on dark header === */
.tab-menu.progress{ margin-top: 10px; }
.tab-menu.progress .tablink{
  color: rgba(255,255,255,0.88) !important;
  text-shadow: 0 1px 2px rgba(0,0,0,.35);
  font-weight: 700;
}
.tab-menu.progress .tablink::before{
  background: rgba(255,255,255,0.15) !important;
  border-color: rgba(255,255,255,0.9) !important;
  color: #fff !important;
  box-shadow: 0 2px 6px rgba(0,0,0,.25);
}
.tab-menu.progress .tablink.active{
  color: var(--brand-green) !important;
}
.tab-menu.progress .tablink.active::before{
  background: var(--brand-green) !important;
  border-color: var(--brand-green-dark) !important;
  color: #fff !important;
  box-shadow: 0 4px 10px rgba(0,0,0,.25);
}

/* Progress line brighter to read on dark bg */
.progress-line{ background: rgba(255,255,255,0.25) !important; }
.progress-line .progress-fill{ background: linear-gradient(90deg, var(--brand-green), var(--brand-blue)) !important; }
</style>


<style id="content-70-30-and-typography">
/* === 70/30 layout on desktop === */
@media (min-width: 1024px){
  .form-container{
    display: grid !important;
    grid-template-columns: 7fr 3fr !important; /* ~70% / 30% */
    gap: 20px !important;
  }
  .form-section, .preview-section{
    min-width: 0 !important;
    max-height: calc(100vh - 200px) !important;
    overflow: auto !important;
  }
  .preview-section{ position: sticky !important; top: 20px !important; }
}

/* === Visual hierarchy === */
.section-title{
  font-size: 18px !important;
  line-height: 1.3;
  font-weight: 800 !important;
}
.form-group label{
  font-size: 14px !important;
  font-weight: 600 !important;
  color: #374151 !important;
}
.form-group input, .form-group textarea, .form-group select{
  font-size: 14px !important;
  padding: 12px !important;
}
.date-help, .helper-text{
  font-size: 12px !important;
  color: #6b7280 !important;
}

/* === Validation state styles === */
.is-valid{ border-color: #34d399 !important; box-shadow: 0 0 0 3px rgba(52,211,153,.15) !important; }
.is-error{ border-color: #ef4444 !important; box-shadow: 0 0 0 3px rgba(239,68,68,.15) !important; }
.field-icon{
  margin-left: 8px; font-size: 12px; vertical-align: middle;
}
.validation-msg{
  margin-top: 4px; font-size: 12px; color: #ef4444;
}

/* === Collapsible sections === */
.collapsible-summary{
  display:flex; align-items:center; justify-content:space-between; gap:10px; cursor:pointer;
}
.collapsible-summary .chev{ transition: transform .2s ease; }
.collapsed .collapsible-summary .chev{ transform: rotate(-90deg); }
.collapsible-body{ display:block; }
.collapsed .collapsible-body{ display:none; }

/* Ensure printing shows all content regardless of collapse */
@media print{
  .collapsed .collapsible-body{ display:block !important; }
}
</style>


<style id="bottom-actions-css">
/* ===== Footer (desktop) ===== */
.footer-actions{
  display:none;
  border-top: 1px solid #e5e7eb;
  background:#fafafa;
  padding: 12px 16px;
}
.footer-actions .fa-row{
  display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
}
.footer-actions .fa-primary{ min-height:44px; }
.footer-actions .fa-secondary{ min-height:44px; }
.footer-actions .fa-ghost{
  background:transparent; border:1px dashed #d1d5db; color:#374151;
}

/* ===== Sticky Bottom (mobile) ===== */
.bottom-actions{
  position: fixed; left: 0; right: 0; bottom: 0;
  display: grid; grid-template-columns: 1fr 1fr auto auto; gap: 8px;
  padding: 10px max(10px, env(safe-area-inset-right)) calc(10px + env(safe-area-inset-bottom)) max(10px, env(safe-area-inset-left));
  background: rgba(255,255,255,0.96);
  -webkit- 
  border-top: 1px solid #e5e7eb;
  z-index: 10000;
}
.bottom-actions .btn{ min-height: 44px; }
.bottom-actions .ba-primary .spinner.mini{ display:none; width:16px; height:16px; border-width: 2px; }
.bottom-actions .ba-ghost{ background:transparent; border:1px dashed #d1d5db; color:#374151; }

/* More menu */
.ba-more, .fa-more{ position:relative; }
.more-menu{
  position:absolute; right:0; bottom: calc(100% + 6px);
  min-width: 160px; background:#fff; border:1px solid #e5e7eb; border-radius:8px;
  box-shadow: 0 8px 20px rgba(0,0,0,.12); padding:6px;
  display:none;
}
.more-menu[aria-hidden="false"]{ display:block; }
.more-menu button{
  display:block; width:100%; text-align:left; padding:8px 10px; border:none; background:transparent; border-radius:6px; cursor:pointer;
}
.more-menu button:hover{ background:#f3f4f6; }

/* Visibility rules */
@media (min-width: 1024px){
  .footer-actions{ display:block; }
  .bottom-actions{ display:none; }
}
@media (max-width: 1023px){
  .footer-actions{ display:none; }
  .bottom-actions{ display:grid; }
  /* Ensure content not hidden behind bar */
  body{ padding-bottom: calc(84px + env(safe-area-inset-bottom)) !important; }
}

/* Loading state */
.btn.loading, .btn:disabled{
  opacity:.8; pointer-events:none;
}
.btn.loading .spinner.mini{ display:inline-block; }
</style>


<style id="ux-icons-animations">
/* === Validation icons using CSS background (no extra markup) === */
/* Data-URI SVGs for check and cross */
:root{
  --icon-check: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%2334d399' viewBox='0 0 16 16'><path d='M13.485 1.929a1 1 0 010 1.414l-7.071 7.071-3.536-3.536a1 1 0 011.414-1.414l2.122 2.121 5.657-5.657a1 1 0 011.414 0z'/></svg>");
  --icon-cross: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23ef4444' viewBox='0 0 16 16'><path d='M4.222 3.515a1 1 0 011.415 0L8 5.879l2.364-2.364a1 1 0 111.415 1.414L9.414 7.293l2.365 2.364a1 1 0 01-1.415 1.415L8 8.707l-2.364 2.365a1 1 0 01-1.415-1.415L6.586 7.293 4.222 4.93a1 1 0 010-1.415z'/></svg>");
}

/* Add right padding to make room for icon */
.form-group input, .form-group textarea, .form-group select{
  background-repeat: no-repeat;
  background-position: right 10px center;
  background-size: 16px 16px;
  padding-right: 36px !important;
  transition: box-shadow .2s ease, border-color .2s ease, background-color .2s ease;
}

.is-valid{ background-image: var(--icon-check); }
.is-error{ background-image: var(--icon-cross); }

/* Helper text reserved space */
.form-group .helper-text{
  min-height: 18px; /* reserve space to prevent layout shift */
  display: block;
  margin-top: 4px;
  font-size: 12px;
  color: #6b7280;
}

/* Collapsible smooth animation */
.collapsible-body{
  overflow: hidden;
  transition: height .2s ease;
}
.collapsed .collapsible-body{ height: 0 !important; }
</style>


<style id="ux-icon-specificity-boost">
.form-group input.is-valid,
.form-group select.is-valid,
.form-group textarea.is-valid{
  background-image: var(--icon-check) !important;
  background-repeat: no-repeat !important;
  background-position: right 10px center !important;
  background-size: 16px 16px !important;
  padding-right: 36px !important;
}
.form-group input.is-error,
.form-group select.is-error,
.form-group textarea.is-error{
  background-image: var(--icon-cross) !important;
  background-repeat: no-repeat !important;
  background-position: right 10px center !important;
  background-size: 16px 16px !important;
  padding-right: 36px !important;
}
</style>


<style id="ux-vicon-abs">
.form-group{ position: relative; }
.form-group .vicon{
  position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
  width: 18px; height: 18px; pointer-events: none; opacity: 0; transition: opacity .15s ease;
}
.form-group .vicon.ok{ 
  opacity: 1; 
  background-image: var(--icon-check); background-size: 18px 18px; background-repeat: no-repeat; 
}
.form-group .vicon.err{ 
  opacity: 1; 
  background-image: var(--icon-cross); background-size: 18px 18px; background-repeat: no-repeat; 
}
/* Extra right padding so text doesn't overlap with icon */
.form-group input, .form-group textarea, .form-group select{ padding-right: 42px !important; }
</style>


<style id="ux-vicon-inline-svg">
.form-group{ position: relative; }
.form-group .vicon{
  position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
  width: 18px; height: 18px; pointer-events: none; opacity: 0; transition: opacity .12s ease;
  display: inline-flex; align-items: center; justify-content: center;
}
.form-group .vicon svg{ width: 18px; height: 18px; display:block; }
.form-group .vicon.show{ opacity: 1; }
.form-group input, .form-group textarea, .form-group select{ padding-right: 42px !important; }
</style>


<style id="vicon-visibility-patch">
.form-group .vicon{ z-index: 5; }
</style>





<style id="vicon-text-fallback">
.form-group .vicon{ 
  z-index: 9; font-weight: 800; color:#111; 
}
.form-group .vicon .vtxt{ 
  font-size: 18px; line-height: 1; display:block; 
  text-shadow: 0 1px 2px rgba(0,0,0,.2);
}
.form-group .vicon .vtxt.ok{ color:#10b981; }   /* emerald-500 */
.form-group .vicon .vtxt.err{ color:#ef4444; }  /* red-500 */
</style>





<style id="header-pointer-events-patch">
.header, .tab-menu.progress, .progress-line{ pointer-events: auto; }
.tab-menu.progress .tablink{ pointer-events: auto; }
</style>

</head>
<body>

<!-- Mobile Print Modal -->
<div class="print-modal" id="printModal">
<div class="print-modal-content">
<div class="print-modal-header">
<h3>üìÑ T√†i li·ªáu s·∫µn s√†ng in</h3>
<button class="close-modal" onclick="closePrintModal()">‚úï ƒê√≥ng</button>
</div>
<div class="mobile-print-notice">
<h4>üì± H∆∞·ªõng d·∫´n in tr√™n thi·∫øt b·ªã di ƒë·ªông:</h4>
<ol>
<li><strong>Chrome/Edge:</strong> Nh·∫•n v√†o bi·ªÉu t∆∞·ª£ng 3 ch·∫•m ·ªü g√≥c tr√™n b√™n ph·∫£i, ch·ªçn "Chia s·∫ª...", sau ƒë√≥ ch·ªçn "In"</li>
<li><strong>Safari:</strong> Nh·∫•n v√†o bi·ªÉu t∆∞·ª£ng chia s·∫ª ·ªü cu·ªëi m√†n h√¨nh, cu·ªôn xu·ªëng v√† ch·ªçn "In"</li>
<li><strong>L∆∞u PDF:</strong> Trong menu in, ch·ªçn "L∆∞u th√†nh PDF" thay v√¨ ch·ªçn m√°y in</li>
</ol>
</div>
<div class="print-actions">
<button class="btn btn-primary" onclick="shareFromModal()">üì§ Chia s·∫ª</button>
<button class="btn btn-success" onclick="printFromModal()">üñ®Ô∏è In t√†i li·ªáu</button>
</div>
<div class="print-content" id="printContent">
<!-- Document content will be inserted here -->
</div>
</div>
</div>
<div class="container">
<div class="header"><h1>C√îNG C·ª§ NH·∫¨P LI·ªÜU BI√äN B·∫¢N THANH L√ù H·ª¢P ƒê·ªíNG</h1>
<p>C√¥ng ty C·ªï ph·∫ßn C√¥ng ngh·ªá Vi M√¥</p>
<div class="tab-menu progress">
<button class="tablink active" onclick="showTool('tool1', this)">Thanh l√Ω</button>
<button class="tablink" onclick="showTool('tool2', this)">Chuy·ªÉn nh∆∞·ª£ng</button>
<button class="tablink" onclick="showTool('tool3', this)">·ª¶y quy·ªÅn</button>
</div>
<div class="progress-line"><div class="progress-fill" id="progressFill"></div></div>
</div>
    <!-- New completion progress container: shows completion percentage and animated progress bar. This element becomes sticky when scrolled. -->
    <div id="completionContainer" class="completion-container">
      <span class="completion-text">Ho√†n t·∫•t <span id="completionPercentText">0%</span></span>
      <div class="progress-bar"><div class="progress-fill" id="completionProgressFill"></div></div>
    </div>
<div class="form-container">
<!-- Tool 1: Bi√™n b·∫£n thanh l√Ω -->
<div class="tool-content" id="tool1" style="display: block;">
<div class="mobile-switch" data-tool="tool1">
<button class="switch-btn active" onclick="setToolView('tool1','form')" type="button">üìù Nh·∫≠p Li·ªáu</button>
<button class="switch-btn" onclick="setToolView('tool1','preview')" type="button">üëÅÔ∏è Xem Tr∆∞·ªõc</button>
<button class="switch-btn" onclick="printDocument('tool1')" type="button">‚¨áÔ∏è T·∫£i PDF</button>
</div>
<div class="form-section">
<div class="section-title">üìù TH√îNG TIN H·ª¢P ƒê·ªíNG</div>
<div class="form-group">
<label>S·ªë h·ª£p ƒë·ªìng d·ªãch v·ª• thanh to√°n:</label>
<input id="contractNumber" placeholder="Nh·∫≠p s·ªë h·ª£p ƒë·ªìng" type="text"/>
</div>
<div class="form-row">
<div class="form-group">
<label>Ng√†y k√Ω:</label>
<div class="date-input-group">
<input id="contractDate" placeholder="dd/mm/yyyy" type="text" data-no-unify-date="true"/>
<div class="date-help">V√≠ d·ª•: 15/08/2024</div>
</div>
</div>
<div class="form-group">
<label>Ng√†y thanh l√Ω:</label>
<input id="terminationDate" type="date"/>
</div>
</div>
<div class="section-title">üè¢ TH√îNG TIN B√äN B</div>
<div class="form-group">
<label>T√™n c√¥ng ty/t·ªï ch·ª©c:</label>
<input id="partyBName" placeholder="Nh·∫≠p t√™n c√¥ng ty" type="text"/>
</div>
<div class="form-group">
<label>ƒê·ªãa ch·ªâ tr·ª• s·ªü:</label>
<textarea id="partyBAddress" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ" rows="2"></textarea>
</div>
<div class="form-row">
<div class="form-group">
<label>Website:</label>
<input id="partyBWebsite" placeholder="www.example.com" type="text"/>
</div>
<div class="form-group">
<label>ƒêi·ªán tho·∫°i:</label>
<input id="partyBPhone" placeholder="024-xxxxxxxx" type="text"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label>Fax:</label>
<input id="partyBFax" placeholder="024-xxxxxxxx" type="text"/>
</div>
<div class="form-group">
<label>M√£ s·ªë thu·∫ø:</label>
<input id="partyBTaxCode" placeholder="0123456789" type="text"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label>S·ªë t√†i kho·∫£n:</label>
<input id="partyBAccount" placeholder="S·ªë t√†i kho·∫£n ng√¢n h√†ng" type="text"/>
</div>
<div class="form-group">
<label>Ng√¢n h√†ng:</label>
<input id="partyBBank" placeholder="T√™n ng√¢n h√†ng" type="text"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label>Ng∆∞·ªùi ƒë·∫°i di·ªán:</label>
<input id="partyBRepresentative" placeholder="H·ªç v√† t√™n" type="text"/>
</div>
<div class="form-group">
<label>Ch·ª©c v·ª•:</label>
<input id="partyBPosition" placeholder="Ch·ª©c v·ª•" type="text"/>
</div>
</div>
<div class="section-title">‚öôÔ∏è X·ª¨ L√ù THI·∫æT B·ªä</div>
<div class="checkbox-group">
<label>
<input checked="" name="deviceHandling" type="radio" value="keep"/>
<span>B√™n A kh√≥a t√†i kho·∫£n, thi·∫øt b·ªã thu·ªôc quy·ªÅn s·ªü h·ªØu B√™n B</span>
</label>
<label>
<input name="deviceHandling" type="radio" value="return"/>
<span>B√™n A kh√≥a t√†i kho·∫£n v√† B√™n B b√†n giao l·∫°i thi·∫øt b·ªã</span>
</label>
<label>
<input name="deviceHandling" type="radio" value="other"/>
<span>Kh√°c (ghi chi ti·∫øt):</span>
</label>
<textarea disabled="" id="otherHandling" placeholder="M√¥ t·∫£ chi ti·∫øt ph∆∞∆°ng √°n kh√°c..." rows="2" style="margin-top: 10px;"></textarea>
</div>
<div class="section-title">üì± DANH S√ÅCH THI·∫æT B·ªä</div>
<table class="device-table" id="deviceTable">
<thead>
<tr>
<th>STT</th>
<th>Lo·∫°i thi·∫øt b·ªã</th>
<th>ƒê∆°n v·ªã</th>
<th>S·ªë l∆∞·ª£ng</th>
<th>Serial thi·∫øt b·ªã</th>
<th>T√¨nh tr·∫°ng</th>
<th>Thao t√°c</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td><input oninput="updatePreview()" placeholder="Lo·∫°i thi·∫øt b·ªã" list="deviceTypeOptions" required="" type="text"/></td>
<td><input oninput="updatePreview()" placeholder="C√°i" required="" type="text" value="C√°i" list="unitOptions"/></td>
<td><input oninput="updatePreview()" required="" type="text" value="1"/></td>
<td><input oninput="updatePreview()" placeholder="Serial number" required="" type="text"/></td>
<td>
<select onchange="updatePreview()" required="">
<option selected="" value="T·ªët">T·ªët</option>
<option value="B√¨nh th∆∞·ªùng">B√¨nh th∆∞·ªùng</option>
<option value="H·ªèng">H·ªèng</option>
</select>
</td>
<td><button class="remove-device-btn" onclick="removeDevice(this)" type="button">X√≥a</button></td>

</tr>
</tbody>
</table>

<button class="add-device-btn" onclick="addDevice()" type="button">+ Th√™m thi·∫øt b·ªã</button>
</div>
<div class="preview-section">
<div style="text-align:right; margin-bottom:10px;">
<button onclick="printDocument('tool1')" style="background:#2196F3;color:white;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;" type="button">‚¨áÔ∏è T·∫£i PDF</button>
</div>
<div class="section-title with-action"><span class="title-text">üëÅÔ∏è XEM TR∆Ø·ªöC</span><div class="action-buttons-in-title"><button class="btn share-in-title" type="button" onclick="generateAndSharePDF()">üì§ Chia s·∫ª</button><button class="settings-icon-in-title" type="button" onclick="openSettings()" aria-label="C√†i ƒë·∫∑t">‚öôÔ∏è</button></div></div>
<div class="quick-actions">
<button class="quick-print-btn" onclick="printDocument('tool1')" type="button">üñ®Ô∏è In ngay</button>
</div>

<div class="document-preview" id="documentPreview">
<!-- Document preview will be generated here -->
</div>
<div class="print-actions" style="margin-top: 15px;">
<button class="btn btn-primary" onclick="openPrintModal('tool1')" type="button">üëÅÔ∏è Xem tr∆∞·ªõc to√†n m√†n h√¨nh</button>
<button class="btn btn-success" onclick="printDocument('tool1')" type="button">üñ®Ô∏è In t√†i li·ªáu</button>
</div>
</div>
</div>
<!-- Tool 2: Bi√™n b·∫£n chuy·ªÉn nh∆∞·ª£ng -->
<div class="tool-content" id="tool2" style="display: none;">
<div class="mobile-switch" data-tool="tool2">
<button class="switch-btn active" onclick="setToolView('tool2','form')" type="button">üìù Nh·∫≠p Li·ªáu</button>
<button class="switch-btn" onclick="setToolView('tool2','preview')" type="button">üëÅÔ∏è Xem Tr∆∞·ªõc</button>
<button class="switch-btn" onclick="printDocument('tool2')" type="button">‚¨áÔ∏è T·∫£i PDF</button>
</div>
<div class="form-section">
<div class="section-title">üìù TH√îNG TIN CHUY·ªÇN NH∆Ø·ª¢NG</div>
<div class="form-group">
<label>S·ªë h·ª£p ƒë·ªìng chuy·ªÉn nh∆∞·ª£ng:</label>
<input id="transferContractNumber" placeholder="Nh·∫≠p s·ªë h·ª£p ƒë·ªìng" type="text">
</input></div>
<div class="form-row">
<div class="form-group">
<label>Ng√†y k√Ω:</label>
<div class="date-input-group">
<input id="transferContractDate" placeholder="dd/mm/yyyy" type="text" data-no-unify-date="true">
<div class="date-help">V√≠ d·ª•: 15/08/2024</div>
</input></div>
</div>
<div class="form-group">
<label>Ng√†y chuy·ªÉn nh∆∞·ª£ng:</label>
<input id="transferDate" type="date">
</input></div>
</div>
<div class="section-title">üè¢ Th√¥ng Tin B√™n A (B√™n Chuy·ªÉn Nh∆∞·ª£ng)</div>
<div class="form-group">
<label>T√™n c√¥ng ty/t·ªï ch·ª©c:</label>
<input id="transferPartyAName" placeholder="Nh·∫≠p t√™n c√¥ng ty" type="text">
</input></div>
<div class="form-group">
<label>ƒê·ªãa ch·ªâ tr·ª• s·ªü:</label>
<textarea id="transferPartyAAddress" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ" rows="2"></textarea>
</div>
<div class="form-row">
<div class="form-group">
<label>M√£ s·ªë thu·∫ø:</label>
<input id="transferPartyATaxCode" placeholder="0123456789" type="text"/>
</div>
<div class="form-group">
<label>Ng∆∞·ªùi ƒë·∫°i di·ªán:</label>
<input id="transferPartyARepresentative" placeholder="H·ªç v√† t√™n" type="text"/>
</div>
</div>
<div class="form-group">
<label>Ch·ª©c v·ª•:</label>
<input id="transferPartyAPosition" placeholder="Ch·ª©c v·ª•" type="text"/>
</div>
</div>
<div class="form-section">
<div class="form-section">
<div class="section-title">üè¢ Th√¥ng Tin B√™n B (B√™n Nh·∫≠n Chuy·ªÉn Nh∆∞·ª£ng)</div>
<div class="form-group">
<label>T√™n c√¥ng ty/t·ªï ch·ª©c:</label>
<input id="transferPartyBName" oninput="updateTransferPreview()" placeholder="Nh·∫≠p t√™n c√¥ng ty/t·ªï ch·ª©c" type="text"/>
</div>
<div class="form-group">
<label>M√£ s·ªë thu·∫ø:</label>
<input id="transferPartyBTaxCode" oninput="updateTransferPreview()" placeholder="0123456789" type="text"/>
</div>
<div class="form-group">
<label>Ng∆∞·ªùi ƒë·∫°i di·ªán:</label>
<input id="transferPartyBRepresentative" oninput="updateTransferPreview()" placeholder="H·ªç v√† t√™n" type="text"/>
</div>
<div class="form-group">
<label>Ch·ª©c v·ª•:</label>
<input id="transferPartyBPosition" oninput="updateTransferPreview()" placeholder="Ch·ª©c v·ª•" type="text"/>
</div>
<div class="form-group">
<label>ƒê·ªãa ch·ªâ tr·ª• s·ªü:</label>
<textarea id="transferPartyBAddress" oninput="updateTransferPreview()" placeholder="ƒê·ªãa ch·ªâ tr·ª• s·ªü" rows="2"></textarea>
</div>
</div>
<div class="section-title">üì± DANH S√ÅCH THI·∫æT B·ªä CHUY·ªÇN NH∆Ø·ª¢NG</div>
<table class="device-table" id="transferDeviceTable">
<thead>
<tr>
<th>S·ªë TT</th>
<th>Serial thi·∫øt b·ªã</th>
<th>Lo·∫°i thi·∫øt b·ªã</th>
<th>T√¨nh tr·∫°ng s·ª≠ d·ª•ng</th>
<th>Thao t√°c</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td><input oninput="updateTransferPreview()" placeholder="Nh·∫≠p serial thi·∫øt b·ªã" type="text"/></td>
<td><input oninput="updateTransferPreview()" placeholder="Lo·∫°i thi·∫øt b·ªã" list="deviceTypeOptions" required="" type="text"/></td>
<td>
<select onchange="updateTransferPreview()" required="">
<option value="T·ªët">T·ªët</option>
<option value="B√¨nh th∆∞·ªùng">B√¨nh th∆∞·ªùng</option>
<option value="H·ªèng">H·ªèng</option>
</select>
</td>
<td><button class="remove-device-btn" onclick="removeTransferDeviceRow(this)" type="button">X√≥a</button></td>
</tr>
<tr>
<td>2</td>
<td><input oninput="updateTransferPreview()" placeholder="Nh·∫≠p serial thi·∫øt b·ªã" type="text"/></td>
<td><input oninput="updateTransferPreview()" placeholder="Lo·∫°i thi·∫øt b·ªã" list="deviceTypeOptions" required="" type="text"/></td>
<td>
<select onchange="updateTransferPreview()" required="">
<option value="T·ªët">T·ªët</option>
<option value="B√¨nh th∆∞·ªùng">B√¨nh th∆∞·ªùng</option>
<option value="H·ªèng">H·ªèng</option>
</select>
</td>
<td><button class="remove-device-btn" onclick="removeTransferDeviceRow(this)" type="button">X√≥a</button></td>
</tr>
<tr>
<td>3</td>
<td><input oninput="updateTransferPreview()" placeholder="Nh·∫≠p serial thi·∫øt b·ªã" type="text"/></td>
<td><input oninput="updateTransferPreview()" placeholder="Lo·∫°i thi·∫øt b·ªã" list="deviceTypeOptions" required="" type="text"/></td>
<td>
<select onchange="updateTransferPreview()" required="">
<option value="T·ªët">T·ªët</option>
<option value="B√¨nh th∆∞·ªùng">B√¨nh th∆∞·ªùng</option>
<option value="H·ªèng">H·ªèng</option>
</select>
</td>
<td><button class="remove-device-btn" onclick="removeTransferDeviceRow(this)" type="button">X√≥a</button></td>
</tr>
</tbody>
</table>

<button class="add-device-btn" onclick="addTransferDeviceRow()" type="button">+ Th√™m thi·∫øt b·ªã</button>
</div>
<div class="preview-section">
<div style="text-align:right; margin-bottom:10px;">
<button onclick="printDocument('tool2')" style="background:#2196F3;color:white;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;" type="button">‚¨áÔ∏è T·∫£i PDF</button>
</div>
<div class="section-title with-action"><span class="title-text">üëÅÔ∏è XEM TR∆Ø·ªöC</span><div class="action-buttons-in-title"><button class="btn share-in-title" type="button" onclick="generateAndSharePDF()">üì§ Chia s·∫ª</button><button class="settings-icon-in-title" type="button" onclick="openSettings()" aria-label="C√†i ƒë·∫∑t">‚öôÔ∏è</button></div></div>
<div class="quick-actions">
<button class="quick-print-btn" onclick="printDocument('tool2')" type="button">üñ®Ô∏è In ngay</button>
</div>
<div class="document-preview" id="transferDocumentPreview">
<p>N·ªôi dung bi√™n b·∫£n chuy·ªÉn nh∆∞·ª£ng s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y...</p>
</div>
<div class="print-actions" style="margin-top: 15px;">
<button class="btn btn-primary" onclick="openPrintModal('tool2')" type="button">üëÅÔ∏è Xem tr∆∞·ªõc to√†n m√†n h√¨nh</button>
<button class="btn btn-success" onclick="printDocument('tool2')" type="button">üñ®Ô∏è In t√†i li·ªáu</button>
</div>
</div>
</div>
<!-- Tool 3: Bi√™n b·∫£n ·ªßy quy·ªÅn -->
<div class="tool-content" id="tool3" style="display: none;">
<div class="mobile-switch" data-tool="tool3">
<button class="switch-btn active" onclick="setToolView('tool3','form')" type="button">üìù Nh·∫≠p Li·ªáu</button>
<button class="switch-btn" onclick="setToolView('tool3','preview')" type="button">üëÅÔ∏è Xem Tr∆∞·ªõc</button>
<button class="switch-btn" onclick="printDocument('tool3')" type="button">‚¨áÔ∏è T·∫£i PDF</button>
</div>
<div class="form-section">
<div class="section-title">üìù TH√îNG TIN ·ª¶Y QUY·ªÄN</div>
<div class="form-group">
<label>Ng√†y ·ªßy quy·ªÅn:</label>
<div class="date-input-group">
<input id="authorizationDate" placeholder="dd/mm/yyyy" type="text" data-no-unify-date="true">
<div class="date-help">V√≠ d·ª•: 15/08/2024</div>
</input></div>
</div>
<div class="section-title">üè¢ B√äN ·ª¶Y QUY·ªÄN</div>
<div class="form-group">
<label>T√™n c√¥ng ty/t·ªï ch·ª©c:</label>
<input id="authorizerCompanyName" placeholder="Nh·∫≠p t√™n c√¥ng ty" type="text">
</input></div>
<div class="form-group">
<label>ƒê·ªãa ch·ªâ b√™n ·ªßy quy·ªÅn:</label>
<textarea id="authorizerAddress" placeholder="ƒê·ªãa ch·ªâ ƒë·∫ßy ƒë·ªß" rows="2"></textarea>
</div>
<div class="form-group">
<label>S·ªë ƒêKKD:</label>
<input id="authorizerLicenseNumber" placeholder="S·ªë ƒëƒÉng k√Ω kinh doanh" type="text">
</input></div>
<div class="form-row">
<div class="form-group">
<label>Ch·ª©c v·ª•:</label>
<input id="authorizerPosition" placeholder="Ch·ª©c v·ª•" type="text">
</input></div>
<div class="form-group">
<label>Ng∆∞·ªùi ƒë·∫°i di·ªán theo ph√°p lu·∫≠t:</label>
<input id="authorizerLegalRepresentative" placeholder="H·ªç v√† t√™n" type="text">
</input></div>
</div>
<div class="section-title">üë§ B√äN ƒê∆Ø·ª¢C ·ª¶Y QUY·ªÄN</div>
<div class="form-group">
<label>√îng/B√† ƒë∆∞·ª£c ·ªßy quy·ªÅn:</label>
<input id="authorizedPersonName" placeholder="H·ªç v√† t√™n ng∆∞·ªùi ƒë∆∞·ª£c ·ªßy quy·ªÅn" type="text">
</input></div>
<div class="form-row">
<div class="form-group">
<label>CCCD:</label>
<input id="authorizedPersonId" placeholder="S·ªë CCCD" type="text">
</input></div>
<div class="form-group">
<label>ƒê·ªãa ch·ªâ th∆∞·ªùng tr√∫:</label>
<input id="authorizedPersonAddress" placeholder="ƒê·ªãa ch·ªâ th∆∞·ªùng tr√∫" type="text">
</input></div>
</div>
<div class="section-title">üí≥ TH√îNG TIN T√ÄI KHO·∫¢N</div>
<div class="form-row">
<div class="form-group">
<label>S·ªë t√†i kho·∫£n:</label>
<input id="accountNumber" placeholder="S·ªë t√†i kho·∫£n" type="text">
</input></div>
<div class="form-group">
<label>T√™n ch·ªß t√†i kho·∫£n:</label>
<input id="accountHolderName" placeholder="T√™n ch·ªß t√†i kho·∫£n" type="text">
</input></div>
</div>
<div class="form-row">
<div class="form-group">
<label>T·∫°i ng√¢n h√†ng:</label>
<input id="bankName" placeholder="T√™n ng√¢n h√†ng" type="text">
</input></div>
<div class="form-group">
<label>Chi nh√°nh:</label>
<input id="bankBranch" placeholder="Chi nh√°nh" type="text">
</input></div>
</div>
</div>
<div class="preview-section">
<div style="text-align:right; margin-bottom:10px;">
<button onclick="printDocument('tool3')" style="background:#2196F3;color:white;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;" type="button">‚¨áÔ∏è T·∫£i PDF</button>
</div>
<div class="section-title with-action"><span class="title-text">üëÅÔ∏è XEM TR∆Ø·ªöC</span><div class="action-buttons-in-title"><button class="btn share-in-title" type="button" onclick="generateAndSharePDF()">üì§ Chia s·∫ª</button><button class="settings-icon-in-title" type="button" onclick="openSettings()" aria-label="C√†i ƒë·∫∑t">‚öôÔ∏è</button></div></div>
<div class="quick-actions">
<button class="quick-print-btn" onclick="printDocument('tool3')" type="button">üñ®Ô∏è In ngay</button>
</div>

<div class="document-preview" id="authorizationDocumentPreview">
<p>N·ªôi dung gi·∫•y ·ªßy quy·ªÅn s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y...</p>
</div>
<div class="print-actions" style="margin-top: 15px;">
<button class="btn btn-primary" onclick="openPrintModal('tool3')" type="button">üëÅÔ∏è Xem tr∆∞·ªõc to√†n m√†n h√¨nh</button>
<button class="btn btn-success" onclick="printDocument('tool3')" type="button">üñ®Ô∏è In t√†i li·ªáu</button>
</div>
</div>
</div>
</div>
<script>
        let deviceCount = 1;
        let currentTool = 'tool1';

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            const terminationDateElement = document.getElementById('terminationDate');
            const transferDateElement = document.getElementById('transferDate');
            
            if (terminationDateElement) terminationDateElement.value = today;
            if (transferDateElement) transferDateElement.value = today;
            
            // Set default authorization date to today
            const authorizationDateElement = document.getElementById('authorizationDate');
            if (authorizationDateElement) {
                const today = new Date();
                const dd = String(today.getDate()).padStart(2, '0');
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const yyyy = today.getFullYear();
                authorizationDateElement.value = dd + '/' + mm + '/' + yyyy;
            }
            
            // Add event listeners safely
            document.querySelectorAll('input, textarea, select').forEach(element => {
                element.addEventListener('input', function() {
                    updateAllPreviews();
                });
                element.addEventListener('change', function() {
                    updateAllPreviews();
                });
            });

            document.querySelectorAll('input[name="deviceHandling"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const otherTextarea = document.getElementById('otherHandling');
                    if (otherTextarea) {
                        otherTextarea.disabled = this.value !== 'other';
                        if (this.value !== 'other') {
                            otherTextarea.value = '';
                        }
                    }
                    updateAllPreviews();
                });
            });

            // Add date input formatting
            setupDateInput();
            
            // Initialize previews
            setTimeout(() => {
                updateAllPreviews();
            }, 100);
        });

        function updateAllPreviews() {
            if (typeof updatePreview === 'function') updatePreview();
            if (typeof updateTransferPreview === 'function') updateTransferPreview();
            if (typeof updateAuthorizationPreview === 'function') updateAuthorizationPreview();
        }

        function setupDateInput() {
            const dateInputs = ['contractDate', 'transferContractDate', 'authorizationDate'];
            
            dateInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('input', function(e) {
                        let value = e.target.value.replace(/\D/g, '');
                        
                        if (value.length >= 2) {
                            value = value.substring(0, 2) + '/' + value.substring(2);
                        }
                        if (value.length >= 5) {
                            value = value.substring(0, 5) + '/' + value.substring(5);
                        }
                        if (value.length > 10) {
                            value = value.substring(0, 10);
                        }
                        
                        e.target.value = value;
                    });

                    input.addEventListener('blur', function(e) {
                        const value = e.target.value;
                        if (value && value.length === 10) {
                            const parts = value.split('/');
                            if (parts.length === 3) {
                                const day = parseInt(parts[0]);
                                const month = parseInt(parts[1]);
                                const year = parseInt(parts[2]);
                                
                                if (day < 1 || day > 31 || month < 1 || month > 12 || year < 1900 || year > 2100) {
                                    alert('Ng√†y kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p theo ƒë·ªãnh d·∫°ng dd/mm/yyyy');
                                    e.target.focus();
                                }
                            }
                        }
                    });
                }
            });
        }

        
function addDevice(){
  deviceCount++;
  const tbody = document.querySelector('#deviceTable tbody');
  if(!tbody) return;
  const newRow = tbody.insertRow();
  newRow.innerHTML = [
    `<td>${deviceCount}</td>`,
    `<td><input type="text" placeholder="Lo·∫°i thi·∫øt b·ªã" list="deviceTypeOptions" oninput="updatePreview()" required></td>`,
    `<td><input type="text" value="C√°i" list="unitOptions" placeholder="C√°i" oninput="updatePreview()" required></td>`,
    `<td><input type="text" value="1" oninput="updatePreview()" required></td>`,
    `<td><input type="text" placeholder="Serial number" oninput="updatePreview()" required></td>`,
    `<td><select onchange="updatePreview()" required>
        <option value="T·ªët" selected>T·ªët</option>
        <option value="B√¨nh th∆∞·ªùng">B√¨nh th∆∞·ªùng</option>
        <option value="H·ªèng">H·ªèng</option>
      </select></td>`,
    `<td><button type="button" class="remove-device-btn" onclick="removeDevice(this)">X√≥a</button></td>`
  ].join('');

  // Sau khi th√™m thi·∫øt b·ªã v√†o b·∫£ng thanh l√Ω, ƒë·ªìng b·ªô l·∫°i b·∫£ng chuy·ªÉn nh∆∞·ª£ng
  if (typeof syncTransferDevicesFromLiquidation === 'function') {
    try { syncTransferDevicesFromLiquidation(); } catch (e) {}
  }
}
function removeDevice(button) {
            const row = button.closest('tr');
            row.remove();
            
            // Renumber rows
            const rows = document.querySelectorAll('#deviceTable tbody tr');
            rows.forEach((row, index) => {
                row.cells[0].textContent = index + 1;
            });
            
            deviceCount = rows.length;
            updatePreview();

            // Sau khi x√≥a thi·∫øt b·ªã ·ªü b·∫£ng thanh l√Ω, ƒë·ªìng b·ªô l·∫°i b·∫£ng chuy·ªÉn nh∆∞·ª£ng
            if (typeof syncTransferDevicesFromLiquidation === 'function') {
              try { syncTransferDevicesFromLiquidation(); } catch (e) {}
            }
        }

        function formatDateForDisplay(dateString) {
            if (!dateString) return '...... th√°ng ........ nƒÉm 202......';
            
            // Handle dd/mm/yyyy format
            if (dateString.includes('/')) {
                return dateString;
            }
            
            // Handle date input format (yyyy-mm-dd)
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString;
            
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function getDeviceHandlingText() {
            const selected = document.querySelector('input[name="deviceHandling"]:checked');
            if (!selected) return '';
            
            const otherText = document.getElementById('otherHandling').value;
            
            if (selected.value === 'keep') {
                return '‚òë B√™n A kh√≥a c√°c t√†i kho·∫£n hi·ªán c√≥ c·ªßa B√™n B tr√™n h·ªá th·ªëng thanh to√°n c·ªßa B√™n A, c√°c thi·∫øt b·ªã thanh to√°n s·∫Ω thu·ªôc quy·ªÅn s·ªü h·ªØu c·ªßa B√™n B.\n' +
                       '‚òê B√™n A kh√≥a c√°c t√†i kho·∫£n hi·ªán c√≥ c·ªßa B√™n B tr√™n h·ªá th·ªëng thanh to√°n c·ªßa B√™n A v√† B√™n B b√†n giao l·∫°i c√°c thi·∫øt b·ªã B√™n A ƒë√£ cung c·∫•p cho B√™n B. Danh s√°ch c√°c thi·∫øt b·ªã B√™n B b√†n giao l·∫°i cho B√™n A ƒë∆∞·ª£c li·ªát k√™ t·∫°i kho·∫£n c c·ªßa ƒêi·ªÅu 1 n√†y.\n' +
                       '‚òê Kh√°c (vui l√≤ng ghi chi ti·∫øt): ‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶';
            } else if (selected.value === 'return') {
                return '‚òê B√™n A kh√≥a c√°c t√†i kho·∫£n hi·ªán c√≥ c·ªßa B√™n B tr√™n h·ªá th·ªëng thanh to√°n c·ªßa B√™n A, c√°c thi·∫øt b·ªã thanh to√°n s·∫Ω thu·ªôc quy·ªÅn s·ªü h·ªØu c·ªßa B√™n B.\n' +
                       '‚òë B√™n A kh√≥a c√°c t√†i kho·∫£n hi·ªán c√≥ c·ªßa B√™n B tr√™n h·ªá th·ªëng thanh to√°n c·ªßa B√™n A v√† B√™n B b√†n giao l·∫°i c√°c thi·∫øt b·ªã B√™n A ƒë√£ cung c·∫•p cho B√™n B. Danh s√°ch c√°c thi·∫øt b·ªã B√™n B b√†n giao l·∫°i cho B√™n A ƒë∆∞·ª£c li·ªát k√™ t·∫°i kho·∫£n c c·ªßa ƒêi·ªÅu 1 n√†y.\n' +
                       '‚òê Kh√°c (vui l√≤ng ghi chi ti·∫øt): ‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶';
            } else {
                return '‚òê B√™n A kh√≥a c√°c t√†i kho·∫£n hi·ªán c√≥ c·ªßa B√™n B tr√™n h·ªá th·ªëng thanh to√°n c·ªßa B√™n A, c√°c thi·∫øt b·ªã thanh to√°n s·∫Ω thu·ªôc quy·ªÅn s·ªü h·ªØu c·ªßa B√™n B.\n' +
                       '‚òê B√™n A kh√≥a c√°c t√†i kho·∫£n hi·ªán c√≥ c·ªßa B√™n B tr√™n h·ªá th·ªëng thanh to√°n c·ªßa B√™n A v√† B√™n B b√†n giao l·∫°i c√°c thi·∫øt b·ªã B√™n A ƒë√£ cung c·∫•p cho B√™n B. Danh s√°ch c√°c thi·∫øt b·ªã B√™n B b√†n giao l·∫°i cho B√™n A ƒë∆∞·ª£c li·ªát k√™ t·∫°i kho·∫£n c c·ªßa ƒêi·ªÅu 1 n√†y.\n' +
                       '‚òë Kh√°c (vui l√≤ng ghi chi ti·∫øt): ' + (otherText || '‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶');
            }
        }

        function getDeviceTable() {
            const deviceTable = document.getElementById('deviceTable');
            if (!deviceTable) return '';
            
            const rows = deviceTable.querySelectorAll('tbody tr');
            let tableHTML = `
                <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                    <thead>
                        <tr>
                            <th style="border: 1px solid #000; padding: 8px; text-align: center; background: #f5f5f5;">TT</th>
                            <th style="border: 1px solid #000; padding: 8px; text-align: center; background: #f5f5f5;">Lo·∫°i thi·∫øt b·ªã</th>
                            <th style="border: 1px solid #000; padding: 8px; text-align: center; background: #f5f5f5;">ƒê∆°n v·ªã</th>
                            <th style="border: 1px solid #000; padding: 8px; text-align: center; background: #f5f5f5;">S·ªë l∆∞·ª£ng</th>
                            <th style="border: 1px solid #000; padding: 8px; text-align: center; background: #f5f5f5;">Serial thi·∫øt b·ªã</th>
                            <th style="border: 1px solid #000; padding: 8px; text-align: center; background: #f5f5f5;">T√¨nh tr·∫°ng s·ª≠ d·ª•ng</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // Only include rows that contain at least one non‚Äëempty field.  We
            // skip entirely empty rows so that the preview and PDF do not show
            // blank device entries.  To preserve the numbering order after
            // skipping rows, we use a separate counter rather than the original
            // index argument.
            let displayIndex = 0;
            rows.forEach((row) => {
                const cells = row.cells;
                const deviceType = cells[1] ? (cells[1].querySelector('input')?.value || cells[1].querySelector('select')?.value || '') : '';
                const unit = cells[2] ? cells[2].querySelector('input')?.value || '' : '';
                const quantity = cells[3] ? cells[3].querySelector('input')?.value || '' : '';
                const serial = cells[4] ? cells[4].querySelector('input')?.value || '' : '';
                const condition = cells[5] ? cells[5].querySelector('select')?.value || '' : '';

                // Consider a row to have data only if the user has entered at least
                // a device type or a serial number.  Default values for unit,
                // quantity and condition should not cause an empty row to show
                // up in the preview.  If both deviceType and serial are blank,
                // we skip this row.
                if (!deviceType.trim() && !serial.trim()) {
                    return;
                }

                displayIndex++;
                tableHTML += `
                    <tr>
                        <td style="border: 1px solid #000; padding: 8px; text-align: center;">${displayIndex}</td>
                        <td style="border: 1px solid #000; padding: 8px;">${deviceType}</td>
                        <td style="border: 1px solid #000; padding: 8px; text-align: center;">${unit}</td>
                        <td style="border: 1px solid #000; padding: 8px; text-align: center;">${quantity}</td>
                        <td style="border: 1px solid #000; padding: 8px; text-align: center;">${serial}</td>
                        <td style="border: 1px solid #000; padding: 8px; text-align: center;">${condition}</td>
                    </tr>
                `;
            });

            // Note: We intentionally do not append extra empty rows here.  
            // Removing the filler rows reduces the overall height of the
            // document, which helps keep the final PDF within two A4 pages
            // without altering the core layout or content.

            tableHTML += '</tbody></table>';
            return tableHTML;
        }

        function updatePreview() {
            const contractNumberEl = document.getElementById('contractNumber');
            const contractDateEl = document.getElementById('contractDate');
            const terminationDateEl = document.getElementById('terminationDate');
            const partyBNameEl = document.getElementById('partyBName');
            const partyBAddressEl = document.getElementById('partyBAddress');
            const partyBWebsiteEl = document.getElementById('partyBWebsite');
            const partyBPhoneEl = document.getElementById('partyBPhone');
            const partyBFaxEl = document.getElementById('partyBFax');
            const partyBAccountEl = document.getElementById('partyBAccount');
            const partyBBankEl = document.getElementById('partyBBank');
            const partyBTaxCodeEl = document.getElementById('partyBTaxCode');
            const partyBRepresentativeEl = document.getElementById('partyBRepresentative');
            const partyBPositionEl = document.getElementById('partyBPosition');
            
            const contractNumber = contractNumberEl ? contractNumberEl.value || '..........................................' : '..........................................';
            const contractDate = contractDateEl ? formatDateForDisplay(contractDateEl.value) : '...... th√°ng ........ nƒÉm 202......';
            const terminationDate = terminationDateEl ? formatDateForDisplay(terminationDateEl.value) : '...... th√°ng ........ nƒÉm 202......';
            
            const partyBName = partyBNameEl ? partyBNameEl.value || '.....................................................................................................................' : '.....................................................................................................................';
            const partyBAddress = partyBAddressEl ? partyBAddressEl.value || '.....................................................................................................................' : '.....................................................................................................................';
            const partyBWebsite = partyBWebsiteEl ? partyBWebsiteEl.value || '..............................................' : '..............................................';
            const partyBPhone = partyBPhoneEl ? partyBPhoneEl.value || '.............................................' : '.............................................';
            const partyBFax = partyBFaxEl ? partyBFaxEl.value || '...............................................................' : '...............................................................';
            const partyBAccount = partyBAccountEl ? partyBAccountEl.value || '.............................................' : '.............................................';
            const partyBBank = partyBBankEl ? partyBBankEl.value || '.............................................' : '.............................................';
            const partyBTaxCode = partyBTaxCodeEl ? partyBTaxCodeEl.value || '.............................................' : '.............................................';
            const partyBRepresentative = partyBRepresentativeEl ? partyBRepresentativeEl.value || '............................................' : '............................................';
            const partyBPosition = partyBPositionEl ? partyBPositionEl.value || '.......................................................' : '.......................................................';

            const deviceHandlingText = getDeviceHandlingText();
            const deviceTable = getDeviceTable();

            const previewHTML = generateDocumentHTML(contractNumber, contractDate, terminationDate, partyBName, partyBAddress, partyBWebsite, partyBPhone, partyBFax, partyBAccount, partyBBank, partyBTaxCode, partyBRepresentative, partyBPosition, deviceHandlingText, deviceTable);

            const previewElement = document.getElementById('documentPreview');
            if (previewElement) {
                previewElement.innerHTML = previewHTML;
            }
        }

        function generateDocumentHTML(contractNumber, contractDate, terminationDate, partyBName, partyBAddress, partyBWebsite, partyBPhone, partyBFax, partyBAccount, partyBBank, partyBTaxCode, partyBRepresentative, partyBPosition, deviceHandlingText, deviceTable) {
            return `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="float: left; width: 50%;">
                        <strong>C√îNG TY C·ªî PH·∫¶N C√îNG NGH·ªÜ VI M√î</strong><br>
                        T·∫ßng 12A, t√≤a nh√† VTC Online, s·ªë 18 Tam Trinh, Hai B√† Tr∆∞ng, H√† N·ªôi<br>
                        Hotline: 1900.63.64.88 | Email: hotro@mpos.vn<br>
                        Ver. 060924 | 1
                    </div>
                    <div style="float: right; width: 50%;">
                        <strong>C·ªòNG H√íA X√É H·ªòI CH·ª¶ NGHƒ®A VI·ªÜT NAM</strong><br>
                        ƒê·ªôc l·∫≠p ‚Äì T·ª± do ‚Äì H·∫°nh ph√∫c<br>
                        ***
                    </div>
                    <div style="clear: both;"></div>
                </div>

                <div style="text-align: center; margin: 30px 0;">
                    <h2><strong>BI√äN B·∫¢N THANH L√ù H·ª¢P ƒê·ªíNG</strong></h2>
                    <p><em>(V/v: Thanh l√Ω H·ª£p ƒë·ªìng d·ªãch v·ª• thanh to√°n s·ªë ${contractNumber})</em></p>
                </div>

                <div style="margin-bottom: 20px;">
                    <p>CƒÉn c·ª© B·ªô lu·∫≠t d√¢n s·ª± nƒÉm 2015 v√† Lu·∫≠t th∆∞∆°ng m·∫°i 2005;</p>
                    <p>CƒÉn c·ª© H·ª£p ƒë·ªìng d·ªãch v·ª• thanh to√°n s·ªë <strong>${contractNumber}</strong>, k√Ω ng√†y <strong>${contractDate}</strong>;</p>
                    <p>CƒÉn c·ª© nhu c·∫ßu v√† kh·∫£ nƒÉng c·ªßa c√°c b√™n,</p>
                    <p>H√¥m nay, ng√†y <strong>${terminationDate}</strong>, ch√∫ng t√¥i g·ªìm:</p>
                </div>

                <div style="margin: 20px 0;">
                    <p><strong>B√äN B: ${partyBName}</strong></p>
                    <p>Tr·ª• s·ªü: ${partyBAddress}</p>
                    <p>Website: ${partyBWebsite}</p>
                    <p>ƒêi·ªán tho·∫°i: ${partyBPhone} &nbsp;&nbsp;&nbsp; Fax: ${partyBFax}</p>
                    <p>T√†i kho·∫£n: ${partyBAccount}</p>
                    <p>T·∫°i: ${partyBBank}</p>
                    <p>M√£ s·ªë thu·∫ø: ${partyBTaxCode}</p>
                    <p>Ng∆∞·ªùi ƒë·∫°i di·ªán: <strong>${partyBRepresentative}</strong> &nbsp;&nbsp;&nbsp; Ch·ª©c v·ª•: <strong>${partyBPosition}</strong></p>
                </div>

                <div style="margin: 20px 0;">
                    <p><strong>B√äN A: C√îNG TY C·ªî PH·∫¶N C√îNG NGH·ªÜ VI M√î</strong></p>
                    <p>Tr·ª• s·ªü: T·∫ßng 12A, to√† nh√† VTC Online, s·ªë 18 ƒë∆∞·ªùng Tam Trinh, Ph∆∞·ªùng Minh Khai, Qu·∫≠n Hai B√† Tr∆∞ng, Th√†nh ph·ªë H√† N·ªôi, Vi·ªát Nam.</p>
                    <p>ƒêi·ªán tho·∫°i: 024 36320986 &nbsp;&nbsp;&nbsp; Fax: 024 36320987</p>
                    <p>T√†i kho·∫£n: 11001010157634</p>
                    <p>T·∫°i: Ng√¢n h√†ng Maritimebank</p>
                    <p>M√£ s·ªë thu·∫ø: 0106393463</p>
                    <p>Ng∆∞·ªùi ƒë·∫°i di·ªán: <strong>ƒê·ªñ C√îNG DI·ªÑN</strong> &nbsp;&nbsp;&nbsp; Ch·ª©c v·ª•: <strong>T·ªîNG GI√ÅM ƒê·ªêC</strong></p>
                </div>

                <div style="margin: 30px 0;">
                    <p>Hai b√™n c√πng th·ªëng nh·∫•t thanh l√Ω H·ª£p ƒë·ªìng d·ªãch v·ª• thanh to√°n s·ªë <strong>${contractNumber}</strong>, k√Ω ng√†y <strong>${contractDate}</strong> v√† c√°c ph·ª• l·ª•c h·ª£p ƒë·ªìng ƒëi k√®m v·ªõi nh·ªØng n·ªôi dung nh∆∞ sau:</p>
                </div>

                <div style="margin: 20px 0;">
                    <p><strong>ƒêi·ªÅu 1: N·ªôi dung th·ª±c hi·ªán</strong></p>
                    <p><strong>a.</strong> B·∫±ng Bi√™n b·∫£n n√†y Hai B√™n c√πng th·ªëng nh·∫•t ch·∫•m d·ª©t hi·ªáu l·ª±c v√† ti·∫øn h√†nh thanh l√Ω H·ª£p ƒë·ªìng d·ªãch v·ª• thanh to√°n s·ªë <strong>${contractNumber}</strong>, k√Ω ng√†y <strong>${contractDate}</strong> v√† c√°c ph·ª• l·ª•c h·ª£p ƒë·ªìng ƒëi k√®m;</p>
                    
                    <p><strong>b.</strong> V·ªõi c√°c thi·∫øt b·ªã thanh to√°n B√™n A ƒë√£ cung c·∫•p cho B√™n B theo H·ª£p ƒë·ªìng d·ªãch v·ª• thanh to√°n s·ªë <strong>${contractNumber}</strong>, k√Ω ng√†y <strong>${contractDate}</strong> v√† c√°c ph·ª• l·ª•c h·ª£p ƒë·ªìng ƒëi k√®m, hai B√™n ƒë·ªìng √Ω th·ª±c hi·ªán c√°c t√°c v·ª• sau:</p>
                    
                    <p><em>(Vui l√≤ng ƒë√°nh d·∫•u X v√†o ph∆∞∆°ng √°n x·ª≠ l√Ω t∆∞∆°ng ·ª©ng ƒë∆∞·ª£c th·ªëng nh·∫•t b·ªüi hai B√™n)</em></p>
                    
                    <div style="margin: 15px 0; line-height: 1.8; white-space: pre-line;">
                        ${deviceHandlingText}
                    </div>
                    
                    <p><strong>c.</strong> Danh s√°ch c√°c thi·∫øt b·ªã m√† B√™n B b√†n giao l·∫°i cho B√™n A, nh∆∞ sau:</p>
                    ${deviceTable}
                </div>

                <div style="margin: 30px 0;">
                    <p><strong>ƒêi·ªÅu 2: Cam ƒëoan c·ªßa c√°c B√™n</strong></p>
                    <p><strong>a.</strong> Vi·ªác thanh l√Ω H·ª£p ƒë·ªìng n√≥i tr√™n l√† ho√†n to√†n t·ª± nguy·ªán, d·ª©t kho√°t, kh√¥ng b·ªã √©p bu·ªôc v√† kh√¥ng k√®m theo b·∫•t c·ª© ƒëi·ªÅu ki·ªán n√†o, kh√¥ng nh·∫±m tr·ªën tr√°nh b·∫•t k·ª≥ m·ªôt nghƒ©a v·ª• n√†o;</p>
                    
                    <p><strong>b.</strong> Vi·ªác thanh l√Ω H·ª£p ƒë·ªìng d·ªãch v·ª• thanh to√°n s·ªë <strong>${contractNumber}</strong>, k√Ω ng√†y <strong>${contractDate}</strong> v√† c√°c ph·ª• l·ª•c h·ª£p ƒë·ªìng ƒëi k√®m, kh√¥ng l√†m ch·∫•m d·ª©t c√°c quy·ªÅn l·ª£i, nghƒ©a v·ª• v√† tr√°ch nhi·ªám c·ªßa c√°c B√™n ph√°t sinh tr∆∞·ªõc th·ªùi ƒëi·ªÉm Thanh l√Ω H·ª£p ƒë·ªìng;</p>
                    
                    <p><strong>c.</strong> C√°c b√™n ƒë√£ ƒë·ªçc v√† ƒë·ªìng √Ω v·ªõi n·ªôi dung Bi√™n b·∫£n thanh l√Ω H·ª£p ƒë·ªìng n√†y, ƒë·ªìng th·ªùi k√Ω t√™n, ƒëi·ªÉm ch·ªâ, ƒë√≥ng d·∫•u v√†o Bi√™n b·∫£n n√†y l√†m b·∫±ng ch·ª©ng;</p>
                    
                    <p><strong>d.</strong> VƒÉn b·∫£n n√†y ƒë∆∞·ª£c l·∫≠p th√†nh 02 (hai) b·∫£n, b·∫±ng ti·∫øng Vi·ªát c√≥ n·ªôi dung v√† gi√° tr·ªã ph√°p l√Ω nh∆∞ nhau, m·ªói b√™n gi·ªØ 01 (m·ªôt) b·∫£n ƒë·ªÉ c√πng thi h√†nh.</p>
                </div>

                    <!--
                      Ch·ªØ k√Ω cho bi√™n b·∫£n thanh l√Ω:
                      - Gi·ªØ ti√™u ƒë·ªÅ "ƒê·∫†I DI·ªÜN B√äN A/B".
                      - Hi·ªÉn th·ªã h·ªç t√™n ngay b√™n d∆∞·ªõi ti√™u ƒë·ªÅ.
                      - Ch·ª´a kho·∫£ng tr·ªëng 80px sau t√™n ƒë·ªÉ k√Ω, sau ƒë√≥ m·ªõi ƒë·∫øn d√≤ng k·∫ª k√Ω.
                    -->
                    <div style="display: flex; justify-content: space-between; margin-top: 50px;">
                        <div style="text-align: center; width: 45%;">
                            <p><strong>ƒê·∫†I DI·ªÜN B√äN A</strong></p>
                            <p style="margin-bottom: 80px;"><strong>ƒê·ªñ C√îNG DI·ªÑN</strong></p>
                            <p>_______________________</p>
                        </div>
                        <div style="text-align: center; width: 45%;">
                            <p><strong>ƒê·∫†I DI·ªÜN B√äN B</strong></p>
                            <p style="margin-bottom: 80px;"><strong>${partyBRepresentative || '‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶'}</strong></p>
                            <p>_______________________</p>
                        </div>
                    </div>

                <div style="margin-top: 40px; font-size: 12px;">
                    <p><strong>Ghi ch√∫:</strong></p>
                    <p><strong>(1)</strong> S·ªë H·ª£p ƒë·ªìng d·ªãch v·ª• thanh to√°n/ H·ª£p ƒë·ªìng h·ª£p t√°c ch·∫•p nh·∫≠n thanh to√°n ƒë√£ k√Ω gi·ªØa B√™n B v√† C√¥ng ty C·ªï ph·∫ßn C√¥ng ngh·ªá Vi m√¥</p>
                    <p><strong>(2)</strong> Lo·∫°i thi·∫øt b·ªã: mPOS/ SmartPOS/ Mini SmartPOS/ SmartPOS Pro/ S85/ t√†i s·∫£n kh√°c</p>
                    <p><strong>(3)</strong> ƒêi·ªÅn serial thi·∫øt b·ªã b√†n giao</p>
                    <p><strong>(4)</strong> ƒê√°nh gi√° t√¨nh tr·∫°ng s·ª≠ d·ª•ng: T·ªët/ b√¨nh th∆∞·ªùng/ kh√¥ng s·ª≠ d·ª•ng ƒë∆∞·ª£c</p>
                    <p><strong>(5)</strong> S·ªë H·ª£p ƒë·ªìng d·ªãch v·ª• thanh to√°n/ H·ª£p ƒë·ªìng h·ª£p t√°c ch·∫•p nh·∫≠n thanh to√°n ƒë√£ k√Ω gi·ªØa B√™n B v√† C√¥ng ty C·ªï ph·∫ßn C√¥ng ngh·ªá Vi m√¥</p>
                </div>
            `;
        }

        // Functions for Tool 2 - Transfer Document
        function updateTransferPreview() {
            const transferContractNumberEl = document.getElementById('transferContractNumber');
            const transferContractDateEl = document.getElementById('transferContractDate');
            const transferDateEl = document.getElementById('transferDate');
            const transferPartyANameEl = document.getElementById('transferPartyAName');
            const transferPartyAAddressEl = document.getElementById('transferPartyAAddress');
            const transferPartyATaxCodeEl = document.getElementById('transferPartyATaxCode');
            const transferPartyARepresentativeEl = document.getElementById('transferPartyARepresentative');
            const transferPartyAPositionEl = document.getElementById('transferPartyAPosition');
            const transferPartyBNameEl = document.getElementById('transferPartyBName');
            const transferPartyBAddressEl = document.getElementById('transferPartyBAddress');
            const transferPartyBTaxCodeEl = document.getElementById('transferPartyBTaxCode');
            const transferPartyBRepresentativeEl = document.getElementById('transferPartyBRepresentative');
            const transferPartyBPositionEl = document.getElementById('transferPartyBPosition');
            
            const transferContractNumber = transferContractNumberEl ? transferContractNumberEl.value || '...............................................' : '...............................................';
            const transferContractDate = transferContractDateEl ? formatDateForDisplay(transferContractDateEl.value) : '........ th√°ng ......... nƒÉm .................';
            const transferDate = transferDateEl ? formatDateForDisplay(transferDateEl.value) : '...‚Ä¶ th√°ng ....‚Ä¶. nƒÉm..........';
            const partyAName = transferPartyANameEl ? transferPartyANameEl.value || '‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶...' : '‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶...';
            const partyAAddress = transferPartyAAddressEl ? transferPartyAAddressEl.value || '‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶' : '‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶';
            const partyATaxCode = transferPartyATaxCodeEl ? transferPartyATaxCodeEl.value || '‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶' : '‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶';
            const partyARepresentative = transferPartyARepresentativeEl ? transferPartyARepresentativeEl.value || '‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶' : '‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶';
            const partyAPosition = transferPartyAPositionEl ? transferPartyAPositionEl.value || '‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶' : '‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶';

            const partyBName = transferPartyBNameEl ? transferPartyBNameEl.value || '‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶...' : '‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶...';
            const partyBAddress = transferPartyBAddressEl ? transferPartyBAddressEl.value || '‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶' : '‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶';
            const partyBTaxCode = transferPartyBTaxCodeEl ? transferPartyBTaxCodeEl.value || '‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶' : '‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶';
            const partyBRepresentative = transferPartyBRepresentativeEl ? transferPartyBRepresentativeEl.value || '‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶' : '‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶';
            const partyBPosition = transferPartyBPositionEl ? transferPartyBPositionEl.value || '‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶' : '‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶';

            // Get data from device table
            // ƒê·ªìng b·ªô b·∫£ng thi·∫øt b·ªã chuy·ªÉn nh∆∞·ª£ng v·ªõi b·∫£ng thi·∫øt b·ªã thanh l√Ω tr∆∞·ªõc khi d·ª±ng b·∫£n xem tr∆∞·ªõc.
            if (typeof syncTransferDevicesFromLiquidation === 'function') {
                try { syncTransferDevicesFromLiquidation(); } catch (e) {}
            }

            const transferDeviceTable = document.getElementById('transferDeviceTable');
            let deviceTableHTML = '';
            
            if (transferDeviceTable) {
                const deviceRows = transferDeviceTable.querySelectorAll('tbody tr');
                deviceRows.forEach((row, index) => {
                    // Grab serial, device type and status from either input or select elements.
                    const serialInput = row.querySelector('td:nth-child(2) input');
                    // Device type may be input (free‚Äëtext) or select (predefined options)
                    const deviceTypeEl = row.querySelector('td:nth-child(3) input, td:nth-child(3) select');
                    // Status may also be input or select. In the default table rows status is an input, while
                    // dynamically added rows use a select element. Support both.
                    const statusEl = row.querySelector('td:nth-child(4) input, td:nth-child(4) select');

                    const serial = serialInput ? serialInput.value : '';
                    const deviceType = deviceTypeEl ? deviceTypeEl.value : 'mPOS SmartPOS';
                    const status = statusEl ? statusEl.value : '';
                    
                    deviceTableHTML += `
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">${index + 1}</td>
                            <td style="border: 1px solid #000; padding: 4px;">${serial}</td>
                            <td style="border: 1px solid #000; padding: 4px;">${deviceType}</td>
                            <td style="border: 1px solid #000; padding: 4px;">${status}</td>
                        </tr>
                    `;
                });
            }

            const transferPreviewContent = `
                <div class="transfer-document">
                    <div style="text-align: center; margin: 0 0 10px 0;">
                        C·ªông h√≤a x√£ h·ªôi ch·ªß nghƒ©a Vi·ªát Nam<br>
                        ƒê·ªôc l·∫≠p - T·ª± do - H·∫°nh ph√∫c<br>
                        ------------------
                    </div>

                    <div style="text-align: center; font-weight: bold; margin: 10px 0 15px 0;">
                        BI√äN B·∫¢N CHUY·ªÇN NH∆Ø·ª¢NG THI·∫æT B·ªä THANH TO√ÅN
                    </div>

                    <div style="margin: 10px 0;">
                        CƒÉn c·ª©: H·ª£p ƒë·ªìng s·ªë <strong>${transferContractNumber}</strong> k√Ω ng√†y <strong>${transferContractDate}</strong>
                    </div>

                    <div style="margin: 10px 0;">
                        H√¥m nay, ng√†y <strong>${transferDate}</strong>, ch√∫ng t√¥i g·ªìm: 
                    </div>

                    <div style="margin: 10px 0;">
                        <strong>B√™n Chuy·ªÉn Nh∆∞·ª£ng</strong><br>
                        ${partyAName}<br><br>
                        M√£ s·ªë thu·∫ø: ${partyATaxCode}<br><br>
                        Ng∆∞·ªùi ƒë·∫°i di·ªán: ${partyARepresentative}<br>
                        Ch·ª©c v·ª•: ${partyAPosition}<br><br>
                        ƒê·ªãa ch·ªâ tr·ª• s·ªü:<br>
                        ${partyAAddress}<br>
                        (sau ƒë√¢y g·ªçi l√† B√™n A)
                    </div>

                    <div style="margin: 10px 0;">
                        <strong>B√™n Nh·∫≠n Chuy·ªÉn Nh∆∞·ª£ng</strong><br>
                        ${partyBName}<br><br>
                        M√£ s·ªë thu·∫ø: ${partyBTaxCode}<br><br>
                        Ng∆∞·ªùi ƒë·∫°i di·ªán: ${partyBRepresentative}<br>
                        Ch·ª©c v·ª•: ${partyBPosition}<br><br>
                        ƒê·ªãa ch·ªâ :<br>
                        ${partyBAddress}<br>
                        (sau ƒë√¢y g·ªçi l√† B√™n B)
                    </div>

                    <div style="margin: 10px 0;">
                        Hai b√™n c√πng th·ªëng nh·∫•t B√™n A chuy·ªÉn nh∆∞·ª£ng v√† B√™n B nh·∫≠n chuy·ªÉn nh∆∞·ª£ng thi·∫øt b·ªã ‚Ä¶‚Ä¶‚Ä¶‚Ä¶..‚Ä¶‚Ä¶. c√≥ ngu·ªìn g·ªëc do B√™n A mua t·ª´ C√¥ng ty C·ªï ph·∫ßn C√¥ng ngh·ªá Vi M√¥ theo Ph·ª• l·ª•c cung c·∫•p v√† b√†n giao thi·∫øt b·ªã thanh to√°n th·∫ª k√®m theo H·ª£p ƒë·ªìng h·ª£p t√°c ch·∫•p nh·∫≠n thanh to√°n s·ªë <strong>${transferContractNumber}</strong> ............................................... k√Ω gi·ªØa B√™n A v√† C√¥ng ty C·ªï ph·∫ßn C√¥ng ngh·ªá Vi M√¥ (ƒë∆°n v·ªã cung c·∫•p c√°c thi·∫øt b·ªã n√™u tr√™n, sau ƒë√¢y g·ªçi l√† ‚ÄúVIMO‚Äù) v·ªõi nh·ªØng n·ªôi dung nh∆∞ sau:
                    </div>

                    <div style="margin: 10px 0;">
                        <strong>ƒêi·ªÅu 1: N·ªôi dung chuy·ªÉn nh∆∞·ª£ng</strong><br><br>
                        a. B√™n A x√°c nh·∫≠n ƒë√£ b√†n giao ƒë·∫ßy ƒë·ªß thi·∫øt b·ªã cho B√™n B v·ªõi t√¨nh tr·∫°ng thi·∫øt b·ªã c√≤n ho·∫°t ƒë·ªông v√† s·ª≠ d·ª•ng ƒë∆∞·ª£c b√¨nh th∆∞·ªùng theo ƒë√∫ng ti√™u chu·∫©n ch·∫•t l∆∞·ª£ng c·ªßa nh√† s·∫£n xu·∫•t v√† ƒë∆°n v·ªã cung c·∫•p.<br><br>
                        b. B√™n A cam k·∫øt ch·ªãu to√†n b·ªô tr√°ch nhi·ªám tr∆∞·ªõc B√™n B li√™n quan ƒë·∫øn ch·∫•t l∆∞·ª£ng, t√¨nh tr·∫°ng c·ªßa thi·∫øt b·ªã ƒë∆∞·ª£c chuy·ªÉn nh∆∞·ª£ng v√† b·∫•t k·ª≥ l·ªói, khi·∫øm khuy·∫øt n√†o c·ªßa thi·∫øt b·ªã trong m·ªçi tr∆∞·ªùng h·ª£p v√† m·ªçi th·ªùi ƒëi·ªÉm ph√°t sinh (n·∫øu c√≥).<br><br>
                        c. Danh s√°ch c√°c thi·∫øt b·ªã m√† B√™n A chuy·ªÉn nh∆∞·ª£ng l·∫°i cho B√™n B c·ª• th·ªÉ nh∆∞ sau:
                    </div>

                    <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
                        <tr>
                            <th style="border: 1px solid #000; padding: 4px; text-align: center;">S·ªë TT</th>
                            <th style="border: 1px solid #000; padding: 4px; text-align: center;">Serial thi·∫øt b·ªã</th>
                            <th style="border: 1px solid #000; padding: 4px; text-align: center;">Lo·∫°i thi·∫øt b·ªã</th>
                            <th style="border: 1px solid #000; padding: 4px; text-align: center;">T√¨nh tr·∫°ng s·ª≠ d·ª•ng</th>
                        </tr>
                        ${deviceTableHTML}
                    </table>

                    <div style="margin: 10px 0;">
                        <strong>ƒêi·ªÅu 2: ƒêi·ªÅu kho·∫£n thi h√†nh</strong><br><br>
                        a. Vi·ªác B√™n A k√Ω k·∫øt v·ªõi B√™n B bi√™n b·∫£n chuy·ªÉn nh∆∞·ª£ng thi·∫øt b·ªã n√†y ƒë·ªìng nghƒ©a l√† to√†n b·ªô quy·ªÅn v√† nghƒ©a v·ª• ƒë·ªëi v·ªõi thi·∫øt b·ªã n√™u t·∫°i ƒêi·ªÅu 1 c·ªßa VIMO theo quy ƒë·ªãnh t·∫°i Ph·ª• l·ª•c cung c·∫•p v√† b√†n giao thi·∫øt b·ªã thanh to√°n th·∫ª k√Ω k·∫øt v·ªõi B√™n A (bao g·ªìm c·∫£ nghƒ©a v·ª• b·∫£o h√†nh) v√† theo quy ƒë·ªãnh c·ªßa ph√°p lu·∫≠t ch·∫•m d·ª©t hi·ªáu l·ª±c. VIMO ƒë∆∞·ª£c mi·ªÖn tr·ª´ tr√°ch nhi·ªám ƒë·ªëi v·ªõi b·∫•t k·ª≥ khi·∫øu n·∫°i, khi·∫øu ki·ªán, tranh ch·∫•p n√†o li√™n quan ƒë·∫øn thi·∫øt b·ªã n√™u t·∫°i Bi√™n b·∫£n n√†y.<br><br>
                        b. Trong tr∆∞·ªùng h·ª£p vi·ªác chuy·ªÉn nh∆∞·ª£ng thi·∫øt b·ªã n√™u t·∫°i Bi√™n b·∫£n n√†y d·∫´n ƒë·∫øn B√™n A ch·∫•m d·ª©t H·ª£p ƒë·ªìng h·ª£p t√°c ch·∫•p nh·∫≠n thanh to√°n s·ªë <strong>${transferContractNumber}</strong>: ‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶.. ƒë√£ k√≠ v·ªõi VIMO, B√™n A c·∫ßn ho√†n thi·ªán ƒë·∫ßy ƒë·ªß c√°c tr√°ch nhi·ªám t√†i ch√≠nh v√† gi·∫£i quy·∫øt tri·ªát ƒë·ªÉ c√°c v·∫•n ƒë·ªÅ c√≤n t·ªìn t·∫°i li√™n quan ƒë·∫øn H·ª£p ƒë·ªìng ƒë√≥ trong th·ªùi h·∫°n 540 (nƒÉm trƒÉm b·ªën m∆∞∆°i) ng√†y k·ªÉ t·ª´ ng√†y B√™n A chuy·ªÉn nh∆∞·ª£ng thi·∫øt b·ªã cho B√™n B. B√™n A v√† VIMO s·∫Ω k√Ω bi√™n b·∫£n ch·∫•m d·ª©t H·ª£p ƒë·ªìng h·ª£p t√°c ch·∫•p nh·∫≠n thanh to√°n sau khi hai B√™n ho√†n th√†nh to√†n b·ªô nghƒ©a v·ª• quy ƒë·ªãnh t·∫°i H·ª£p ƒë·ªìng n√†y.<br><br>
                        c. V·ªõi vi·ªác B√™n B nh·∫≠n chuy·ªÉn nh∆∞·ª£ng thi·∫øt b·ªã t·ª´ B√™n A theo c√°c n·ªôi dung n√™u t·∫°i ƒêi·ªÅu 1 c√≥ nghƒ©a l√† B√™n B ch·∫•p thu·∫≠n k√Ω k·∫øt H·ª£p ƒë·ªìng h·ª£p t√°c ch·∫•p nh·∫≠n thanh to√°n s·ªë ‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶.. ‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶.. v·ªõi VIMO ƒë·ªÉ s·ª≠ d·ª•ng c√°c d·ªãch v·ª• thanh to√°n t∆∞∆°ng ·ª©ng v·ªõi thi·∫øt b·ªã nh·∫≠n chuy·ªÉn nh∆∞·ª£ng v√†/ ho·∫∑c thi·∫øt b·ªã kh√°c c·ªßa VIMO.<br><br>
                        d. VƒÉn b·∫£n n√†y ƒë∆∞·ª£c l·∫≠p th√†nh 02 b·∫£n, b·∫±ng ti·∫øng Vi·ªát v·ªõi n·ªôi dung v√† gi√° tr·ªã ph√°p l√Ω nh∆∞ nhau, m·ªói b√™n gi·ªØ 01 b·∫£n ƒë·ªÉ c√πng thi h√†nh.
                    </div>

                    <!--
                      Ch·ªØ k√Ω cho bi√™n b·∫£n chuy·ªÉn nh∆∞·ª£ng:
                      - Gi·ªØ ti√™u ƒë·ªÅ "ƒê·∫†I DI·ªÜN B√äN A/B".
                      - Hi·ªÉn th·ªã h·ªç t√™n ngay b√™n d∆∞·ªõi ti√™u ƒë·ªÅ.
                      - Ch·ª´a kho·∫£ng tr·ªëng 80px sau t√™n ƒë·ªÉ k√Ω, sau ƒë√≥ m·ªõi ƒë·∫øn d√≤ng k·∫ª k√Ω.
                    -->
                    <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                      <div style="text-align: center; width: 45%;">
                        <p><strong>ƒê·∫†I DI·ªÜN B√äN A</strong></p>
                        <p style="margin-bottom: 80px;"><strong>${partyARepresentative || "‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶"}</strong></p>
                        <p>_______________________</p>
                      </div>
                      <div style="text-align: center; width: 45%;">
                        <p><strong>ƒê·∫†I DI·ªÜN B√äN B</strong></p>
                        <p style="margin-bottom: 80px;"><strong>${partyBRepresentative || "‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶"}</strong></p>
                        <p>_______________________</p>
                      </div>
                    </div>
                </div>
`;

            const transferPreviewElement = document.getElementById('transferDocumentPreview');
            if (transferPreviewElement) {
                transferPreviewElement.innerHTML = transferPreviewContent;
            }
        }

        
function addTransferDeviceRow(){
  const tbody = document.querySelector('#transferDeviceTable tbody');
  if(!tbody) return;
  const rowCount = tbody.rows.length + 1;
  const newRow = tbody.insertRow();
  newRow.innerHTML = [
    `<td>${rowCount}</td>`,
    `<td><input type="text" placeholder="Nh·∫≠p serial thi·∫øt b·ªã" oninput="updateTransferPreview()" required></td>`,
    `<td><input type="text" placeholder="Lo·∫°i thi·∫øt b·ªã" list="deviceTypeOptions" oninput="updateTransferPreview()" required></td>`,
    `<td><select onchange="updateTransferPreview()" required>
        <option value="T·ªët" selected>T·ªët</option>
        <option value="B√¨nh th∆∞·ªùng">B√¨nh th∆∞·ªùng</option>
        <option value="H·ªèng">H·ªèng</option>
      </select></td>`,
    `<td><button type="button" class="remove-device-btn" onclick="removeTransferDeviceRow(this)">X√≥a</button></td>`
  ].join('');
}

/*
 * ƒê·ªìng b·ªô danh s√°ch thi·∫øt b·ªã t·ª´ b·∫£ng Thanh l√Ω (#deviceTable) sang b·∫£ng Chuy·ªÉn nh∆∞·ª£ng (#transferDeviceTable).
 * H√†m n√†y l·∫•y c√°c gi√° tr·ªã Lo·∫°i thi·∫øt b·ªã (c·ªôt 2), Serial (c·ªôt 5) v√† T√¨nh tr·∫°ng (c·ªôt 6) c·ªßa b·∫£ng thanh l√Ω v√†
 * x√¢y d·ª±ng l·∫°i b·∫£ng chuy·ªÉn nh∆∞·ª£ng v·ªõi 3 tr∆∞·ªùng: Serial, Lo·∫°i thi·∫øt b·ªã v√† T√¨nh tr·∫°ng s·ª≠ d·ª•ng. C√°c √¥ s·∫Ω v·∫´n
 * s·ª≠ d·ª•ng input/select ƒë·ªÉ ng∆∞·ªùi d√πng c√≥ th·ªÉ ch·ªânh s·ª≠a n·∫øu c·∫ßn, v√† m·ªói d√≤ng ƒë·ªÅu c√≥ n√∫t X√≥a. C√°c d√≤ng
 * tr·ªëng (kh√¥ng c√≥ serial, lo·∫°i thi·∫øt b·ªã v√† t√¨nh tr·∫°ng) s·∫Ω b·ªã b·ªè qua ƒë·ªÉ tr√°nh t·∫°o d√≤ng r·ªóng.
 */
function syncTransferDevicesFromLiquidation() {
  const liquidTable = document.getElementById('deviceTable');
  const transferTable = document.getElementById('transferDeviceTable');
  if (!liquidTable || !transferTable) return;
  const transferBody = transferTable.querySelector('tbody');
  if (!transferBody) return;
  // X√≥a to√†n b·ªô c√°c d√≤ng hi·ªán t·∫°i
  transferBody.innerHTML = '';
  const liquidRows = liquidTable.querySelectorAll('tbody tr');
  let rowIndex = 1;
  liquidRows.forEach((row) => {
    const deviceTypeEl = row.querySelector('td:nth-child(2) input, td:nth-child(2) select');
    const serialEl     = row.querySelector('td:nth-child(5) input');
    const statusEl     = row.querySelector('td:nth-child(6) select, td:nth-child(6) input');
    const serialVal    = serialEl && serialEl.value ? serialEl.value.trim() : '';
    const deviceTypeVal = deviceTypeEl && deviceTypeEl.value ? deviceTypeEl.value.trim() : '';
    const statusVal    = statusEl && statusEl.value ? statusEl.value.trim() : '';
    // B·ªè qua d√≤ng n·∫øu c·∫£ 3 tr∆∞·ªùng ƒë·ªÅu r·ªóng
    if (!serialVal && !deviceTypeVal && !statusVal) return;
    const newRow = document.createElement('tr');
    // T·∫°o select cho t√¨nh tr·∫°ng v·ªõi l·ª±a ch·ªçn ph√π h·ª£p
    const statusOptions = ['T·ªët', 'B√¨nh th∆∞·ªùng', 'H·ªèng'].map(function(opt) {
      return '<option value="' + opt + '"' + (statusVal === opt ? ' selected' : '') + '>' + opt + '</option>';
    }).join('');
    newRow.innerHTML = `
      <td>${rowIndex}</td>
      <td><input type="text" value="${serialVal}" placeholder="Nh·∫≠p serial thi·∫øt b·ªã" oninput="updateTransferPreview()" /></td>
      <td><input type="text" value="${deviceTypeVal}" placeholder="Lo·∫°i thi·∫øt b·ªã" list="deviceTypeOptions" oninput="updateTransferPreview()" /></td>
      <td><select onchange="updateTransferPreview()">${statusOptions}</select></td>
      <td><button type="button" class="remove-device-btn" onclick="removeTransferDeviceRow(this)">X√≥a</button></td>
    `;
    transferBody.appendChild(newRow);
    rowIndex++;
  });
}
function removeTransferDeviceRow(button) {
            const row = button.closest('tr');
            const tbody = row.parentNode;
            
            if (tbody.rows.length > 1) {
                row.remove();
                
                // Update row numbers
                Array.from(tbody.rows).forEach((row, index) => {
                    row.cells[0].textContent = index + 1;
                });
                
                updateTransferPreview();
            } else {
                alert('Ph·∫£i c√≥ √≠t nh·∫•t m·ªôt thi·∫øt b·ªã trong danh s√°ch');
            }

  // Sau khi x√≥a thi·∫øt b·ªã ·ªü b·∫£ng thanh l√Ω, ƒë·ªìng b·ªô l·∫°i b·∫£ng chuy·ªÉn nh∆∞·ª£ng
  if (typeof syncTransferDevicesFromLiquidation === 'function') {
    try { syncTransferDevicesFromLiquidation(); } catch (e) {}
  }
        }

        // Functions for Tool 3 - Authorization Document
        function updateAuthorizationPreview() {
            // Get form values
            const authorizationDate = document.getElementById('authorizationDate')?.value || '...... th√°ng ...... nƒÉm ......';
            const authorizerCompanyName = document.getElementById('authorizerCompanyName')?.value || '.......................................';
            const authorizerAddress = document.getElementById('authorizerAddress')?.value || '.......................................';
            const authorizerLicenseNumber = document.getElementById('authorizerLicenseNumber')?.value || '.......................................';
            const authorizerPosition = document.getElementById('authorizerPosition')?.value || '.......................................';
            const authorizerLegalRepresentative = document.getElementById('authorizerLegalRepresentative')?.value || '.......................................';
            const authorizedPersonName = document.getElementById('authorizedPersonName')?.value || '.......................................';
            const authorizedPersonId = document.getElementById('authorizedPersonId')?.value || '.......................................';
            const authorizedPersonAddress = document.getElementById('authorizedPersonAddress')?.value || '.......................................';
            const accountNumber = document.getElementById('accountNumber')?.value || '.......................................';
            const accountHolderName = document.getElementById('accountHolderName')?.value || '.......................................';
            const bankName = document.getElementById('bankName')?.value || '.......................................';
            const bankBranch = document.getElementById('bankBranch')?.value || '.......................................';

            const authorizationPreviewContent = `
                <div style="text-align: center; margin: 30px 0;">
                    <strong>C·ªòNG H√íA X√É H·ªòI CH·ª¶ NGHƒ®A VI·ªÜT NAM</strong><br>
                    ƒê·ªôc l·∫≠p ‚Äì T·ª± do ‚Äì H·∫°nh ph√∫c<br>
                    <div style="margin: 20px 0;">Ng√†y <strong>${authorizationDate}</strong></div>
                </div>

                <div style="text-align: center; margin: 30px 0;">
                    <strong>K√≠nh g·ª≠i: C√¥ng ty c·ªï ph·∫ßn C√¥ng ngh·ªá VI M√¥</strong>
                </div>

                    <div style="margin: 20px 0;">
                    <strong>${authorizerCompanyName} xin th√¥ng b√°o v·ªÅ vi·ªác ·ªßy quy·ªÅn nh∆∞ sau:</strong>
                </div>

                <div style="margin: 20px 0;">
                    <strong>B√™n ·ªßy quy·ªÅn:</strong> ${authorizerCompanyName}<br><br>
                    <strong>ƒê·ªãa ch·ªâ tr·ª• s·ªü:</strong> ${authorizerAddress}<br><br>
                    <strong>S·ªë ƒêKKD:</strong> ${authorizerLicenseNumber}<br><br>
                    <strong>Ng∆∞·ªùi ƒë·∫°i di·ªán theo ph√°p lu·∫≠t:</strong> ${authorizerLegalRepresentative}<br><br>
                    <strong>Ch·ª©c v·ª•:</strong> ${authorizerPosition}
                </div>

                <div style="margin: 20px 0;">
                    <strong>B√™n ƒë∆∞·ª£c ·ªßy quy·ªÅn:</strong> √îng/B√† ${authorizedPersonName}<br><br>
                    <strong>CCCD:</strong> ${authorizedPersonId}<br><br>
                    <strong>ƒê·ªãa ch·ªâ th∆∞·ªùng tr√∫:</strong> ${authorizedPersonAddress}
                </div>

                <div style="margin: 20px 0;">
                    <strong>N·ªôi dung ·ªßy quy·ªÅn:</strong> nh·∫≠n ti·ªÅn thanh to√°n qua thi·∫øt b·ªã mPOS c·ªßa VI M√¥ v·ªÅ t√†i kho·∫£n c·ªßa B√™n ƒë∆∞·ª£c ·ªßy quy·ªÅn, chi ti·∫øt nh∆∞ sau:<br><br>
                    <strong>S·ªë t√†i kho·∫£n:</strong> ${accountNumber}<br><br>
                    <strong>T√™n ch·ªß t√†i kho·∫£n:</strong> ${accountHolderName}<br><br>
                    <strong>T·∫°i ng√¢n h√†ng:</strong> ${bankName}<br><br>
                    <strong>Chi nh√°nh:</strong> ${bankBranch}
                </div>

                <div style="margin: 30px 0;">
                    Gi·∫•y ·ªßy quy·ªÅn n√†y c√≥ hi·ªáu l·ª±c k·ªÉ t·ª´ ng√†y k√Ω. N·∫øu c√≥ s·ª± thay ƒë·ªïi, b√™n ·ªßy quy·ªÅn ph·∫£i th√¥ng b√°o k·ªãp th·ªùi cho VI M√¥.
                </div>

                <div style="display: flex; justify-content: space-between; margin-top: 50px;">
                    <div style="text-align: center; width: 45%;">
                        <strong>B√™n ƒë∆∞·ª£c ·ªßy quy·ªÅn</strong><br>
                        <em>(k√Ω, ghi r√µ h·ªç t√™n)</em><br><br><br><br>
                        <strong>${authorizedPersonName || '................................'}</strong>
                    </div>
                    <div style="text-align: center; width: 45%;">
                        <strong>B√™n ·ªßy quy·ªÅn</strong><br>
                        <em>(k√Ω, ƒë√≥ng d·∫•u)</em><br><br><br><br>
                        <strong>${authorizerLegalRepresentative || '................................'}</strong>
                    </div>
                </div>
            `;

            const authorizationPreviewElement = document.getElementById('authorizationDocumentPreview');
            if (authorizationPreviewElement) {
                authorizationPreviewElement.innerHTML = authorizationPreviewContent;
            }
        }

        // Unified Print Functions - FIXED
        function openPrintModal(toolType) {
            currentTool = toolType || 'tool1';
            
            // Update the appropriate preview based on tool type
            switch(currentTool) {
                case 'tool1':
                    updatePreview();
                    break;
                case 'tool2':
                    updateTransferPreview();
                    break;
                case 'tool3':
                    updateAuthorizationPreview();
                    break;
            }
            
            const modal = document.getElementById('printModal');
            const printContent = document.getElementById('printContent');
            
            let sourceElement;
            switch(currentTool) {
                case 'tool1':
                    sourceElement = document.getElementById('documentPreview');
                    break;
                case 'tool2':
                    sourceElement = document.getElementById('transferDocumentPreview');
                    break;
                case 'tool3':
                    sourceElement = document.getElementById('authorizationDocumentPreview');
                    break;
                default:
                    sourceElement = document.getElementById('documentPreview');
            }
            
            if (modal && printContent && sourceElement) {
                printContent.innerHTML = sourceElement.innerHTML;
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
        }

        
function printDocument(toolType){
  try{
    currentTool = toolType || 'tool1';
    if(currentTool==='tool1' && typeof updatePreview==='function') updatePreview();
    if(currentTool==='tool2' && typeof updateTransferPreview==='function') updateTransferPreview();
    if(currentTool==='tool3' && typeof updateAuthorizationPreview==='function') updateAuthorizationPreview();
    var map = {tool1:'#documentPreview', tool2:'#transferDocumentPreview', tool3:'#authorizationDocumentPreview'};
    var srcSel = map[currentTool] || '#documentPreview';
    var srcEl = document.querySelector(srcSel);
    var raw = srcEl ? srcEl.innerHTML : '<p>(Kh√¥ng t√¨m th·∫•y n·ªôi dung)</p>';
    var clean = raw.replace(/<script[\s\S]*?<\/script>/gi, '');
    var title = document.querySelector('.header h1')?.textContent || 'Tai lieu';
    // Use a slightly smaller page margin (10mm instead of 12mm) to help
    // condense the printed content onto two A4 pages.  Font sizes are left
    // unchanged to preserve readability and overall layout.
    var css = '@page{size:A4;margin:10mm;} body{font-family:"Times New Roman",serif;font-size:12px;line-height:1.4;margin:0;} table{border-collapse:collapse;width:100%;} th,td{border:1px solid #000;padding:4px; font-size:11px;} h1,h2,h3{page-break-after:avoid;}';
    // Compose the printable document using a template literal to avoid string concatenation errors.  Using backticks
    // prevents issues with single or double quotes inside the HTML/CSS and ensures the document is well-formed.
    var htmlDoc = `<!doctype html><html lang="vi"><head><meta charset="utf-8"><title>${title}</title><style>${css}</style></head><body>${clean}</body></html>`;
    var iframe = document.createElement('iframe');
    iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0'; iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0';
    document.body.appendChild(iframe);
    var doc = iframe.contentDocument || iframe.contentWindow.document;
    doc.open(); doc.write(htmlDoc); doc.close();
    setTimeout(function(){ iframe.contentWindow.focus(); iframe.contentWindow.print(); setTimeout(function(){ document.body.removeChild(iframe); }, 200); }, 200);
  }catch(e){ try{ window.print(); }catch(_){ } }
}


        function closePrintModal() {
            const modal = document.getElementById('printModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        function printFromModal() {
            window.print();
        }

        // Function to show different tools
        function showTool(toolName, element) {
            currentTool = toolName;
            
            // Remove active class from all tab links
            const tablinks = document.getElementsByClassName("tablink");
            for (let i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }
            
            // Add active class to the clicked tab
            if (element) {
                element.classList.add("active");
            }
            
            // Hide all tool content
            const tools = document.getElementsByClassName("tool-content");
            for (let i = 0; i < tools.length; i++) {
                tools[i].style.display = "none";
            }
            
            // Show the selected tool content
            const selectedTool = document.getElementById(toolName);
            if (selectedTool) {
                selectedTool.style.display = "block";
            }
            
            // Update the header title based on selected tool
            const headerTitle = document.querySelector('.header h1');
            if (headerTitle) {
                switch(toolName) {
                    case 'tool1':
                        headerTitle.textContent = 'C√îNG C·ª§ NH·∫¨P LI·ªÜU BI√äN B·∫¢N THANH L√ù H·ª¢P ƒê·ªíNG';
                        break;
                    case 'tool2':
                        headerTitle.textContent = 'C√îNG C·ª§ NH·∫¨P LI·ªÜU BI√äN B·∫¢N CHUY·ªÇN NH∆Ø·ª¢NG';
                        break;
                    case 'tool3':
                        headerTitle.textContent = 'C√îNG C·ª§ T·∫†O GI·∫§Y ·ª¶Y QUY·ªÄN';
                        break;
                }
            }
            
            // Update the appropriate preview
            setTimeout(() => {
                updateAllPreviews();
            }, 100);
        }

        // Handle mobile interactions
        document.addEventListener('focusin', function(e) {
            if (e.target.matches('input, textarea, select')) {
                setTimeout(() => {
                    e.target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 300);
            }
        });

        window.addEventListener('orientationchange', function() {
            setTimeout(() => {
                updateAllPreviews();
            }, 500);
        });

        // Touch gesture support for modal
        let touchStartY = 0;
        let touchEndY = 0;

        const printModal = document.getElementById('printModal');
        if (printModal) {
            printModal.addEventListener('touchstart', function(e) {
                touchStartY = e.changedTouches[0].screenY;
            });

            printModal.addEventListener('touchend', function(e) {
                touchEndY = e.changedTouches[0].screenY;
                handleModalSwipe();
            });

            // Close modal when clicking outside
            printModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closePrintModal();
                }
            });
        }

        function handleModalSwipe() {
            const swipeThreshold = 50;
            const swipeDistance = touchStartY - touchEndY;
            
            // Swipe down to close modal
            if (swipeDistance < -swipeThreshold) {
                closePrintModal();
            }
        }

        // Prevent zooming on double tap for form inputs on iOS
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(e) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // Enhanced mobile table handling
        function makeTableResponsive() {
            const tables = ['deviceTable', 'transferDeviceTable'];
            const isMobile = window.innerWidth < 768;
            
            tables.forEach(tableId => {
                const table = document.getElementById(tableId);
                if (table) {
                    if (isMobile) {
                        table.style.fontSize = '11px';
                        table.querySelectorAll('input, select').forEach(input => {
                            input.style.fontSize = '11px';
                            input.style.padding = '4px';
                        });
                    } else {
                        table.style.fontSize = '';
                        table.querySelectorAll('input, select').forEach(input => {
                            input.style.fontSize = '';
                            input.style.padding = '';
                        });
                    }
                }
            });
        }

        // Update table responsiveness on resize
        window.addEventListener('resize', makeTableResponsive);

        // Add visual feedback for touch interactions
        document.addEventListener('DOMContentLoaded', function() {
            makeTableResponsive();
            
            document.querySelectorAll('.btn, .add-device-btn, .remove-device-btn').forEach(button => {
                button.addEventListener('touchstart', function() {
                    this.style.transform = 'scale(0.95)';
                    this.style.opacity = '0.8';
                });
                
                button.addEventListener('touchend', function() {
                    this.style.transform = '';
                    this.style.opacity = '';
                });
            });
        });
    
function setToolView(toolId, view){
  var tool = document.getElementById(toolId);
  if(!tool) return;
  tool.setAttribute('data-view', view);
  var sw = tool.querySelector('.mobile-switch');
  if(sw){
    sw.querySelectorAll('.switch-btn').forEach(btn=>btn.classList.remove('active'));
    var idx = view==='form'?0:1;
    var btns = sw.querySelectorAll('.switch-btn');
    if(btns[idx]) btns[idx].classList.add('active');
  }
  if(view==='preview'){ if (typeof updateAllPreviews==='function') updateAllPreviews(); }
}
document.addEventListener('DOMContentLoaded', function(){
  ['tool1','tool2','tool3'].forEach(id=>{
    var el = document.getElementById(id);
    if(el && !el.getAttribute('data-view')) el.setAttribute('data-view','form');
  });
});


window.confirmClearDraft = function(){
  if(confirm('X√≥a b·∫£n nh√°p hi·ªán t·∫°i?')){
    if(typeof clearAutosave==='function') clearAutosave();
    try{ if(typeof updateAllPreviews==='function') updateAllPreviews(); }catch(e){}
  }
};

  window.exportPDF = function(){
    // Ensure latest content in print modal first
    if(typeof window.openPrintModal === 'function'){
      window.openPrintModal(window.currentTool || 'tool1');
    }
    // Small delay to ensure preview populated
    setTimeout(function(){
      window.print();
    }, 120);
  };

  async function generateAndSharePDF(){
    if(typeof window.openPrintModal === 'function'){
      window.openPrintModal(window.currentTool || 'tool1');
    }
    await new Promise(r=>setTimeout(r, 80));
    const el = document.getElementById('printContent');
    const filename = 'BienBan-' + new Date().toISOString().slice(0,19).replace(/[:T]/g,'-') + '.pdf';

    if(window.html2pdf){
      try{
        const worker = window.html2pdf().from(el).set({
          margin: 10,
          filename,
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 2, useCORS: true },
          jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        });
        const blob = await worker.outputPdf('blob');
        const file = new File([blob], filename, {type: 'application/pdf'});
        if(navigator.canShare && navigator.canShare({files:[file]})){
          await navigator.share({ files: [file], title: 'Bi√™n b·∫£n PDF' });
        }else{
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = filename; a.click();
          setTimeout(()=>URL.revokeObjectURL(url), 1000);
        }
        return;
      }catch(e){
        console.warn('PDF share failed, fallback to print', e);
      }
    }
    window.print();
  }
</script>
<!-- MOBILE OPTIMIZATION PATCH v2025-08-11 -->
<script id="mobile-optimizations-js">
(function () {
  // 3) 100vh fix fallback for older iOS: CSS var --vh
  function setVhVar() {
    var vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', vh + 'px');
  }
  setVhVar();
  window.addEventListener('resize', setVhVar);

  // 2) Debounce updateAllPreviews
  function debounce(fn, delay) {
    var t;
    return function() {
      var ctx = this, args = arguments;
      clearTimeout(t);
      t = setTimeout(function(){ fn.apply(ctx, args); }, delay);
    };
  }
  if (typeof window.updateAllPreviews === 'function') {
    var _origUpdateAllPreviews = window.updateAllPreviews;
    window.updateAllPreviews = debounce(function() {
      try { _origUpdateAllPreviews(); } catch(e) { console && console.warn(e); }
    }, 200);
  }

  // 4) Keyboard & autocomplete standardization
  function inferAutocomplete(s) {
    if (/(email|e-mail)/.test(s)) return 'email';
    if (/(phone|ƒëi·ªán tho·∫°i|tel)/.test(s)) return 'tel';
    if (/(name|h·ªç|ten|t√™n)/.test(s)) return 'name';
    if (/(address|ƒë·ªãa ch·ªâ)/.test(s)) return 'street-address';
    if (/(city|t·ªânh|th√†nh)/.test(s)) return 'address-level2';
    if (/(zip|postal|m√£ b[u∆∞]u)/.test(s)) return 'postal-code';
    if (/(company|c√¥ng ty|doanh nghi·ªáp)/.test(s)) return 'organization';
    return 'on';
  }
  function standardizeInputs(root) {
  // Disabled numeric keyboard and type coercion: allow free text everywhere.
  (root || document).querySelectorAll('input, textarea, select').forEach(function(el){
    if (el.tagName === 'TEXTAREA') {
      el.autocapitalize = 'sentences';
      el.autocomplete = 'on';
      el.enterKeyHint = 'done';
      return;
    }
    // Keep harmless defaults; DO NOT change type or inputMode
    el.autocapitalize = 'off';
    el.enterKeyHint = el.enterKeyHint || 'next';
    if (!el.autocomplete || el.autocomplete === 'off') {
      el.autocomplete = 'on';
    }
  });
}
  document.addEventListener('DOMContentLoaded', function(){
    standardizeInputs(document);
  });

  // 5) Wrap tables for horizontal scroll & sticky headers
  function wrapTables() {
    document.querySelectorAll('table').forEach(function(tbl){
      if (!tbl.closest('.table-scroll')) {
        var w = document.createElement('div');
        w.className = 'table-scroll';
        tbl.parentNode.insertBefore(w, tbl);
        w.appendChild(tbl);
      }
      // Ensure thead exists and sticky headers apply
      var ths = tbl.querySelectorAll('thead th');
      if (ths.length) {
        ths.forEach(function(th){ th.style.top = '0'; });
      }
    });
  }
  document.addEventListener('DOMContentLoaded', wrapTables);

  // 1) Tap feedback on touch (optional visual polish)
  document.addEventListener('touchstart', function(e){
    var t = e.target.closest('button, .btn, [role="button"], .button, .chip, .tab');
    if (!t) return;
    t.classList.add('active-touch');
    setTimeout(function(){ t.classList.remove('active-touch'); }, 150);
  }, {passive: true});
})();
</script>
</div>
<script>
document.addEventListener('DOMContentLoaded', function () {
  try {
    const tool2 = document.getElementById('tool2');
    if (!tool2) return;
    // Find direct child form sections of tool2
    const sections = Array.from(tool2.children).filter(el => el.classList && el.classList.contains('form-section'));
    if (sections.length >= 2) {
      const primary = sections[0];
      const secondary = sections[1];
      // Move all children of the second section into the first
      while (secondary.firstChild) {
        primary.appendChild(secondary.firstChild);
      }
      // Remove the now-empty second section
      secondary.remove();
    }
  } catch (e) {
    console.warn('Tool2 merge sections patch failed:', e);
  }
});
</script>


<script>
(function(){
  function markPlaceholdersInElement(el){
    if(!el) return;
    // Highlight common placeholder patterns in text
    const patterns = [
      /\u2026{2,}/g,                   // repeated ellipsis ‚Ä¶
      /\.{4,}/g,                        // long series of dots
      /_{3,}/g,                         // underscores
      /[¬∑‚Ä¢]{3,}/g,                      // bullets
      /[‚Äì‚Äî-]{5,}/g                      // dashes
    ];
    // Walk through elements and wrap matches
    const walker = document.createTreeWalker(el, NodeFilter.SHOW_TEXT, null);
    const toWrap = [];
    while (walker.nextNode()) {
      const node = walker.currentNode;
      const text = node.nodeValue;
      if(!text) continue;
      for (const p of patterns) {
        if (p.test(text)) { toWrap.push(node); break; }
      }
    }
    toWrap.forEach(node => {
      let html = node.nodeValue;
      patterns.forEach(p => {
        html = html.replace(p, (m)=>'<span class="hl-missing">'+m+'</span>');
      });
      const span = document.createElement('span');
      span.innerHTML = html;
      node.parentNode.replaceChild(span, node);
    });

    // Highlight empty table cells (only visible cells)
    el.querySelectorAll('td,th').forEach(cell => {
      const txt = cell.textContent.replace(/\u00a0/g,' ').trim();
      if (!txt) {
        cell.classList.add('hl-missing');
      }
    });
  }

  // Public function to apply highlights for a given preview container
  window.applyPreviewHighlights = function(){
    // Clear old highlights
    document.querySelectorAll('.hl-missing').forEach(e=>{
      e.classList.remove('hl-missing');
      // unwrap spans that were injected previously
      if (e.tagName === 'SPAN' && e.childNodes.length === 1 && e.firstChild.nodeType === 3) {
        const textNode = document.createTextNode(e.textContent);
        e.parentNode.replaceChild(textNode, e);
      }
    });

    const previews = [
      document.getElementById('documentPreview'),
      document.getElementById('transferDocumentPreview'),
      document.getElementById('authorizationDocumentPreview'),
      document.getElementById('printContent') // modal content when used
    ];
    previews.forEach(markPlaceholdersInElement);
  };

  // Hook existing preview update flows
  const origUpdateAll = window.updateAllPreviews;
  window.updateAllPreviews = function(){
    if (typeof origUpdateAll === 'function') origUpdateAll();
    setTimeout(window.applyPreviewHighlights, 0);
  };

  // Also hook setToolView when switching to "preview"
  const origSetToolView = window.setToolView;
  window.setToolView = function(toolId, view){
    if (typeof origSetToolView === 'function') origSetToolView(toolId, view);
    if (view === 'preview') setTimeout(window.applyPreviewHighlights, 0);
  };

  // When opening print modal, ensure highlights removed in printed output via CSS, but also refresh view
  const origOpenPrintModal = window.openPrintModal;
  window.openPrintModal = function(toolId){
    if (typeof origOpenPrintModal === 'function') origOpenPrintModal(toolId);
    setTimeout(window.applyPreviewHighlights, 0);
  };
})();
</script>


<script>
(function(){
  // Utility: mark empty fields inside a tool's form section
  function isEmptyField(el){
    if (!el) return false;
    if (el.disabled) return false;
    const tag = el.tagName;
    const type = (el.getAttribute('type')||'').toLowerCase();
    if (tag === 'TEXTAREA' || tag === 'INPUT') {
      // Treat empty or whitespace-only as missing
      return (el.value || '').trim() === '';
    }
    if (tag === 'SELECT') {
      // Missing if no value or first option is selected with empty value
      const v = (el.value || '').trim();
      return v === '';
    }
    return false;
  }

  function markMissingFormFields(toolId){
    const tool = document.getElementById(toolId);
    if (!tool) return;

    const formSections = tool.querySelectorAll('.form-section');
    formSections.forEach(sec => {
      sec.querySelectorAll('input, textarea, select').forEach(el => {
        // Remove old state first
        el.classList.remove('hl-field-missing');
        // mark if empty
        if (isEmptyField(el)) el.classList.add('hl-field-missing');

        // live cleanup: if user types/selects, remove highlight automatically
        const handler = function(){
          if (!isEmptyField(el)) el.classList.remove('hl-field-missing');
        };
        el.removeEventListener('input', handler); // in case of duplicates
        el.addEventListener('input', handler);
        el.removeEventListener('change', handler);
        el.addEventListener('change', handler);
      });
    });
  }

  // Hook setToolView to run marking when switching to preview
  const _origSetToolView = window.setToolView;
  window.setToolView = function(toolId, view){
    if (typeof _origSetToolView === 'function') _origSetToolView(toolId, view);
    if (view === 'preview') {
      // Mark form fields for the tool we are previewing
      setTimeout(function(){ markMissingFormFields(toolId); }, 0);
      // Also refresh preview highlights (placeholders) if available
      if (typeof window.applyPreviewHighlights === 'function') {
        setTimeout(window.applyPreviewHighlights, 0);
      }
    }
  };

  // Also mark when user uses full-screen preview button (openPrintModal)
  const _origOpenPrintModal = window.openPrintModal;
  window.openPrintModal = function(toolId){
    if (typeof _origOpenPrintModal === 'function') _origOpenPrintModal(toolId);
    setTimeout(function(){ markMissingFormFields(toolId); }, 0);
  };

  // Expose for manual triggering if needed
  window.markMissingFormFields = markMissingFormFields;
})();
</script>


<script>
// === Session Autosave & Restore ===
(function(){
  const STORAGE_KEY = 'spapp_autosave_v2';
  const TOOL_KEY = 'spapp_current_tool';
  const SAVE_DEBOUNCE_MS = 400;
  let currentTool = (window.currentTool || 'tool1');

  function collectFields(){
    return Array.from(document.querySelectorAll('input, textarea, select'))
      .filter(el => !el.disabled && !el.readOnly && el.type !== 'button' && el.type !== 'submit' && el.type !== 'reset');
  }

  function serialize(){
    const data = { _ts: Date.now(), _tool: (window.currentTool || currentTool) };
    const radios = {};
    collectFields().forEach(el => {
      const key = el.name || el.id;
      if(!key) return;
      if(el.type === 'radio'){
        if(el.checked) radios[el.name] = el.value;
      } else if(el.type === 'checkbox'){
        data[key] = !!el.checked;
      } else {
        data[key] = el.value;
      }
    });
    Object.assign(data, radios);
    // Save active tool explicitly
    data['_tool'] = (window.currentTool || currentTool || 'tool1');
    return data;
  }

  function restore(data){
    if(!data) return;
    const map = data;
    collectFields().forEach(el => {
      const key = el.name || el.id;
      if(!key) return;
      if(el.type === 'radio'){
        if(map[el.name] !== undefined && el.value == map[el.name]) el.checked = true;
      } else if(el.type === 'checkbox'){
        if(map[key] !== undefined) el.checked = !!map[key];
      } else {
        if(map[key] !== undefined) el.value = map[key];
      }
      // Trigger input event for any bound preview updates
      el.dispatchEvent(new Event('input', {bubbles:true}));
      el.dispatchEvent(new Event('change', {bubbles:true}));
    });
    // Restore current tool/tab
    const tool = map['_tool'] || 'tool1';
    try { if(typeof window.showTool === 'function') window.showTool(tool); } catch(e){}
    window.currentTool = tool;
    try { if(typeof window.updateAllPreviews === 'function') window.updateAllPreviews(); } catch(e){}
    showToast('‚úÖ ƒê√£ kh√¥i ph·ª•c b·∫£n nh√°p g·∫ßn nh·∫•t.');
  }

  let saveTimer = null;
  function scheduleSave(){
    clearTimeout(saveTimer);
    saveTimer = setTimeout(() => {
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify(serialize()));
        localStorage.setItem(TOOL_KEY, window.currentTool || currentTool || 'tool1');
      }catch(e){ console.warn('Autosave failed', e); }
    }, SAVE_DEBOUNCE_MS);
  }

  function bindAutosave(){
    document.addEventListener('input', (e) => {
      const t = e.target;
      if(t && (t.matches('input, textarea, select'))) scheduleSave();
    }, true);
    document.addEventListener('change', (e) => {
      const t = e.target;
      if(t && (t.matches('input, textarea, select'))) scheduleSave();
    }, true);
    // Save on tab switch if app calls showTool
    const _showTool = window.showTool;
    window.showTool = function(toolName, element){
      window.currentTool = toolName;
      if(typeof _showTool === 'function') _showTool(toolName, element);
      scheduleSave();
    };
    // Initial restore
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw){
        const data = JSON.parse(raw);
        restore(data);
      }
    }catch(e){ console.warn('Restore failed', e); }
  }

  // Lightweight toast
  function showToast(msg){
    const el = document.createElement('div');
    el.textContent = msg;
    el.style.position='fixed'; el.style.left='50%'; el.style.bottom='90px';
    el.style.transform='translateX(-50%)';
    el.style.background='rgba(0,0,0,0.75)'; el.style.color='#fff';
    el.style.padding='10px 14px'; el.style.borderRadius='10px'; el.style.fontSize='14px';
    el.style.zIndex='10000'; el.style.maxWidth='90%'; el.style.textAlign='center';
    document.body.appendChild(el);
    setTimeout(()=>{ el.remove(); }, 1800);
  }

  window.clearAutosave = function(){
    localStorage.removeItem(STORAGE_KEY);
    showToast('üßπ ƒê√£ x√≥a b·∫£n nh√°p.');
  };

  document.addEventListener('DOMContentLoaded', bindAutosave);
})();

// === One-tap Share/Print (mobile friendly) ===
(function(){
  function collectPageStyles(){
    try {
      const styles = Array.from(document.querySelectorAll('style')).map(s=>s.textContent).join('\\n');
      return styles;
    } catch(e){ return ''; }
  }

  function buildPrintableHTML(){
    const pc = document.getElementById('printContent');
    const content = pc ? pc.innerHTML : '<p>(Kh√¥ng t√¨m th·∫•y n·ªôi dung in)</p>';
    const styles = collectPageStyles();
    const title = document.querySelector('.header h1')?.textContent || 'Bien-ban';
    const doc = `<!doctype html><html lang="vi"><head><meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${title}</title>
  <style>html,body{margin:0;padding:20px;font-family:Arial,Helvetica,sans-serif;color:#111;}
  img{max-width:100%;height:auto;} table{border-collapse:collapse;width:100%;} th,td{border:1px solid #ddd;padding:6px;vertical-align:top;}
  .section-title{font-weight:bold;margin:10px 0;font-size:16px;}
  @media print{ .no-print{display:none !important;} }</style>
  <style>${styles}</style>
  
<!-- === PERF PATCH: Transform-only Smart Positioning + Spacer + Lighter Effects (2025-08-14) === -->
<style id="perf-smartpos-20250814">
  :root{ --kb: 0px; }
  /* Override any previous padding-bottom hacks */
  @media (max-width:1023px){
    body{ padding-bottom: 0 !important; }
    /* Bottom action bar uses GPU transform only */
    .mobile-switch{
      position: fixed !important; left:0; right:0; bottom:0;
      transform: translate3d(0, calc(-1 * var(--kb, 0px)), 0);
      will-change: transform;
      transition: transform 80ms ease-out;
      z-index: 10001;
      box-shadow: 0 -6px 18px rgba(0,0,0,.10);
      background: rgba(255,255,255,0.96);
      -webkit-
      
    }
    .mobile-switch .switch-btn, .mobile-switch .btn{ min-height: 44px; }
    /* Spacer to keep last inputs visible without layout thrash */
    #kb-spacer{ height: calc(92px + var(--kb, 0px)); pointer-events:none; }
  }
  /* When keyboard open, lighten heavy effects for smoother FPS */
  .kb-open .mobile-switch{
    box-shadow: 0 -2px 8px rgba(0,0,0,.08);
    -webkit- 
  }
  /* Avoid scroll chaining inside tool panes */
  .form-container, .tool-content{
    overscroll-behavior: contain;
    -webkit-overflow-scrolling: touch;
  }
  @media print{
    #kb-spacer, .mobile-switch{ display:none !important; }
  }
</style>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, interactive-widget=overlays-content">\n
<!-- === PERF TUNING: disable blur + transition 80ms (2025-08-14) === -->
<style id="perf-no-blur-80ms">
  .mobile-switch{
    transition: transform 80ms ease-out !important;
  }
  .kb-open .mobile-switch{
    /* ensure no blur when keyboard open */
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
  }
</style>
</head><body>${content}
<script id="debounce-validate-collapsible">
/* === Debounce helper === */
function debounce(fn, delay){
  var t; return function(){ var ctx=this, args=arguments; clearTimeout(t); t=setTimeout(function(){ fn.apply(ctx,args); }, delay); };
}

/* === Lightweight validators === */

function validateField(el){
  if(!el) return;
  var val = (el.value || '').trim();
  // Basic: if empty => clear both states
  if(val.length === 0){
    el.classList.remove('is-valid');
    el.classList.remove('is-error');
    return;
  }
  // Determine type-specific validation
  var valid = true;
  if(el.type === 'email'){
    valid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val);
  }else if(el.type === 'number'){
    valid = !isNaN(val);
  }else if(el.type === 'tel'){
    valid = /^\+?[0-9\-\s]{6,}$/.test(val);
  }else if(el.type === 'date'){
    valid = !isNaN(Date.parse(val));
  }else{
    valid = val.length > 0;
  }
  if(valid){
    el.classList.add('is-valid');
    el.classList.remove('is-error');
  }else{
    el.classList.add('is-error');
    el.classList.remove('is-valid');
  }
}
/* stray else removed
The logic below is intentionally commented out as it appears to be a leftover from a previous refactor.
// else {
//       el.classList.remove('is-error');
//       el.classList.add('is-valid');
//     }
//   } else {
//     // optional fields: clear error if any
//     if(val.length){ el.classList.add('is-valid'); el.classList.remove('is-error'); }
//     else { el.classList.remove('is-valid'); el.classList.remove('is-error'); }
//   }
*/
}

/* Debounced preview/validation updates */
var updateAllPreviewsDebounced = debounce(function(){
  try{ if(typeof updatePreview==='function') updatePreview(); }catch(e){}
  try{ if(typeof updateTransferPreview==='function') updateTransferPreview(); }catch(e){}
  try{ if(typeof updateAuthorizationPreview==='function') updateAuthorizationPreview(); }catch(e){}
}, 200);

/* Attach listeners once DOM ready */
document.addEventListener('DOMContentLoaded', function(){
  // Delegate validation
  document.body.addEventListener('input', function(e){
    var el = e.target;
    if(['INPUT','TEXTAREA','SELECT'].includes(el.tagName)){
      validateField(el);
      updateAllPreviewsDebounced();
    }
  }, true);
  document.body.addEventListener('change', function(e){
    var el = e.target;
    if(['INPUT','TEXTAREA','SELECT'].includes(el.tagName)){
      validateField(el);
      updateAllPreviewsDebounced();
    }
  }, true);
  document.body.addEventListener('blur', function(e){
    var el = e.target;
    if(['INPUT','TEXTAREA','SELECT'].includes(el.tagName)){
      validateField(el);
    }
  }, true);

  // Build collapsible groups inside each .form-section:
  document.querySelectorAll('.form-section').forEach(function(section){
    var nodes = Array.from(section.children);
    var i = 0;
    while(i < nodes.length){
      if(nodes[i].classList && nodes[i].classList.contains('section-title')){
        var titleEl = nodes[i];
        // gather following nodes until next .section-title or end
        var group = [];
        var j = i+1;
        while(j < nodes.length && !(nodes[j].classList && nodes[j].classList.contains('section-title'))){
          group.push(nodes[j]); j++;
        }
        // wrap group
        var wrapper = document.createElement('div');
        wrapper.className = 'collapsible-group';
        // build summary row (reuse title + add chevron)
        var summary = document.createElement('div');
        summary.className = 'section-title collapsible-summary';
        // move text from titleEl
        summary.innerHTML = '<span class="title-text">'+ titleEl.textContent +'</span><span class="chev">‚ñæ</span>';
        // body
        var body = document.createElement('div');
        body.className = 'collapsible-body';
        group.forEach(function(n){ body.appendChild(n); });

        // replace old title with summary+body
        section.insertBefore(summary, titleEl);
        section.insertBefore(body, titleEl.nextSibling);
        section.removeChild(titleEl);

        // default behavior: first 1-2 groups expanded; later groups collapsed
        var groups = section.querySelectorAll('.collapsible-summary');
        var index = groups.length - 1; // current group index after insertion
        var container = document.createElement('div');
        while(body.firstChild){ container.appendChild(body.firstChild); }
        body.appendChild(container); // ensure a single body container
        // decide default collapsed state
        var groupIndex = section.querySelectorAll('.collapsible-group').length;
      }
      i++;
    }
  });

  // Set default collapsed state: keep first two summaries expanded per form-section
  document.querySelectorAll('.form-section').forEach(function(section){
    var summaries = section.querySelectorAll('.collapsible-summary');
    summaries.forEach(function(sum, idx){
      var parent = sum.parentElement;
      // Ensure .collapsible-group wrapper (if not present)
      if(!parent.classList.contains('collapsible-group')){
        var wrap = document.createElement('div'); wrap.className='collapsible-group';
        section.insertBefore(wrap, sum);
        wrap.appendChild(sum);
        var body = sum.nextElementSibling;
        if(body) wrap.appendChild(body);
      }
      if(idx >= 2){ wrap = sum.parentElement; wrap.classList.add('collapsed'); }
      sum.addEventListener('click', function(){
        sum.parentElement.classList.toggle('collapsed');
      });
    });
  });

  // Before print: expand all groups
  function expandAll(){
    document.querySelectorAll('.collapsed').forEach(function(el){ el.classList.remove('collapsed'); });
  }
  window.addEventListener('beforeprint', expandAll);
});
<\/script>


<script id="bottom-actions-js">
function handlePrimaryAction(){
  try{
    var buttons = document.querySelectorAll('.fa-primary, .ba-primary');
    buttons.forEach(function(b){ b.classList.add('loading'); b.disabled = true; });
    // Call existing print flow
    if(typeof printDocument === 'function'){ printDocument(currentTool); }
  } finally {
    // Remove loading after a short delay (simulate async done)
    setTimeout(function(){
      buttons.forEach(function(b){ b.classList.remove('loading'); b.disabled = false; });
    }, 1200);
  }
}

// Toggle "more" menu
document.addEventListener('click', function(e){
  var trg = e.target;
  var isTrigger = trg.classList && trg.classList.contains('more-trigger');
  document.querySelectorAll('.more-menu').forEach(function(menu){
    // Close all by default
    menu.setAttribute('aria-hidden', 'true');
  });
  if(isTrigger){
    var wrap = trg.parentElement;
    var menu = wrap.querySelector('.more-menu');
    var expanded = trg.getAttribute('aria-expanded') === 'true';
    trg.setAttribute('aria-expanded', expanded ? 'false' : 'true');
    if(menu){ menu.setAttribute('aria-hidden', expanded ? 'true' : 'false'); }
    e.stopPropagation();
  }
});

function scrollToTop(){ window.scrollTo({top:0, behavior:'smooth'}); }
function scrollToBottom(){ window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'}); }
<\/script>


<script id="ux-improvements-js">
document.addEventListener('DOMContentLoaded', function(){

  /* Reserve helper text in all form-groups */
  document.querySelectorAll('.form-group').forEach(function(g){
    if(!g.querySelector('.helper-text')){
      var span = document.createElement('span');
      span.className = 'helper-text';
      span.textContent = ''; // placeholder
      g.appendChild(span);
    }
  });

  /* Collapsible: animate height instead of display none */
  document.querySelectorAll('.collapsible-summary').forEach(function(sum){
    sum.addEventListener('click', function(){
      var wrap = sum.parentElement; // .collapsible-group
      var body = sum.nextElementSibling;
      if(!body) return;
      var expanded = !wrap.classList.contains('collapsed');
      if(expanded){
        // collapse
        body.style.height = body.scrollHeight + 'px';
        requestAnimationFrame(function(){ body.style.height = '0px'; });
        wrap.classList.add('collapsed');
      }else{
        // expand
        body.style.height = '0px';
        wrap.classList.remove('collapsed');
        requestAnimationFrame(function(){ body.style.height = body.scrollHeight + 'px'; });
      }
      // clean inline height after animation
      setTimeout(function(){ if(!wrap.classList.contains('collapsed')) body.style.height = 'auto'; }, 210);
    });
  });

  /* Mobile native date picker proxy for dd/mm/yyyy inputs */
  var coarse = window.matchMedia && window.matchMedia('(pointer: coarse)').matches;
  var dateIds = ['contractDate','transferContractDate','authorizationDate'];
  if(coarse){
    dateIds.forEach(function(id){
      var txt = document.getElementById(id);
      if(txt && txt.tagName === 'INPUT' && txt.type === 'text'){
        // create calendar button + hidden date input
        var group = txt.closest('.date-input-group') || txt.parentElement;
        if(!group) group = txt.parentElement;
        var btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = 'üìÖ';
        btn.setAttribute('aria-label', 'Ch·ªçn ng√†y');
        btn.style.marginLeft = '6px';
        btn.style.padding = '8px 10px';
        btn.style.border = '1px solid #e5e7eb';
        btn.style.borderRadius = '6px';
        btn.style.background = '#fff';
        btn.style.cursor = 'pointer';

        var proxy = document.createElement('input');
        proxy.type = 'date';
        proxy.style.position = 'absolute';
        proxy.style.left = '-9999px';
        proxy.style.width = '1px';
        proxy.style.height = '1px';
        proxy.tabIndex = -1;

        // sync flows
        btn.addEventListener('click', function(){ proxy.showPicker ? proxy.showPicker() : proxy.click(); });
        proxy.addEventListener('change', function(){
          var v = proxy.value; // yyyy-mm-dd
          if(v){
            var d = new Date(v);
            if(!isNaN(d)){
              var dd = String(d.getDate()).padStart(2,'0');
              var mm = String(d.getMonth()+1).padStart(2,'0');
              var yy = d.getFullYear();
              txt.value = dd + '/' + mm + '/' + yy;
              txt.dispatchEvent(new Event('input', {bubbles:true}));
              txt.dispatchEvent(new Event('change', {bubbles:true}));
            }
          }
        });

        group.appendChild(btn);
        group.appendChild(proxy);
      }
    });
  }
});
<\/script>


<script id="ux-icon-bind-now">
document.addEventListener('DOMContentLoaded', function(){
  var inputs = document.querySelectorAll('input, textarea, select');
  inputs.forEach(function(el){
    // Immediate icon update on input/change without debounce
    el.addEventListener('input', function(){ try{ validateField(el); }catch(e){} }, false);
    el.addEventListener('change', function(){ try{ validateField(el); }catch(e){} }, false);
    // Initial validation state
    try{ validateField(el); }catch(e){}
  });
});
<\/script>


<script id="ux-vicon-abs-js">
(function(){
  function ensureVicon(el){
    var group = el.closest('.form-group');
    if(!group) return null;
    var v = group.querySelector('.vicon');
    if(!v){
      v = document.createElement('span');
      v.className = 'vicon';
      group.appendChild(v);
    }
    return v;
  }

  // Wrap original validateField to also control the vicon
  var _vf = typeof validateField === 'function' ? validateField : function(){};
  window.validateField = function(el){
    try{ _vf(el); }catch(e){}
    var v = ensureVicon(el);
    if(!v) return;
    var val = (el.value || '').trim();
    if(val.length === 0){
      v.classList.remove('ok','err');
      return;
    }
    if(el.classList.contains('is-error')){
      v.classList.add('err'); v.classList.remove('ok');
    }else if(el.classList.contains('is-valid')){
      v.classList.add('ok'); v.classList.remove('err');
    }else{
      v.classList.remove('ok','err');
    }
  };

  document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('input, textarea, select').forEach(function(el){
      // Initial
      validateField(el);
      // Listeners
      el.addEventListener('input', function(){ validateField(el); }, false);
      el.addEventListener('change', function(){ validateField(el); }, false);
      el.addEventListener('blur', function(){ validateField(el); }, false);
    });
  });
})();
<\/script>


<script id="ux-vicon-inline-svg-js">
(function(){
  var OK_SVG = "<svg viewBox='0 0 16 16' xmlns='http://www.w3.org/2000/svg'><path fill='#34d399' d='M13.485 1.929a1 1 0 010 1.414l-7.071 7.071-3.536-3.536a1 1 0 011.414-1.414l2.122 2.121 5.657-5.657a1 1 0 011.414 0z'/></svg>";
  var ERR_SVG = "<svg viewBox='0 0 16 16' xmlns='http://www.w3.org/2000/svg'><path fill='#ef4444' d='M4.222 3.515a1 1 0 011.415 0L8 5.879l2.364-2.364a1 1 0 111.415 1.414L9.414 7.293l2.365 2.364a1 1 0 01-1.415 1.415L8 8.707l-2.364 2.365a1 1 0 01-1.415-1.415L6.586 7.293 4.222 4.93a1 1 0 010-1.415z'/></svg>";

  function ensureVicon(el){
    var group = el.closest('.form-group');
    if(!group) return null;
    var v = group.querySelector('.vicon');
    if(!v){
      v = document.createElement('span');
      v.className = 'vicon';
      group.appendChild(v);
    }
    return v;
  }

  var _vf = typeof validateField === 'function' ? validateField : function(){};
  window.validateField = function(el){
    try{ _vf(el); }catch(e){}
    var v = ensureVicon(el);
    if(!v) return;
    var val = (el.value || '').trim();
    if(!val){
      v.classList.remove('show');
      v.innerHTML = "";
      return;
    }
    if(el.classList.contains('is-error')){
      v.innerHTML = ERR_SVG; v.classList.add('show');
    }else if(el.classList.contains('is-valid')){
      v.innerHTML = OK_SVG; v.classList.add('show');
    }else{
      v.classList.remove('show'); v.innerHTML = "";
    }
  };

  document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('input, textarea, select').forEach(function(el){
      validateField(el);
      el.addEventListener('input', function(){ validateField(el); }, false);
      el.addEventListener('change', function(){ validateField(el); }, false);
      el.addEventListener('blur', function(){ validateField(el); }, false);
    });
  });
})();
<\/script>








<script id="vicon-text-fallback-js">
(function(){
  // force text fallback rendering regardless of SVG support
  var _vf = window.validateField;
  window.validateField = function(el){
    try{ _vf && _vf(el); }catch(e){}
    var group = el.closest('.form-group');
    if(!group) return;
    var v = group.querySelector('.vicon');
    if(!v){ v = document.createElement('span'); v.className='vicon'; group.appendChild(v); }
    var val = (el.value || '').trim();
    if(!val){ v.innerHTML=''; return; }
    if(el.classList.contains('is-error')){
      v.innerHTML = '<span class="vtxt err">‚úó</span>';
    }else if(el.classList.contains('is-valid')){
      v.innerHTML = '<span class="vtxt ok">‚úì</span>';
    }else{
      v.innerHTML='';
    }
  };

  // Attach immediate listeners
  function bindAll(){
    document.querySelectorAll('input, textarea, select').forEach(function(el){
      validateField(el);
      el.addEventListener('input', function(){ validateField(el); });
      el.addEventListener('change', function(){ validateField(el); });
      el.addEventListener('blur', function(){ validateField(el); });
    });
  }
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', bindAll); } else { bindAll(); }
  setTimeout(bindAll, 600);
})();
<\/script>


<!-- A11y floating controls -->


  <div class="row"><span>Show tap targets (44px)</span><input id="tg-tap" type="checkbox" class="switch"></div>
</div>



<script id="mobile-gestures-only-js">
(function(){
  var order = ['tool1','tool2','tool3'];
  function idx(){ return Math.max(0, order.indexOf(window.currentTool || 'tool1')); }
  function go(delta){
    var i = idx() + delta;
    if(i < 0) i = 0;
    if(i > order.length-1) i = order.length-1;
    var id = order[i];
    var btn = document.querySelectorAll('.tablink')[i];
    if(typeof showTool === 'function'){ showTool(id, btn); }
  }
  // Swipe
  var startX=0, startY=0, tracked=false, threshold=60;
  var area = document.querySelector('.container') || document.body;
  area.addEventListener('touchstart', function(e){
    if(!e.touches || !e.touches[0]) return;
    startX = e.touches[0].clientX; startY = e.touches[0].clientY; tracked = true;
  }, {passive:true});
  area.addEventListener('touchmove', function(e){
    if(!tracked || !e.touches || !e.touches[0]) return;
    var dx = e.touches[0].clientX - startX;
    var dy = e.touches[0].clientY - startY;
    if(Math.abs(dy) > Math.abs(dx)) tracked = false; // vertical scroll dominates
  }, {passive:true});
  area.addEventListener('touchend', function(e){
    if(!tracked) return;
    var t = (e.changedTouches && e.changedTouches[0]) || null;
    var dx = t ? t.clientX - startX : 0;
    if(Math.abs(dx) >= threshold){ if(dx < 0) go(+1); else go(-1); }
    tracked = false;
  });
  // Keyboard (desktop)
  document.addEventListener('keydown', function(e){
    var t = e.target && e.target.tagName;
    if(t && /INPUT|TEXTAREA|SELECT/.test(t)) return;
    if(e.key === 'ArrowRight') go(+1);
    if(e.key === 'ArrowLeft') go(-1);
  });
})();
<\/script>



<script id="showtool-mobile-default-patch">
(function(){
  var _origShowTool = window.showTool;
  window.showTool = function(id, btn){
    // Hide all tools
    document.querySelectorAll('.tool-content').forEach(function(el){ el.style.display = 'none'; });
    var el = document.getElementById(id);
    if(el){ 
      el.style.display = 'block'; 
      // Ensure a default view on mobile so content is visible
      if(!el.getAttribute('data-view')){ el.setAttribute('data-view','form'); }
      // Update mobile-switch active states for this tool
      var sw = document.querySelector('.mobile-switch[data-tool="'+id+'"]');
      if(sw){
        sw.querySelectorAll('.switch-btn').forEach(function(b){ b.classList.remove('active'); });
        var first = sw.querySelector('.switch-btn'); 
        if(first) first.classList.add('active');
      }
    }
    window.currentTool = id;
    // Active state on tabs
    document.querySelectorAll('.tablink').forEach(function(b){ b.classList.remove('active'); });
    if(btn){ btn.classList.add('active'); }

    // Call original if exists
    try{ if(typeof _origShowTool === 'function'){ _origShowTool(id, btn); } }catch(e){}

    // Update progress bar if function exists
    try{ if(typeof updateProgress === 'function'){ updateProgress(); } }catch(e){}
  };
})();
<\/script>

</body></html>`
;
    return doc;
  }

  async function shareHTML(){
    // Ensure latest content is in print modal placeholder
    if(typeof window.openPrintModal === 'function'){ window.openPrintModal(window.currentTool || 'tool1'); }
    // Small delay to allow preview fill
    await new Promise(r=>setTimeout(r, 80));
    const html = buildPrintableHTML();
    const blob = new Blob([html], {type:'text/html'});
    const fileName = 'BienBan-' + new Date().toISOString().slice(0,19).replace(/[:T]/g,'-') + '.html';
    const file = new File([blob], fileName, {type:'text/html'});

    if (navigator.canShare && navigator.canShare({ files: [file] })) {
      try {
        await navigator.share({ files:[file], title:'Bi√™n b·∫£n', text:'Chia s·∫ª bi√™n b·∫£n' });
        return true;
      } catch (err) {
        // user cancelled or share failed ‚Äî fallback to print
      }
    }
    // Fallback to print
    window.print();
    return false;
  }

  window.shareFromModal = function(){ shareHTML(); };
  window.shareOrPrint = function(){ shareHTML(); };
})();

// === Mobile switch helpers ===
(function(){
  function qsInTool(sel){
    const tool = (window.currentTool || 'tool1');
    const toolEl = document.getElementById(tool);
    if(!toolEl) return null;
    return toolEl.querySelector(sel);
  }

  window.scrollToForm = function(){
    // Prefer the first visible .form-section in current tool
    const el = qsInTool('.form-section') || document.querySelector('.form-section');
    if(el){ el.scrollIntoView({behavior:'smooth', block:'start'}); }
    else { window.scrollTo({top:0, behavior:'smooth'}); }
  };

  window.scrollToPreview = function(){
    const el = qsInTool('.preview-section') || document.querySelector('.preview-section');
    if(el){ el.scrollIntoView({behavior:'smooth', block:'start'}); }
  };
})();
</script>


<!-- Settings Modal -->
<div id="settingsModal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
  <div class="modal-card">
    <div class="modal-head">
      <h3 id="settingsTitle">‚öôÔ∏è C√†i ƒë·∫∑t</h3>
      <button class="btn muted" onclick="closeSettings()">‚úï ƒê√≥ng</button>
    </div>
    <div class="modal-body">
      <h4 style="margin:0 0 8px 0;">Qu·∫£n l√Ω d·ªØ li·ªáu</h4>
      <p style="margin-top:0;color:#555;">Ch·ªçn ph·∫°m vi thao t√°c v·ªõi d·ªØ li·ªáu nh√°p ƒëang l∆∞u tr√™n thi·∫øt b·ªã n√†y.</p>
      <div style="display:grid;grid-template-columns:1fr;gap:10px;">
        <div class="card" style="border:1px solid #e5e7eb;border-radius:10px;padding:12px;">
          <div style="font-weight:600;margin-bottom:6px;">ƒê·∫∑t l·∫°i bi·ªÉu m·∫´u (tab hi·ªán t·∫°i)</div>
          <div style="color:#555;margin-bottom:8px;">X√≥a d·ªØ li·ªáu ƒëang nh·∫≠p c·ªßa tab ƒëang m·ªü, kh√¥ng ·∫£nh h∆∞·ªüng tab kh√°c.</div>
          <button class="btn" onclick="resetCurrentTab()">‚Ü∫ ƒê·∫∑t l·∫°i tab n√†y</button>
        </div>
        <div class="card" style="border:1px solid #e5e7eb;border-radius:10px;padding:12px;">
          <div style="font-weight:600;margin-bottom:6px;">X√≥a b·∫£n nh√°p (to√†n b·ªô)</div>
          <div style="color:#555;margin-bottom:8px;">X√≥a m·ªçi d·ªØ li·ªáu nh√°p ƒë√£ l∆∞u cho t·∫•t c·∫£ c√°c tab. B·∫°n c√≥ th·ªÉ nh·∫≠p l·∫°i t·ª´ ƒë·∫ßu.</div>
          <button class="btn danger" onclick="clearAllDrafts()">üßπ X√≥a to√†n b·ªô nh√°p</button>
        </div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="closeSettings()">ƒê√≥ng</button>
    </div>
  </div>
</div>


<script>
(function(){
  window.openSettings = function(){
    var m = document.getElementById('settingsModal');
    if(m){ m.style.display='block'; document.body.style.overflow='hidden'; }
  };
  window.closeSettings = function(){
    var m = document.getElementById('settingsModal');
    if(m){ m.style.display='none'; document.body.style.overflow='auto'; }
  };
  window.resetCurrentTab = function(){
    if(!confirm('ƒê·∫∑t l·∫°i d·ªØ li·ªáu c·ªßa tab ƒëang m·ªü?')) return;
    var tool = (window.currentTool || 'tool1');
    var scope = document.getElementById(tool) || document;
    scope.querySelectorAll('input, textarea, select').forEach(function(el){
      if(el.type==='checkbox' || el.type==='radio'){ el.checked=false; }
      else if(el.tagName==='SELECT'){ el.selectedIndex=0; }
      else { el.value=''; }
      el.dispatchEvent(new Event('input',{bubbles:true}));
      el.dispatchEvent(new Event('change',{bubbles:true}));
    });
    if(typeof updateAllPreviews==='function') try{ updateAllPreviews(); }catch(e){}
  };
  window.clearAllDrafts = function(){
    if(!confirm('X√≥a to√†n b·ªô b·∫£n nh√°p ƒë√£ l∆∞u?')) return;
    try{ localStorage.removeItem('spapp_autosave_v2'); }catch(e){}
    setTimeout(function(){ location.reload(); }, 300);
  };
})();
</script>


<!-- ====== PATCH START: Mobile Wizard + In-only ====== -->
<style>
@media print {
  html, body { background: #fff !important; }
  body * { visibility: hidden !important; }
  #printContent, #printContent * { visibility: visible !important; }
  #printContent {
    position: absolute !important; inset: 0 !important;
    width: auto !important; height: auto !important;
    margin: 0 !important; padding: 12mm !important;
    background: #fff !important; box-shadow: none !important; border: 0 !important;
  }
  .print-modal, .print-modal * { visibility: hidden !important; }
  .print-modal #printContent, .print-modal #printContent * { visibility: visible !important; }
  .print-modal-header, .print-actions, .mobile-switch,
  .tab-menu, header, nav, footer, .mw-fab, .mw-sheet {
    display: none !important;
  }
  @page { size: A4; margin: 12mm; }
}
.print-modal__backdrop{position:fixed; inset:0; background:rgba(15,23,42,.6);}
.print-modal__panel{position:fixed; inset:auto 0 0 0; background:#fff;
  border-top-left-radius:16px; border-top-right-radius:16px;
  max-height:85vh; overflow:auto; padding:12px;
  box-shadow:0 -10px 28px rgba(0,0,0,.25);}
.print-modal-header{display:flex; align-items:center; justify-content:space-between;
  gap:8px; padding:8px 4px 12px; border-bottom:1px solid #eee;}
.print-modal__content{ padding:12px 0; }

.mw-fab{
  position:fixed; right:12px; bottom:88px; z-index:10001;
  border:none; border-radius:999px; padding:12px 14px; font-weight:700;
  background:#2563eb; color:#fff; box-shadow:0 8px 20px rgba(0,0,0,.25);
}
@media (min-width:1024px){ .mw-fab{display:none} }
.mw-sheet{
  position:fixed; left:0; right:0; bottom:-100%; z-index:10002; background:#fff;
  border-top-left-radius:16px; border-top-right-radius:16px; box-shadow:0 -10px 30px rgba(0,0,0,.25);
  transition:bottom .25s ease;
}
.mw-sheet.show{ bottom:0 }
.mw-handle{ width:44px; height:5px; border-radius:999px; background:#e5e7eb; margin:10px auto }
.mw-grid{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; padding:12px }
.mw-btn{ display:flex; align-items:center; justify-content:center; border:1px solid #e5e7eb; border-radius:12px; padding:12px; font-weight:700 }
@media print{ .mw-fab, .mw-sheet{ display:none !important; } }
</style>

<div id="printModal" class="print-modal" style="display:none;">
  <div class="print-modal__backdrop"></div>
  <div class="print-modal__panel">
    <div class="print-modal-header">
      <strong>Xem tr∆∞·ªõc ƒë·ªÉ In / PDF</strong>
      <div class="print-actions">
        <button type="button" class="btn" onclick="closePrintModal()">ƒê√≥ng</button>
        <button type="button" class="btn btn-primary" onclick="printFromModal()">üñ®Ô∏è In</button>
      </div>
    </div>
    <div id="printContent" class="print-modal__content">
      <p>(Ch∆∞a c√≥ n·ªôi dung ‚Äì b·∫•m in t·ª´ m√†n h√¨nh Preview c·ªßa t·ª´ng tool)</p>
    </div>
  </div>
</div>

<button class="mw-fab" id="mwOpenBtn">üì± Mobile¬†Wizard</button>
<div class="mw-sheet" id="mwSheet" aria-hidden="true">
  <div class="mw-handle"></div>
  <div class="mw-grid">
    <button class="mw-btn" id="mwForm">üìù Nh·∫≠p li·ªáu</button>
    <button class="mw-btn" id="mwPreview">üëÅÔ∏è Xem tr∆∞·ªõc</button>
    <button class="mw-btn" id="mwPdf">‚¨áÔ∏è T·∫£i PDF</button>
  </div>
</div>

<script>
function openPrintModal(toolId){
  var source =
    toolId === 'tool1' ? document.getElementById('documentPreview') :
    toolId === 'tool2' ? document.getElementById('transferDocumentPreview') :
    toolId === 'tool3' ? document.getElementById('authorizationDocumentPreview') :
    null;
  var target = document.getElementById('printContent');
  if (target) {
    target.innerHTML = source ? source.innerHTML : '<p>(Kh√¥ng c√≥ n·ªôi dung ƒë·ªÉ in)</p>';
  }
  var modal = document.getElementById('printModal');
  if (modal) modal.style.display = 'block';
}
function printFromModal(){ window.print(); }
function closePrintModal(){
  var modal = document.getElementById('printModal');
  if (modal) modal.style.display = 'none';
}

(function(){
  function safeOpenPrintModal(toolId){
    if(typeof window.openPrintModal === 'function'){ return window.openPrintModal(toolId); }
    if(typeof window.printDocument === 'function'){ return window.printDocument(toolId); }
    window.print();
  }
  function safeSetView(toolId, view){
    if(typeof window.setToolView === 'function'){ return window.setToolView(toolId, view); }
    var tool = document.getElementById(toolId);
    if(tool){ tool.setAttribute('data-view', view==='preview'?'preview':'form'); }
  }

  var openBtn = document.getElementById('mwOpenBtn');
  var sheet = document.getElementById('mwSheet');
  function toggleSheet(show){
    if(!sheet) return;
    if(show){ sheet.classList.add('show'); sheet.setAttribute('aria-hidden','false'); }
    else{ sheet.classList.remove('show'); sheet.setAttribute('aria-hidden','true'); }
  }
  if(openBtn) openBtn.addEventListener('click', function(){ toggleSheet(true); });
  if(sheet) sheet.addEventListener('click', function(e){ if(e.target===sheet) toggleSheet(false); });

  function current(){ return window.currentTool || 'tool1'; }
  var btnForm = document.getElementById('mwForm');
  var btnPreview = document.getElementById('mwPreview');
  var btnPdf = document.getElementById('mwPdf');

  if(btnForm) btnForm.addEventListener('click', function(){ safeSetView(current(), 'form'); toggleSheet(false); });
  if(btnPreview) btnPreview.addEventListener('click', function(){ safeSetView(current(), 'preview'); toggleSheet(false); });
  if(btnPdf) btnPdf.addEventListener('click', function(){ safeOpenPrintModal(current()); toggleSheet(false); });

  document.addEventListener('click', function(e){
    var t = e.target;
    if(!(t instanceof HTMLElement)) return;
    var txt = (t.innerText || '').trim().toLowerCase();
    var isPrint = t.matches('[onclick*="printDocument"]')
               || t.matches('[onclick*="openPrintModal"]')
               || txt.includes('t·∫£i pdf') || txt.includes('in ngay') || txt.includes('in t√†i li·ªáu');
    var isPreviewFull = txt.includes('xem tr∆∞·ªõc to√†n m√†n h√¨nh');
    if(isPrint || isPreviewFull){
      e.preventDefault();
      e.stopPropagation();
      safeOpenPrintModal(current());
    }
  }, true);
})();
</script>
<!-- ====== PATCH END ====== -->

<!-- D2 step 1-2: Mobile Wizard Debounce + Date Mask (safe, scoped) -->
<style id="mw-d2-12-style">
/* Kh√¥ng ƒë·ªïi giao di·ªán. Ch·ªâ th√™m vi·ªÅn nh·∫π khi thi·∫øu (ƒë∆∞·ª£c d√πng ·ªü b∆∞·ªõc sau). */
/* (Kh√¥ng k√≠ch ho·∫°t highlight ·ªü b∆∞·ªõc n√†y ƒë·ªÉ tr√°nh ·∫£nh h∆∞·ªüng) */
</style>
<script id="mw-d2-12-script">
(function(){
  // Guard against double-inject
  if(window.__mw_d2_12_loaded__) return;
  window.__mw_d2_12_loaded__ = true;

  // --- Utilities ---
  function ready(fn){ (document.readyState==='loading') ? document.addEventListener('DOMContentLoaded', fn) : fn(); }
  function isMobileWizardActive(){
    // Mobile wizard = khi thanh .mobile-switch ƒëang hi·ªÉn th·ªã ho·∫∑c m√†n h√¨nh <= 1023px
    var mw = document.querySelector('.mobile-switch');
    var mwVisible = false;
    if(mw){
      var cs = getComputedStyle(mw);
      mwVisible = cs && cs.display !== 'none';
    }
    var narrow = window.matchMedia && window.matchMedia('(max-width: 1023px)').matches;
    return !!(mwVisible || narrow);
  }

  // --- (1) Debounce c·∫≠p nh·∫≠t preview ---
  var _updTimer = null, _updDelay = 260;
  function safeUpdateAllPreviews(){
    if(typeof window.updateAllPreviews !== 'function') return;
    if(!isMobileWizardActive()){ 
      // v·∫´n cho ph√©p c·∫≠p nh·∫≠t nh∆∞ng kh√¥ng spam
      clearTimeout(_updTimer);
      _updTimer = setTimeout(function(){ try{ window.updateAllPreviews(); }catch(e){} }, _updDelay);
      return;
    }
    clearTimeout(_updTimer);
    _updTimer = setTimeout(function(){ try{ window.updateAllPreviews(); }catch(e){} }, _updDelay);
  }

  // --- (2) Mask ng√†y dd/mm/yyyy cho input text ---
  function isDateLike(el){
    var idn  = (el.id||'').toLowerCase();
    var name = (el.name||'').toLowerCase();
    var ph   = (el.placeholder||'').toLowerCase();
    return /date|ngay|ng√†y/.test(idn + name) || /dd\s*\/\s*mm\s*\/\s*yyyy/.test(ph);
  }
  function maskDate(el){
    // Ch·ªâ √°p d·ª•ng cho text input ƒë·ªÉ kh√¥ng ph√° type="date"
    if(el.tagName!=='INPUT' || (el.type && el.type.toLowerCase()!=='text')) return;
    var v = (el.value||'').replace(/[^\d]/g,'').slice(0,8);
    if(v.length>=5) v = v.replace(/^(\d{2})(\d{2})(\d{0,4}).*/,'$1/$2/$3');
    else if(v.length>=3) v = v.replace(/^(\d{2})(\d{0,2}).*/,'$1/$2');
    el.value = v;
  }
  function attachDateMask(scope){
    (scope||document).querySelectorAll('input[type="text"], input:not([type])').forEach(function(el){
      if(!isDateLike(el)) return;
      if(el.dataset.mwDateMasked) return;
      el.addEventListener('input', function(){ maskDate(el); safeUpdateAllPreviews(); });
      el.addEventListener('blur',  function(){ maskDate(el); safeUpdateAllPreviews(); });
      el.dataset.mwDateMasked = "1";
    });
  }

  // Attach input listeners once
  function attachInputListeners(scope){
    (scope||document).querySelectorAll('input, textarea, select').forEach(function(el){
      if(el.dataset.mwD212) return;
      el.addEventListener('input',  safeUpdateAllPreviews);
      el.addEventListener('change', safeUpdateAllPreviews);
      el.dataset.mwD212 = "1";
    });
  }

  function init(){
    // Ch·ªâ ch·∫°y khi giao di·ªán mobile wizard ho·∫°t ƒë·ªông (ho·∫∑c m√†n h√¨nh h·∫πp)
    attachInputListeners();
    attachDateMask();
    // G·ªçi m·ªôt l·∫ßn ƒë·ªÉ ƒë·∫£m b·∫£o preview ƒë·ªìng b·ªô
    if(typeof window.updateAllPreviews === 'function'){
      try{ window.updateAllPreviews(); }catch(e){}
    }
    // N·∫øu user chuy·ªÉn tool/view th√¨ v·∫´n gi·ªØ debounce
    var mo = new MutationObserver(function(){ attachInputListeners(); attachDateMask(); });
    mo.observe(document.documentElement, {subtree:true, childList:true, attributes:true});
  }

  ready(init);
})();
</script>

<style id="mw-step3-missing-style">
/* Step 3 ‚Äî Highlight tr∆∞·ªùng thi·∫øu (Mobile Wizard) */
.hl-field-missing{
  background: #fff9e6 !important;          /* v√†ng nh·∫°t d·ªÖ nh√¨n */
  outline: 2px dashed #f1c40f !important;
  outline-offset: 2px !important;
  transition: background .15s ease, outline .15s ease;
}
/* Kh√¥ng in highlight ra PDF/print */
@media print{
  .hl-field-missing{ background: transparent !important; outline: none !important; }
}
</style>

<script id="mw-step3-missing-script">
(function(){
  if(window.__mw_step3_loaded__) return;
  window.__mw_step3_loaded__ = true;

  function ready(fn){ (document.readyState==='loading')?document.addEventListener('DOMContentLoaded',fn):fn(); }

  // Ch·ªâ ch·∫°y khi giao di·ªán mobile wizard ƒëang d√πng (c√≥ thanh switch ho·∫∑c m√†n h√¨nh h·∫πp)
  function isMobileWizardActive(){
    var sw = document.querySelector('.mobile-switch');
    var visible = false;
    if(sw){
      var cs = getComputedStyle(sw);
      visible = cs && cs.display !== 'none';
    }
    var narrow = (window.matchMedia && window.matchMedia('(max-width: 1023px)').matches) || false;
    return !!(visible || narrow);
  }

  function isRequired(el){
    // required tr·ª±c ti·∫øp ho·∫∑c aria-required
    return el && (el.hasAttribute('required') || el.getAttribute('aria-required') === 'true');
  }

  function isEmpty(el){
    if(!el) return true;
    // v·ªõi select, coi "" l√† tr·ªëng
    if(el.tagName === 'SELECT') return !(el.value && (''+el.value).trim());
    // input/textarea
    var v = (el.value || '').trim();
    return v.length === 0;
  }

  function markMissing(el){
    if(!isMobileWizardActive()) { el.classList.remove('hl-field-missing'); return; }
    if(isRequired(el) && isEmpty(el)) el.classList.add('hl-field-missing');
    else el.classList.remove('hl-field-missing');
  }

  function scanAndMark(scope){
    (scope||document).querySelectorAll('input, textarea, select').forEach(function(el){
      if(isRequired(el)) markMissing(el);
    });
  }

  function attachListeners(scope){
    (scope||document).querySelectorAll('input, textarea, select').forEach(function(el){
      if(el.dataset.mwStep3) return;
      el.addEventListener('blur', function(){ markMissing(el); }, true);
      el.addEventListener('change', function(){ markMissing(el); }, true);
      // ƒë√°nh gi√° l·∫°i khi nh·∫≠p
      el.addEventListener('input', function(){ if(el.classList.contains('hl-field-missing')) markMissing(el); }, true);
      el.dataset.mwStep3 = "1";
    });
  }

  function init(){
    attachListeners();
    scanAndMark();
    // Theo d√µi DOM m·ªõi th√™m
    var mo = new MutationObserver(function(muts){
      muts.forEach(function(m){
        if(m.addedNodes && m.addedNodes.length){
          m.addedNodes.forEach(function(n){
            if(n.nodeType !== 1) return;
            attachListeners(n);
            scanAndMark(n);
          });
        }
      });
    });
    mo.observe(document.body, {childList:true, subtree:true});
    // Re-scan khi thay ƒë·ªïi tool/view (data-view) ƒë·ªÉ ·∫©n highlight n·∫øu tho√°t mobile wizard
    var moAttr = new MutationObserver(function(){ scanAndMark(); });
    moAttr.observe(document.documentElement, {attributes:true, attributeFilter:['data-view'], subtree:true});
    // Re-evaluate on resize (switch mobile/desktop)
    window.addEventListener('resize', function(){ scanAndMark(); });
  }

  ready(init);
})();
</script>

<!-- === SMART POSITIONING + STICKY HEADER FALLBACK (2025-08-14) === -->
<style id="smart-positioning-css">
  :root{ --kb: 0px; }
  @media (max-width:1023px){
    body{ padding-bottom: calc(92px + var(--kb)) !important; }
    .mobile-switch{
      position: fixed !important;
      left: 0; right: 0; bottom: 0;
      transform: translateY(calc(-1 * var(--kb)));
      z-index: 10001;
      background: rgba(255,255,255,0.96);
      -webkit-
      
      border-top: 1px solid #e5e7eb;
      padding: 10px;
    }
    .mobile-switch .switch-btn, .mobile-switch .btn{ min-height: 44px; }
  }
  #fallbackHeaderActions{
    display:none; position: sticky; top: 0; z-index: 10002;
    background: #0f172a; padding: 8px; gap: 8px; justify-content: center;
  }
  #fallbackHeaderActions .switch-btn{
    color:#fff; background:#1e293b; border:1px solid #334155; border-radius:10px; padding:10px 12px; font-weight:600;
  }
  @media print{ #fallbackHeaderActions,.mobile-switch{ display:none !important; } body{ padding-bottom:0 !important; } }
</style>
<script id="smart-positioning-js">
(function(){
  if (window.__SMART_POS_APPLIED__) return; window.__SMART_POS_APPLIED__=true;
  function ensureFallbackBar(){
    if(document.getElementById('fallbackHeaderActions')) return;
    var header = document.querySelector('.header') || document.body.firstElementChild || document.body;
    var bar = document.createElement('div');
    bar.id='fallbackHeaderActions'; bar.className='action-bar'; bar.style.display='none';
    bar.innerHTML = ''
      + '<button class="switch-btn" onclick="setToolView(window.currentTool||\'tool1\',\'form\')" type="button">üìù Nh·∫≠p li·ªáu</button>'
      + '<button class="switch-btn" onclick="setToolView(window.currentTool||\'tool1\',\'preview\')" type="button">üëÅÔ∏è Xem tr∆∞·ªõc</button>'
      + '<button class="switch-btn" onclick="printDocument(window.currentTool||\'tool1\')" type="button">‚¨áÔ∏è T·∫£i PDF</button>';
    if (header && header.parentNode){ header.parentNode.insertBefore(bar, header.nextSibling); }
    else { document.body.insertBefore(bar, document.body.firstChild); }
  }
  function setKB(px){ document.documentElement.style.setProperty('--kb', (px||0)+'px'); }
  function applyVV(){
    var vv = window.visualViewport;
    if(!vv){ ensureFallbackBar(); var fb = document.getElementById('fallbackHeaderActions'); if (fb) fb.style.display='flex'; return; }
    function update(){
      var kb = Math.max(0, (window.innerHeight - vv.height - vv.offsetTop));
      setKB(kb);
      var fb = document.getElementById('fallbackHeaderActions'); if (fb) fb.style.display='none';
      if (kb>0 && document.activeElement && /INPUT|TEXTAREA|SELECT/.test(document.activeElement.tagName)){
        try{ document.activeElement.scrollIntoView({block:'center', behavior:'smooth'});}catch(e){}
      }
    }
    vv.addEventListener('resize', update);
    vv.addEventListener('scroll', update);
    window.addEventListener('orientationchange', update);
    window.addEventListener('resize', update);
    document.addEventListener('focusin', function(){ setTimeout(update, 80); setTimeout(update, 220); });
    update();
  }
  var _origShowTool = window.showTool;
  window.showTool = function(id, btn){ window.currentTool = id; if(typeof _origShowTool==='function') try{_origShowTool(id, btn);}catch(e){} };
  if(!window.currentTool){ var first = document.querySelector('.tool-content'); if(first) window.currentTool = first.id || 'tool1'; }
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', applyVV); } else { applyVV(); }
})();
</script>

<!-- === SWIPE NAVIGATION (2025-08-14) === -->
<script id="swipe-nav-js">
(function(){
  if (window.__SWIPE_NAV_APPLIED__) return; window.__SWIPE_NAV_APPLIED__ = true;

  var ENABLE_MAX_WIDTH = 1023;          // only enable on mobile/tablet
  var THRESHOLD_X = 50;                 // min horizontal distance (px)
  var MAX_ANGLE_Y = 40;                 // cancel if vertical move exceeds 40px
  var startX = 0, startY = 0, active = false, tracking = false;

  function isMobile(){ return window.matchMedia && window.matchMedia('(max-width: '+ENABLE_MAX_WIDTH+'px)').matches; }

  function getOrder(){
    // Map the tab order
    return ['tool1','tool2','tool3'].filter(function(id){ return !!document.getElementById(id); });
  }

  function getCurrentIndex(){
    var order = getOrder();
    var cur = window.currentTool;
    if(!cur){
      // guess from visible
      document.querySelectorAll('.tool-content').forEach(function(el){
        if (el.style.display !== 'none') cur = el.id;
      });
    }
    var idx = order.indexOf(cur);
    if(idx < 0) idx = 0;
    return {order: order, index: idx};
  }

  function switchTo(nextIdx){
    var info = getCurrentIndex();
    var order = info.order;
    if(nextIdx < 0 || nextIdx >= order.length) return;
    var id = order[nextIdx];
    if(typeof window.showTool === 'function'){
      // also find matching tab button if any
      var btn = document.querySelector('.tablink[data-target="'+id+'"]') || null;
      try{ window.showTool(id, btn); }catch(e){ window.showTool(id); }
    }else{
      // fallback display toggling
      order.forEach(function(t){ var el = document.getElementById(t); if(el) el.style.display = (t===id)?'block':'none'; });
      window.currentTool = id;
    }
  }

  function onTouchStart(e){
    if(!isMobile()) return;
    if(e.touches && e.touches.length === 1){
      var t = e.touches[0];
      startX = t.clientX; startY = t.clientY;
      tracking = true; active = true;
    }
  }
  function onTouchMove(e){
    if(!tracking) return;
    var t = e.touches && e.touches[0]; if(!t) return;
    var dy = Math.abs(t.clientY - startY);
    if(dy > MAX_ANGLE_Y){
      // Consider it a vertical scroll, cancel swipe tracking
      tracking = false;
    }
  }
  function onTouchEnd(e){
    if(!active) return;
    active = false;
    if(!isMobile()) return;
    if(!tracking) { tracking = false; return; }

    var t = (e.changedTouches && e.changedTouches[0]) || null;
    if(!t) return;
    var dx = t.clientX - startX;
    var adx = Math.abs(dx);
    if(adx < THRESHOLD_X) return;

    var info = getCurrentIndex();
    var idx = info.index;

    if(dx < 0){
      // swipe left -> next tab
      switchTo(idx + 1);
    }else{
      // swipe right -> previous tab
      switchTo(idx - 1);
    }
  }

  // Attach listeners to main content areas to avoid conflicts with global scroll
  function attachSwipeHandlers(){
    var zones = Array.prototype.slice.call(document.querySelectorAll('.tool-content'));
    if(zones.length === 0) zones = [document.body];
    zones.forEach(function(z){
      // avoid duplicate binding
      if(z.__swipeBound__) return;
      z.addEventListener('touchstart', onTouchStart, {passive:true});
      z.addEventListener('touchmove', onTouchMove, {passive:true});
      z.addEventListener('touchend', onTouchEnd, {passive:true});
      z.__swipeBound__ = true;
    });
  }

  // Keep currentTool updated when tabs change externally
  if(window.showTool){
    var _orig = window.showTool;
    window.showTool = function(id, btn){ window.currentTool = id; return _orig.apply(this, arguments); };
  }else{
    // initialize currentTool guess
    var visible = document.querySelector('.tool-content:not([style*="display: none"])');
    if(visible) window.currentTool = visible.id;
  }

  document.addEventListener('DOMContentLoaded', attachSwipeHandlers);
  // in case content is dynamically modified later
  setTimeout(attachSwipeHandlers, 300);
  window.addEventListener('resize', function(){ if(!isMobile()) return; attachSwipeHandlers(); });

})();
</script>

<!-- === REAL-TIME SYNC: Thanh l√Ω -> Chuy·ªÉn nh∆∞·ª£ng (B√™n A) + Hide Mobile Wizard (2025-08-14) === -->
<script id="realtime-sync-tl-to-transfer">
(function(){
  if (window.__SYNC_TL_TO_TRANSFER__) return; window.__SYNC_TL_TO_TRANSFER__=true;

  function hideMobileWizard(){
    var sels = ['#mobileWizardBtn','.mobile-wizard','.btn-mobile-wizard','.wizard-fab','.wizard-bubble','.mobileWizard'];
    sels.forEach(function(s){ document.querySelectorAll(s).forEach(function(n){ n.style.display='none'; }); });
    Array.prototype.slice.call(document.querySelectorAll('a,button,div')).forEach(function(el){
      var t=(el.textContent||'').trim().toLowerCase();
      if(/\bmobile\s*wizard\b/.test(t)) el.style.display='none';
    });
  }

  var MAP = [
    ['#contractNumber',            '#transferContractNumber'],
    ['#contractDate',              '#transferContractDate'],
    ['#partyBName',                '#transferPartyAName'],
    ['#partyBTaxCode',             '#transferPartyATaxCode'],
    ['#partyBRepresentative',      '#transferPartyARepresentative'],
    ['#partyBPosition',            '#transferPartyAPosition'],
    ['#partyBAddress',             '#transferPartyAAddress']
  ];

  function valueOf(node){
    if(!node) return '';
    if('value' in node) return node.value || '';
    return (node.textContent||'').trim();
  }

  function setValue(node, v){
    if(!node) return;
    var old = ('value' in node) ? node.value : (node.textContent||'');
    if(old===v) return;
    if('value' in node) node.value = v;
    else node.textContent = v;
    try{ node.dispatchEvent(new Event('input', {bubbles:true})); }catch(e){}
    try{ node.dispatchEvent(new Event('change', {bubbles:true})); }catch(e){}
  }

  function syncOnce(){
    MAP.forEach(function(pair){
      var src = document.querySelector(pair[0]);
      var dst = document.querySelector(pair[1]);
      if(!src || !dst) return;
      setValue(dst, valueOf(src));
    });
  }

  function bindRealtime(){
    MAP.forEach(function(pair){
      var src = document.querySelector(pair[0]);
      if(!src || src.__syncBound__) return;
      var handler = function(){ syncOnce(); };
      src.addEventListener('input', handler);
      src.addEventListener('change', handler);
      src.__syncBound__ = true;
    });
  }

  if(typeof window.showTool === 'function'){
    var _origShowTool = window.showTool;
    window.showTool = function(id, btn){
      var r = _origShowTool.apply(this, arguments);
      if(id === 'tool2'){ syncOnce(); }
      return r;
    };
  }

  function init(){
    hideMobileWizard();
    bindRealtime();
    syncOnce();
  }

  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', init);
  else init();
  setTimeout(init, 500);
  setTimeout(hideMobileWizard, 1500);
})();
</script>

<!-- === NEXT-FIELD KEYBOARD NAV (Enter/Arrow/Tab) ‚Äî 2025-08-14 === -->
<script id="next-field-kb-nav">
(function(){
  if (window.__NEXT_FIELD_APPLIED__) return; window.__NEXT_FIELD_APPLIED__ = true;

  function visible(el){
    if (!el) return false;
    if (el.disabled) return false;
    if (el.type === 'hidden') return false;
    // Skip elements inside hidden containers
    var style = window.getComputedStyle(el);
    if (style.display === 'none' || style.visibility === 'hidden') return false;
    var cur = el;
    while (cur && cur !== document.body){
      var cs = window.getComputedStyle(cur);
      if (cs.display === 'none' || cs.visibility === 'hidden') return false;
      cur = cur.parentElement;
    }
    return true;
  }

  function getFocusableInTool(toolId){
    var container = document.getElementById(toolId) || document;
    var nodes = Array.prototype.slice.call(container.querySelectorAll('input, select, textarea, [contenteditable="true"]'));
    nodes = nodes.filter(function(el){
      if (!visible(el)) return false;
      var t = (el.tagName||'').toUpperCase();
      if (t === 'INPUT'){
        var type = (el.type||'').toLowerCase();
        if (['button','submit','reset','file','color'].indexOf(type) !== -1) return false;
      }
      return true;
    });
    return nodes;
  }

  function focusNext(delta){
    var toolId = window.currentTool || (function(){
      var visibleTool = document.querySelector('.tool-content:not([style*="display: none"])');
      return visibleTool ? visibleTool.id : 'tool1';
    })();
    var list = getFocusableInTool(toolId);
    if (list.length === 0) return;
    var active = document.activeElement;
    var idx = list.indexOf(active);
    if (idx === -1){
      idx = (delta > 0) ? 0 : list.length - 1;
    } else {
      idx = idx + delta;
      if (idx < 0) idx = 0;
      if (idx >= list.length) idx = list.length - 1;
    }
    var el = list[idx];
    if (el && typeof el.focus === 'function'){
      el.focus();
      try { el.scrollIntoView({block:'center', behavior:'smooth'}); } catch(e){}
    }
  }

  document.addEventListener('keydown', function(e){
    if (e.defaultPrevented) return;
    var tag = (e.target.tagName||'').toUpperCase();
    var isEditable = /INPUT|TEXTAREA|SELECT/.test(tag) || e.target.isContentEditable;
    if (!isEditable) return;

    // Do not interfere with modifier combos (Ctrl/Cmd/Alt)
    if (e.ctrlKey || e.metaKey || e.altKey) return;

    // Handle keys
    if (e.key === 'Enter'){
      // Allow newline in textarea; otherwise go next
      if (tag !== 'TEXTAREA'){
        e.preventDefault();
        focusNext(1);
      }
    } else if (e.key === 'ArrowDown' || (e.key === 'Tab' && !e.shiftKey)){
      e.preventDefault();
      focusNext(1);
    } else if (e.key === 'ArrowUp' || (e.key === 'Tab' && e.shiftKey)){
      e.preventDefault();
      focusNext(-1);
    }
  });
})();
</script>

<!-- === PERF PATCH JS: rAF-throttled visualViewport handler + fallback healthcheck (2025-08-14) === -->
<script id="vv-raf-throttle-20250814">
(function(){
  if (window.__VV_RAF_THROTTLE__) return; window.__VV_RAF_THROTTLE__ = true;

  // Add spacer if missing
  (function ensureSpacer(){
    if(!document.getElementById('kb-spacer')){
      var d = document.createElement('div');
      d.id = 'kb-spacer'; d.setAttribute('aria-hidden','true');
      document.body.appendChild(d);
    }
  })();

  var vv = window.visualViewport;
  if(!vv){
    // rely on existing sticky header fallback if present; nothing to do
    return;
  }

  var raf = null, lastKB = 0;
  var MIN_DELTA = 6; // px
  var dropCount = 0; var dropTimer = null;

  function scheduleUpdate(){
    if(raf) return;
    raf = requestAnimationFrame(function(){
      raf = null;
      var kb = Math.max(0, (window.innerHeight - vv.height - vv.offsetTop));
      if (Math.abs(kb - lastKB) < MIN_DELTA) return;
      lastKB = kb;
      document.documentElement.style.setProperty('--kb', kb + 'px');
      document.body.classList.toggle('kb-open', kb > 0);
      // health check: if updates happen too frequently, trigger temporary header fallback
      dropCount++;
      clearTimeout(dropTimer);
      dropTimer = setTimeout(function(){ dropCount = 0; }, 500);
      if (dropCount > 10){
        document.documentElement.style.setProperty('--kb', '0px');
        document.body.classList.add('use-header-actions');
        setTimeout(function(){ document.body.classList.remove('use-header-actions'); }, 2000);
      }
    });
  }

  vv.addEventListener('resize', scheduleUpdate, {passive:true});
  vv.addEventListener('scroll', scheduleUpdate, {passive:true});
  window.addEventListener('orientationchange', scheduleUpdate, {passive:true});
  window.addEventListener('resize', scheduleUpdate, {passive:true});
  document.addEventListener('focusin', function(){ setTimeout(scheduleUpdate, 80); setTimeout(scheduleUpdate, 220); }, {passive:true});

  scheduleUpdate();
})();
</script>
<style id="vv-raf-throttle-20250814-css">
  /* Temporary header fallback toggle (if your header actions exist) */
  .use-header-actions .mobile-switch{ display:none !important; }
  .use-header-actions #fallbackHeaderActions{ display:flex !important; }
</style>
</body>
</html>
<style id="mobile-quickwins-style">
@media (max-width: 767.98px){
  .section-title, .subsection-title, .form-sticky, .section-sticky { 
    position: static !important; top:auto !important; 
  }
  .table-scroll{ 
    overflow:auto; -webkit-overflow-scrolling: touch; 
    max-height: 60vh; 
    border-radius: 8px;
  }
  .table-scroll table{ width: 100%; }
}
.status-select{ min-width: 120px; }
.hl-field-missing{ outline: 2px dashed rgba(255,193,7,.85); outline-offset: 2px; }
</style>


<script id="mobile-quickwins">
(function(){
  function domReady(cb){
    if(document.readyState === "loading"){ document.addEventListener("DOMContentLoaded", cb); }
    else cb();
  }
  
  function unifyDates(){
    var cand = Array.prototype.slice.call(document.querySelectorAll('input')).filter(function(el){
      // Skip inputs explicitly marked to not unify dates
      if (el.hasAttribute('data-no-unify-date')) return false;
      var idn = (el.id || '').toLowerCase();
      var name = (el.name || '').toLowerCase();
      var ph = (el.placeholder || '').toLowerCase();
      var matches = /date|ngay|ng√†y/.test(idn + name) || /dd\s*\/\s*mm\s*\/\s*yyyy/.test(ph);
      // Only convert if the input is not already a manual text date field
      if (!matches) return false;
      // Convert only if current type is not text
      return el.type !== 'text';
    });
    cand.forEach(function(el){
      try{ el.type = 'date'; }catch(e){}
    });
  }
  function upgradeStatusColumn(){
    var tables = document.querySelectorAll('table');
    tables.forEach(function(tbl){
      var head = tbl.tHead && tbl.tHead.rows[0];
      if(!head) return;
      var idx = -1;
      Array.prototype.forEach.call(head.cells, function(th, i){
        if(/t[i·ªã]nh\s*tr[a·∫°]ng/i.test((th.textContent||'').trim())) idx = i;
      });
      if(idx < 0) return;
      (tbl.tBodies? Array.prototype.slice.call(tbl.tBodies) : []).forEach(function(tb){
        Array.prototype.forEach.call(tb.rows, function(tr){
          var cell = tr.cells[idx]; if(!cell) return;
          if(cell.querySelector('select.status-select')) return;
          var current = '';
          var input = cell.querySelector('input, textarea');
          if(input) current = input.value || input.getAttribute('value') || '';
          cell.innerHTML = '';
          var sel = document.createElement('select');
          sel.className = 'status-select';
          sel.innerHTML = '<option value="T·ªët">T·ªët</option><option value="B√¨nh th∆∞·ªùng">B√¨nh th∆∞·ªùng</option><option value="H·ªèng">H·ªèng</option>';
          if(/h[o·ªè]ng/i.test(current)) sel.value = 'H·ªèng';
          else if(/b[√¨i]nh|binh/i.test(current)) sel.value = 'B√¨nh th∆∞·ªùng';
          else sel.value = 'T·ªët';
          sel.required = true;
          sel.addEventListener('change', function(){ if(window.updateAllPreviews) window.updateAllPreviews(); });
          cell.appendChild(sel);
        });
      });
    });
  }
  function pairLabels(){
    document.querySelectorAll('label').forEach(function(lbl){
      if(lbl.getAttribute('for')) return;
      var control = lbl.querySelector('input,select,textarea');
      if(!control){
        var sib = lbl.nextElementSibling;
        if(sib && /^(INPUT|SELECT|TEXTAREA)$/.test(sib.tagName)) control = sib;
      }
      if(control){
        if(!control.id){
          control.id = 'f_' + Math.random().toString(36).slice(2, 9);
        }
        lbl.setAttribute('for', control.id);
      }
    });
  }
  function ensureScrollableTables(){
    document.querySelectorAll('table').forEach(function(tbl){
      if(tbl.closest('.table-scroll')) return;
      var rows = tbl.rows.length;
      var cols = tbl.rows[0] ? tbl.rows[0].cells.length : 0;
      if(rows <= 2 && cols <= 2) return;
      var wrap = document.createElement('div');
      wrap.className = 'table-scroll';
      tbl.parentNode.insertBefore(wrap, tbl);
      wrap.appendChild(tbl);
    });
  }
  function dedupePreviewButtons(){
    var previews = document.querySelectorAll('.preview, .preview-container, [id*="preview"], [class*="preview"]');
    previews.forEach(function(p){
      var buttons = Array.prototype.slice.call(p.querySelectorAll('button, a')).filter(function(b){
        var t = (b.textContent||'').trim().toLowerCase();
        return /(\bin(\s*ngay)?\b|\bchia\s*s[e·∫ª]|\bprint\b|\bshare\b)/i.test(t);
      });
      var seen = {};
      buttons.forEach(function(b){
        var key = (b.textContent||'').trim().toLowerCase();
        if(seen[key]){ b.style.display = 'none'; }
        else seen[key] = true;
      });
    });
  }
  function init(){
    /* tuneKeyboards removed */
    try{ unifyDates(); }catch(e){}
    try{ upgradeStatusColumn(); }catch(e){}
    try{ pairLabels(); }catch(e){}
    try{ ensureScrollableTables(); }catch(e){}
    try{ dedupePreviewButtons(); }catch(e){}
  }
  (document.readyState === 'loading') ? document.addEventListener('DOMContentLoaded', init) : init();
})();
</script>

<!-- Completion badge for mobile wizard -->
<style id="mobile-completion-badge-style">
  @media (max-width: 1023px){
    #completionBadge{
      position: fixed;
      top: 12px;
      right: 12px;
      background: var(--brand-green);
      color: #ffffff;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      z-index: 10001;
      display: none;
    }
  }
</style>

<!-- Completion progress container styles -->
<style id="completion-container-style">
  /* Hide the legacy floating completion badge when using the new progress container */
  #completionBadge {
    display: none !important;
  }
  /* Progress & completion container displayed below the main title. It becomes sticky
     to the top of the viewport when the page is scrolled so users always see their
     progress. */
  #completionContainer {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    font-size: 14px;
    font-weight: 600;
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    margin: 8px 0 16px;
    z-index: 10000;
    position: sticky;
    top: 0;
  }
  #completionContainer .completion-text {
    white-space: nowrap;
    color: #111827;
  }
  #completionContainer .progress-bar {
    flex: 1;
    height: 8px;
    background: #e5e7eb;
    border-radius: 6px;
    overflow: hidden;
  }
  #completionContainer .progress-bar .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--brand-green, #34d399), #4caf50);
    width: 0%;
    transition: width 0.4s ease;
  }
  /* Hide the original thin progress line on small screens to avoid duplication */
  @media (max-width: 1023px) {
    .progress-line {
      display: none;
    }
  }
</style>
<script id="mobile-completion-badge-script">
(function(){
  // Determine if mobile wizard is active based on mobile switch visibility or screen width
  function isMobileWizardActive(){
    var sw = document.querySelector('.mobile-switch');
    var visible = false;
    if(sw){
      var cs = getComputedStyle(sw);
      visible = cs && cs.display !== 'none';
    }
    var narrow = (window.matchMedia && window.matchMedia('(max-width: 1023px)').matches) || false;
    return !!(visible || narrow);
  }
  // Compute completion percentage for the currently visible form and update badge and progress bar
  function updateFormCompletion(){
    var badge = document.getElementById('completionBadge');
    // Hide the small badge on desktop or when the mobile wizard is inactive. Do not return here so
    // the completion percentage and bar continue to update for the new progress container.
    if(!isMobileWizardActive()){
      if(badge) badge.style.display = 'none';
    }
    // Create badge if it does not exist
    if(!badge){
      badge = document.createElement('div');
      badge.id = 'completionBadge';
      document.body.appendChild(badge);
    }
    // Find active tool (the one currently displayed)
    var tool = null;
    document.querySelectorAll('.tool-content').forEach(function(el){
      if(el.style.display !== 'none'){ tool = el; }
    });
    if(!tool){
      var current = window.currentTool || '';
      if(current) tool = document.getElementById(current);
    }
    if(!tool){ return; }
    // Gather relevant fields
    var fields = Array.prototype.slice.call(tool.querySelectorAll('input:not([type="hidden"]):not([disabled]), textarea:not([disabled]), select:not([disabled])'));
    var total = 0, filled = 0;
    fields.forEach(function(el){
      // Only count visible elements
      if(!(el.offsetParent !== null)) return;
      total++;
      var val = '';
      if(el.tagName === 'SELECT') val = el.value || '';
      else val = (el.value || '').trim();
      if(val) filled++;
    });
    var percent = total ? Math.round((filled/total) * 100) : 0;
    badge.textContent = 'Ho√†n t·∫•t ' + percent + '%';
    badge.style.display = 'block';
    // Update progress bar width to reflect completion percentage
    var progress = document.getElementById('progressFill');
    if(progress){ progress.style.width = percent + '%'; }

    // Also update the new completion container elements
    var pctEl = document.getElementById('completionPercentText');
    var barEl = document.getElementById('completionProgressFill');
    if(pctEl) { pctEl.textContent = percent + '%'; }
    if(barEl) { barEl.style.width = percent + '%'; }
    // Ensure the new completion container is visible and updated
    var compContainer = document.getElementById('completionContainer');
    if(compContainer){
      compContainer.style.display = 'flex';
    }
  }
  // Hook into safeUpdateAllPreviews to update completion after user input
  if(window.safeUpdateAllPreviews){
    var __origSafeUpdate = window.safeUpdateAllPreviews;
    window.safeUpdateAllPreviews = function(){ updateFormCompletion(); return __origSafeUpdate.apply(this, arguments); };
  }
  // Hook into showTool to update completion on tool switch
  if(window.showTool){
    var __origShowToolBadge = window.showTool;
    window.showTool = function(id, btn){ var r = __origShowToolBadge.apply(this, arguments); updateFormCompletion(); return r; };
  }
  // Hook into setToolView to update completion when switching between form & preview
  if(window.setToolView){
    var __origSetToolViewBadge = window.setToolView;
    window.setToolView = function(id, view){ var r = __origSetToolViewBadge.apply(this, arguments); updateFormCompletion(); return r; };
  }
  // Initialize on DOM ready and on window resize
  document.addEventListener('DOMContentLoaded', updateFormCompletion);
  window.addEventListener('resize', updateFormCompletion);

  // Update completion whenever the user inputs data into a form field. This ensures the
  // progress bar and percentage reflect the latest state in real time.
  document.addEventListener('input', function(e){
    // Only react to inputs inside visible tool content
    // Avoid heavy recalculation if user types quickly by leveraging requestAnimationFrame
    if(typeof window.requestAnimationFrame === 'function'){
      window.requestAnimationFrame(updateFormCompletion);
    } else {
      updateFormCompletion();
    }
  });
})();
</script>

